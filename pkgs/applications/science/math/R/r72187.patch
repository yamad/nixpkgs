diff -ubr R-3.3.2/SVN-REVISION R-patched/SVN-REVISION
--- R-3.3.2/SVN-REVISION	2016-10-31 01:01:36.000000000 -0700
+++ R-patched/SVN-REVISION	2017-02-15 15:16:50.000000000 -0800
@@ -1,2 +1,2 @@
-Revision: 71607
-Last Changed Date: 2016-10-31
+Revision: 72187
+Last Changed Date: 2017-02-15
diff -ubr R-3.3.2/VERSION R-patched/VERSION
--- R-3.3.2/VERSION	2016-10-31 01:00:04.000000000 -0700
+++ R-patched/VERSION	2016-10-31 01:13:20.000000000 -0700
@@ -1 +1 @@
-3.3.2
+3.3.2 Patched
diff -ubr R-3.3.2/configure R-patched/configure
--- R-3.3.2/configure	2016-10-24 04:34:26.000000000 -0700
+++ R-patched/configure	2017-01-05 15:16:36.000000000 -0800
@@ -35507,10 +35507,11 @@
 #include <string.h>
 #include <zlib.h>
 int main() {
-#ifdef ZLIB_VERSION
-/* Work around Debian bug: it uses 1.2.3.4 even though there was no such
-   version on the master site zlib.net */
-  exit(strncmp(ZLIB_VERSION, "1.2.5", 5) < 0);
+#ifdef ZLIB_VERNUM
+  if (ZLIB_VERNUM < 0x1250) {
+    exit(1);
+  }
+  exit(0);
 #else
   exit(1);
 #endif
diff -ubr R-3.3.2/doc/AUTHORS R-patched/doc/AUTHORS
--- R-3.3.2/doc/AUTHORS	2015-03-18 16:04:13.000000000 -0700
+++ R-patched/doc/AUTHORS	2016-12-21 15:15:06.000000000 -0800
@@ -9,10 +9,10 @@
 Douglas Bates
 John Chambers
 Peter Dalgaard
-Seth Falcon
 Robert Gentleman
 Kurt Hornik
 Ross Ihaka
+Tomas Kalibera
 Michael Lawrence
 Friedrich Leisch
 Uwe Ligges
@@ -28,8 +28,9 @@
 Luke Tierney
 Simon Urbanek
 
-plus Heiner Schwarte up to October 1999, Guido Masarotto up to June 2003 and
-Stefano Iacus up to July 2014.
+plus Heiner Schwarte up to October 1999, Guido Masarotto up to June 2003,
+Stefano Iacus up to July 2014 and Seth Falcon up to August 2015.
+
 
 Current R-core members can be contacted via email to R-project.org
 with name made up by replacing spaces by dots in the name listed above.
diff -ubr R-3.3.2/doc/COPYRIGHTS R-patched/doc/COPYRIGHTS
--- R-3.3.2/doc/COPYRIGHTS	2016-07-11 15:15:17.000000000 -0700
+++ R-patched/doc/COPYRIGHTS	2017-02-10 15:15:05.000000000 -0800
@@ -30,7 +30,7 @@
 This applies only to the header files
 
 src/include/R.h
-4src/include/Rdefines.h
+src/include/Rdefines.h
 src/include/Rgraphics.h
 src/include/Rinternals.h
 src/include/Rmath.h
@@ -286,23 +286,23 @@
 src/modules/lapack/dlapack.f, cmplx.f, dlamc.f
 
   Extracted from
-  *  -- LAPACK computational routine (version 3.6.0) --
+  *  -- LAPACK computational routine (version 3.6.1) --
   *  -- LAPACK is a software package provided by Univ. of Tennessee,    --
   *  -- Univ. of California Berkeley, Univ. of Colorado Denver and NAG Ltd..--
-  *     Novemeber 2015
+  *     June 2016
 
   where the version number, providers and date vary by subroutine.
 
-  LAPACK 3.6.0 contains a LICENSE file, copied to src/modules/lapack
+  LAPACK 3.6.1 contains a LICENSE file, copied to src/modules/lapack
   (but many of these routines were originally copied from earlier
   versions of LAPACK).  For binary distributions it is reproduced here:
 
-  Copyright (c) 1992-2015 The University of Tennessee and The University
+  Copyright (c) 1992-2016 The University of Tennessee and The University
                           of Tennessee Research Foundation.  All rights
                           reserved.
-  Copyright (c) 2000-2015 The University of California Berkeley. All
+  Copyright (c) 2000-2016 The University of California Berkeley. All
                           rights reserved.
-  Copyright (c) 2006-2015 The University of Colorado Denver.  All rights
+  Copyright (c) 2006-2016 The University of Colorado Denver.  All rights
                           reserved.
 
   $COPYRIGHT$
diff -ubr R-3.3.2/doc/NEWS R-patched/doc/NEWS
--- R-3.3.2/doc/NEWS	2016-10-31 01:06:47.000000000 -0700
+++ R-patched/doc/NEWS	2017-02-15 15:23:12.000000000 -0800
@@ -1,5 +1,97 @@
 R News
 
+CHANGES IN R 3.3.2 patched:
+
+  NEW FEATURES:
+
+    * Changes when redirection of a http:// URL to a https:// URL is
+      encountered:
+
+      The internal methods of download.file() and url() now report that
+      they cannot follow this (rather than failing silently).
+
+      (Unix-alike) download.file(method = "auto") (the default)
+      re-tries with method = "libcurl".
+
+      (Unix-alike) url(method = "default") with an explicit open
+      argument re-tries with method = "libcurl".  This covers many of
+      the usages, e.g. readLines() with a URL argument.
+
+  INSTALLATION on a UNIX-ALIKE:
+
+    * The configure check for the zlib version is now robust to
+      versions longer than 5 characters, including 1.2.10.
+
+  UTILITIES:
+
+    * Environmental variable _R_CHECK_TESTS_NLINES_ controls how R CMD
+      check reports failing tests (see SS8 of the 'R Internals' manual).
+
+  BUG FIXES:
+
+    * rep(x, times) and rep.int(x, times) now both work also when times
+      is larger than the maximal integer, including when it is of
+      length greater than one. (PR#16932)
+
+    * vapply(x, *) now works with long vectors x.  (PR#17174)
+
+    * isS3method("is.na.data.frame") and similar are correct now.
+      (PR#17171)
+
+    * grepRaw(<long>, <short>, fixed = TRUE) now works, thanks to a
+      patch by Mikko Korpela.  (PR#17132)
+
+    * Package installation into a library where the package exists via
+      symbolic link now should work wherever Sys.readlink() works,
+      resolving PR#16725.
+
+    * "Cincinnati" was missing an "n" in the precip dataset.
+
+    * Fix buffer overflow vulnerability in pdf() when loading an
+      encoding file.  Reported by Talos (TALOS-2016-0227).
+
+    * getDLLRegisteredRoutines() now produces its warning correctly
+      when multiple DLLs match, thanks to Matt Dowle's PR#17184.
+
+    * Sys.timezone() now returns non-NA also on platforms such as
+      Ubuntu 14.04.5 LTS, thanks to Mikko Korpela's PR#17186.
+
+    * format(x) for an illegal "POSIXlt" object x no longer segfaults.
+
+    * methods(f) now also works for f "(" or "{".
+
+    * (Windows only) dir.create() did not check the length of the path
+      to create, and so could overflow a buffer and crash R.
+      (PR#17206)
+
+    * On some systems, very small hexadecimal numbers in hex notation
+      would underflow to zero.  (PR#17199)
+
+    * pmin() and pmax() now work again for ordered factors and 0-length
+      S3 classed objects, thanks to Suharto Anggono's PR#17195 and
+      PR#17200.
+
+    * bug.report() did not do any validity checking on a package's
+      BugReports field.  It now ignores an empty field, removes leading
+      whitespace and only attempts to open http:// and https:// URLs,
+      falling back to emailing the maintainer.
+
+    * Bandwidth selectors bw.ucv() and bw.SJ() gave incorrect answers
+      or incorrectly reported an error (because of integer overflow)
+      for inputs longer than 46341.  Similarly for bw.bcv() at length
+      5793.
+
+      Another possible integer overflow is checked and may result in an
+      error report (rather than an incorrect result) for much longer
+      inputs (millions for a smooth distribution).
+
+    * findMethod failed if the active signature had expanded beyond
+      what a particular package used. (Example with packages XR and
+      XRJulia on CRAN).
+
+    * qbeta() underflowed too early in some very asymmetric cases.
+      (PR#17178)
+
 CHANGES IN R 3.3.2:
 
   NEW FEATURES:
diff -ubr R-3.3.2/doc/NEWS.Rd R-patched/doc/NEWS.Rd
--- R-3.3.2/doc/NEWS.Rd	2016-10-22 15:15:04.000000000 -0700
+++ R-patched/doc/NEWS.Rd	2017-02-14 15:15:25.000000000 -0800
@@ -5,6 +5,116 @@
 \title{R News}
 \encoding{UTF-8}
 
+\section{\Rlogo CHANGES IN R 3.3.2 patched}{
+  \subsection{NEW FEATURES}{
+    \itemize{
+      \item Changes when redirection of a \samp{http://} URL to a
+      \samp{https://} URL is encountered:
+      
+      The internal methods of \code{download.file()} and \code{url()}
+      now report that they cannot follow this (rather than failing
+      silently).
+
+      (Unix-alike) \code{download.file(method = "auto")} (the default)
+      re-tries with \code{method = "libcurl"}.
+
+      (Unix-alike) \code{url(method = "default")} with an explicit
+      \code{open} argument re-tries with \code{method = "libcurl"}.
+      This covers many of the usages, e.g.\sspace{}\code{readLines()}
+      with a URL argument.
+    }
+  }
+
+  \subsection{INSTALLATION on a UNIX-ALIKE}{
+    \itemize{
+      \item The \command{configure} check for the \code{zlib} version is
+      now robust to versions longer than 5 characters, including
+      \code{1.2.10}.
+    }
+  }
+
+  \subsection{UTILITIES}{
+    \itemize{
+      \item Environmental variable \env{_R_CHECK_TESTS_NLINES_} controls
+      how \command{R CMD check} reports failing tests (see ยง8 of the
+      \sQuote{R Internals} manual).
+    }
+  }
+
+  \subsection{BUG FIXES}{
+    \itemize{
+      \item \code{rep(x, times)} and \code{rep.int(x, times)} now both
+      work also when \code{times} is larger than the maximal integer,
+      including when it is of length greater than one. (\PR{16932})
+
+      \item \code{vapply(x, *)} now works with long vectors \code{x}.
+      (\PR{17174})
+
+      \item \code{isS3method("is.na.data.frame")} and similar are
+      correct now.  (\PR{17171})
+
+      \item \code{grepRaw(<long>, <short>, fixed = TRUE)} now works,
+      thanks to a patch by Mikko Korpela.  (\PR{17132})
+
+      \item Package installation into a library where the package exists
+      via symbolic link now should work wherever \code{\link{Sys.readlink}()}
+      works, resolving \PR{16725}.
+
+      \item \code{"Cincinnati"} was missing an \code{"n"} in the
+      \code{precip} dataset.
+
+      \item Fix buffer overflow vulnerability in \code{pdf()} when
+      loading an encoding file.  Reported by Talos (TALOS-2016-0227).
+
+      \item \code{getDLLRegisteredRoutines()} now produces its warning
+      correctly when multiple DLLs match, thanks to Matt Dowle's \PR{17184}.
+
+      \item \code{Sys.timezone()} now returns non-NA also on platforms
+      such as \samp{Ubuntu 14.04.5 LTS}, thanks to Mikko Korpela's
+      \PR{17186}.
+
+      \item \code{format(x)} for an illegal \code{"POSIXlt"} object
+      \code{x} no longer segfaults.
+
+      \item \code{methods(f)} now also works for \code{f} \code{"("}
+      or \code{"{"}.
+
+      \item (Windows only)  \code{dir.create()} did not check the length
+      of the path to create, and so could overflow a buffer and crash
+      \R.  (\PR{17206})
+
+      \item On some systems, very small hexadecimal numbers in hex notation
+      would underflow to zero.  (\PR{17199})
+
+      \item \code{pmin()} and \code{pmax()} now work again for
+      \code{ordered} factors and 0-length S3 classed objects, thanks to
+      Suharto Anggono's \PR{17195} and \PR{17200}.
+
+      \item \code{bug.report()} did not do any validity checking on a
+      package's \samp{BugReports} field.  It now ignores an empty field,
+      removes leading whitespace and only attempts to open
+      \samp{http://} and \samp{https://} URLs, falling back to emailing
+      the maintainer.
+
+      \item Bandwidth selectors \code{bw.ucv()} and
+      \code{bw.SJ()} gave incorrect answers or incorrectly reported an
+      error (because of integer overflow) for inputs longer than
+      46341.  Similarly for \code{bw.bcv()} at length 5793.
+
+      Another possible integer overflow is checked and may result in an
+      error report (rather than an incorrect result) for much longer
+      inputs (millions for a smooth distribution).
+
+      \item \code{findMethod} failed if the active signature had
+      expanded beyond what a particular package used. (Example with
+      packages \CRANpkg{XR} and \CRANpkg{XRJulia} on \acronym{CRAN}).
+
+      \item \code{qbeta()} underflowed too early in some very asymmetric
+      cases.  (\PR{17178})
+    }
+  }
+}
+
 \section{\Rlogo CHANGES IN R 3.3.2}{
   \subsection{NEW FEATURES}{
     \itemize{
Binary files R-3.3.2/doc/NEWS.pdf and R-patched/doc/NEWS.pdf differ
diff -ubr R-3.3.2/doc/Rscript.1 R-patched/doc/Rscript.1
--- R-3.3.2/doc/Rscript.1	2010-03-17 07:43:04.000000000 -0700
+++ R-patched/doc/Rscript.1	2016-12-06 15:15:04.000000000 -0800
@@ -8,7 +8,7 @@
 A binary front-end to R, for use in scripting applications.
 .TP
 \fBexpr\fR
-An optional expression to be evaluated, used in place of \fBexpr\fR.
+An optional expression to be evaluated, used in place of \fBfile\fR.
 .TP
 \fBfile\fR
 Input file of R expressions
diff -ubr R-3.3.2/doc/THANKS R-patched/doc/THANKS
--- R-3.3.2/doc/THANKS	2016-03-16 16:04:40.000000000 -0700
+++ R-patched/doc/THANKS	2016-12-21 15:15:06.000000000 -0800
@@ -1,5 +1,6 @@
 R would not be what it is today without the invaluable help of these
-people, who contributed by donating code, bug fixes and documentation:
+people outside of the R core team, who contributed by donating code, bug
+fixes and documentation:
 
 Valerio Aimale, Thomas Baier, Henrik Bengtsson, Roger Bivand,
 Ben Bolker, David Brahm, G"oran Brostr"om, Patrick Burns, Vince Carey,
@@ -60,8 +61,10 @@
 members of the R Foundation) when in the view of the R Foundation this
 would help advance the R project.
 
-The R Core Group, Roger Bivand, Dirk Eddelbuettel, John Fox, Torsten
-Hothorn, Stefano Iacus, Marc Schwartz, Bill Venables, Hadley Wickham
-and Achim Zeileis are the ordinary members of the R Foundation.  In
-addition, David Meyer and Simon Wood are also e-addressable by
+The R Core Group, Roger Bivand, Jennifer Bryan, Di Cook, Dirk Eddelbuettel,
+John Fox, Bettina Grรผn, Frank Harrell, Torsten Hothorn, Stefano Iacus,
+Julie Josse,  Balasubramanian Narasimhan, Marc Schwartz, Heather Turner,
+Bill Venables, Hadley Wickham and Achim Zeileis are the ordinary members of
+the R Foundation.
+In addition, David Meyer and Simon Wood are also e-addressable by
 <Firstname>.<Lastname>@R-project.org.
diff -ubr R-3.3.2/doc/html/NEWS.html R-patched/doc/html/NEWS.html
--- R-3.3.2/doc/html/NEWS.html	2016-10-31 01:06:47.000000000 -0700
+++ R-patched/doc/html/NEWS.html	2017-02-15 15:23:13.000000000 -0800
@@ -7,6 +7,155 @@
 
 <h2>R News</h2>
 
+<h3><img src="../help/figures/../../html/Rlogo.svg" class="toplogo" alt="[R logo]" /> CHANGES IN R 3.3.2 patched</h3>
+
+
+
+<h4>NEW FEATURES</h4>
+
+
+<ul>
+<li><p> Changes when redirection of a <span class="samp">http://</span> URL to a
+<span class="samp">https://</span> URL is encountered:
+</p>
+<p>The internal methods of <code>download.file()</code> and <code>url()</code>
+now report that they cannot follow this (rather than failing
+silently).
+</p>
+<p>(Unix-alike) <code>download.file(method = "auto")</code> (the default)
+re-tries with <code>method = "libcurl"</code>.
+</p>
+<p>(Unix-alike) <code>url(method = "default")</code> with an explicit
+<code>open</code> argument re-tries with <code>method = "libcurl"</code>.
+This covers many of the usages, e.g. <code>readLines()</code>
+with a URL argument.
+</p>
+</li></ul>
+
+
+
+
+<h4>INSTALLATION on a UNIX-ALIKE</h4>
+
+
+<ul>
+<li><p> The <code>configure</code> check for the <code>zlib</code> version is
+now robust to versions longer than 5 characters, including
+<code>1.2.10</code>.
+</p>
+</li></ul>
+
+
+
+
+<h4>UTILITIES</h4>
+
+
+<ul>
+<li><p> Environmental variable <span class="env">_R_CHECK_TESTS_NLINES_</span> controls
+how <code>R CMD check</code> reports failing tests (see ยง8 of the
+&lsquo;R Internals&rsquo; manual).
+</p>
+</li></ul>
+
+
+
+
+<h4>BUG FIXES</h4>
+
+
+<ul>
+<li> <p><code>rep(x, times)</code> and <code>rep.int(x, times)</code> now both
+work also when <code>times</code> is larger than the maximal integer,
+including when it is of length greater than one. (<a href="https://bugs.R-project.org/bugzilla3/show_bug.cgi?id=16932">PR#16932</a>)
+</p>
+</li>
+<li> <p><code>vapply(x, *)</code> now works with long vectors <code>x</code>.
+(<a href="https://bugs.R-project.org/bugzilla3/show_bug.cgi?id=17174">PR#17174</a>)
+</p>
+</li>
+<li> <p><code>isS3method("is.na.data.frame")</code> and similar are
+correct now.  (<a href="https://bugs.R-project.org/bugzilla3/show_bug.cgi?id=17171">PR#17171</a>)
+</p>
+</li>
+<li> <p><code>grepRaw(&lt;long&gt;, &lt;short&gt;, fixed = TRUE)</code> now works,
+thanks to a patch by Mikko Korpela.  (<a href="https://bugs.R-project.org/bugzilla3/show_bug.cgi?id=17132">PR#17132</a>)
+</p>
+</li>
+<li><p> Package installation into a library where the package exists
+via symbolic link now should work wherever <code>Sys.readlink()</code>
+works, resolving <a href="https://bugs.R-project.org/bugzilla3/show_bug.cgi?id=16725">PR#16725</a>.
+</p>
+</li>
+<li> <p><code>"Cincinnati"</code> was missing an <code>"n"</code> in the
+<code>precip</code> dataset.
+</p>
+</li>
+<li><p> Fix buffer overflow vulnerability in <code>pdf()</code> when
+loading an encoding file.  Reported by Talos (TALOS-2016-0227).
+</p>
+</li>
+<li> <p><code>getDLLRegisteredRoutines()</code> now produces its warning
+correctly when multiple DLLs match, thanks to Matt Dowle's <a href="https://bugs.R-project.org/bugzilla3/show_bug.cgi?id=17184">PR#17184</a>.
+</p>
+</li>
+<li> <p><code>Sys.timezone()</code> now returns non-NA also on platforms
+such as <span class="samp">Ubuntu 14.04.5 LTS</span>, thanks to Mikko Korpela's
+<a href="https://bugs.R-project.org/bugzilla3/show_bug.cgi?id=17186">PR#17186</a>.
+</p>
+</li>
+<li> <p><code>format(x)</code> for an illegal <code>"POSIXlt"</code> object
+<code>x</code> no longer segfaults.
+</p>
+</li>
+<li> <p><code>methods(f)</code> now also works for <code>f</code> <code>"("</code>
+or <code>"{"</code>.
+</p>
+</li>
+<li><p> (Windows only)  <code>dir.create()</code> did not check the length
+of the path to create, and so could overflow a buffer and crash
+<span style="font-family: Courier New, Courier; color: #666666;"><b>R</b></span>.  (<a href="https://bugs.R-project.org/bugzilla3/show_bug.cgi?id=17206">PR#17206</a>)
+</p>
+</li>
+<li><p> On some systems, very small hexadecimal numbers in hex notation
+would underflow to zero.  (<a href="https://bugs.R-project.org/bugzilla3/show_bug.cgi?id=17199">PR#17199</a>)
+</p>
+</li>
+<li> <p><code>pmin()</code> and <code>pmax()</code> now work again for
+<code>ordered</code> factors and 0-length S3 classed objects, thanks to
+Suharto Anggono's <a href="https://bugs.R-project.org/bugzilla3/show_bug.cgi?id=17195">PR#17195</a> and <a href="https://bugs.R-project.org/bugzilla3/show_bug.cgi?id=17200">PR#17200</a>.
+</p>
+</li>
+<li> <p><code>bug.report()</code> did not do any validity checking on a
+package's <span class="samp">BugReports</span> field.  It now ignores an empty field,
+removes leading whitespace and only attempts to open
+<span class="samp">http://</span> and <span class="samp">https://</span> URLs, falling back to emailing
+the maintainer.
+</p>
+</li>
+<li><p> Bandwidth selectors <code>bw.ucv()</code> and
+<code>bw.SJ()</code> gave incorrect answers or incorrectly reported an
+error (because of integer overflow) for inputs longer than
+46341.  Similarly for <code>bw.bcv()</code> at length 5793.
+</p>
+<p>Another possible integer overflow is checked and may result in an
+error report (rather than an incorrect result) for much longer
+inputs (millions for a smooth distribution).
+</p>
+</li>
+<li> <p><code>findMethod</code> failed if the active signature had
+expanded beyond what a particular package used. (Example with
+packages <a href="https://CRAN.R-project.org/package=XR"><span class="pkg">XR</span></a> and <a href="https://CRAN.R-project.org/package=XRJulia"><span class="pkg">XRJulia</span></a> on <acronym><span class="acronym">CRAN</span></acronym>).
+</p>
+</li>
+<li> <p><code>qbeta()</code> underflowed too early in some very asymmetric
+cases.  (<a href="https://bugs.R-project.org/bugzilla3/show_bug.cgi?id=17178">PR#17178</a>)
+</p>
+</li></ul>
+
+
+
+
 <h3><img src="../help/figures/../../html/Rlogo.svg" class="toplogo" alt="[R logo]" /> CHANGES IN R 3.3.2</h3>
 
 
diff -ubr R-3.3.2/doc/html/R-admin.html R-patched/doc/html/R-admin.html
--- R-3.3.2/doc/html/R-admin.html	2016-10-31 01:12:18.000000000 -0700
+++ R-patched/doc/html/R-admin.html	2017-02-15 15:29:59.000000000 -0800
@@ -1,6 +1,6 @@
 <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
 <html>
-<!-- This manual is for R, version 3.3.2 (2016-10-31).
+<!-- This manual is for R, version 3.3.2 Patched (2017-02-15).
 
 Copyright (C) 2001-2016 R Core Team
 
@@ -333,7 +333,7 @@
 
 <p>This is a guide to installation and administration for R.
 </p>
-<p>This manual is for R, version 3.3.2 (2016-10-31).
+<p>This manual is for R, version 3.3.2 Patched (2017-02-15).
 </p>
 <p>Copyright &copy; 2001&ndash;2016 R Core Team
 </p>
@@ -825,7 +825,7 @@
 
 <p>This requires <code>ebook-convert</code> from <code>Calibre</code>
 (<a href="http://calibre-ebook.com/download">http://calibre-ebook.com/download</a>), or from most Linux
-distributions).  If necessary the path to <code>ebook-convert</code> can be
+distributions.  If necessary the path to <code>ebook-convert</code> can be
 set as make macro <code>EBOOK</code> to by editing <samp>doc/manual/Makefile</samp>
 (which contains a commented value suitable for macOS).
 </p>
@@ -1376,7 +1376,7 @@
 <em>must</em> be installed in a path that does not contain spaces.
 </p>
 <p>Installation is <em>via</em> the installer
-<samp>R-3.3.2-win.exe</samp>.  Just double-click on the icon and
+<samp>R-3.3.2patched-win.exe</samp>.  Just double-click on the icon and
 follow the instructions.  When installing on a 64-bit version of Windows
 the options will include 32- or 64-bit versions of R (and the default is
 to install both).  You can uninstall R from the Control Panel.
@@ -1772,7 +1772,7 @@
 installation (in double quotes if it contains spaces or backslashes).
 </p>
 <p>Both methods create an executable with a standard name such as
-<samp>R-3.3.2-win.exe</samp>, so please rename it to indicate that
+<samp>R-3.3.2patched-win.exe</samp>, so please rename it to indicate that
 it is customized.  If you intend to <em>distribute</em> a customized
 installer please do check that license requirements are met &ndash; note that
 the installer will state that the contents are distributed under GPL
@@ -1831,21 +1831,21 @@
 </pre></div>
 
 <p>which will result in a file with a name like
-<samp>R-3.3.2-win32.msi</samp>.  This can be double-clicked to be
+<samp>R-3.3.2patched-win32.msi</samp>.  This can be double-clicked to be
 installed, but those who need it will know what to do with it (usually
 by running <code>msiexec /i</code> with additional options).  Properties
 that users might want to set from the <code>msiexec</code> command line
 include &lsquo;<samp>ALLUSERS</samp>&rsquo;, &lsquo;<samp>INSTALLDIR</samp>&rsquo; (something like
-<samp>c:\Program Files\R\R-3.3.2</samp>) and &lsquo;<samp>RMENU</samp>&rsquo; (the path
+<samp>c:\Program Files\R\R-3.3.2patched</samp>) and &lsquo;<samp>RMENU</samp>&rsquo; (the path
 to the &lsquo;<samp>R</samp>&rsquo; folder on the start menu) and &lsquo;<samp>STARTDIR</samp>&rsquo; (the
 starting directory for R shortcuts, defaulting to something like
 <samp>c:\Users\name\Documents\R</samp>).
 </p>
 <p>The MSI installer can be built both from a 32-bit build of R
-(<samp>R-3.3.2-win32.msi</samp>) and from a 64-bit build of R
-(<samp>R-3.3.2-win64.msi</samp>, optionally including 32-bit files
+(<samp>R-3.3.2patched-win32.msi</samp>) and from a 64-bit build of R
+(<samp>R-3.3.2patched-win64.msi</samp>, optionally including 32-bit files
 by setting the macro <code>HOME32</code>, when the name is
-<samp>R-3.3.2-win.msi</samp>).  Unlike the main installer, a 64-bit
+<samp>R-3.3.2patched-win.msi</samp>).  Unlike the main installer, a 64-bit
 MSI installer can only be run on 64-bit Windows.
 </p>
 <p>Thanks to David del Campo (Dept of Statistics, University of Oxford)
@@ -3107,7 +3107,7 @@
 distributions.)
 </p>
 <p>Even on 64-bit builds of R there are limits on the size of R
-objects (see <code>help(&quot;Memory-limits&quot;)</code>, some of which stem from the
+objects (see <code>help(&quot;Memory-limits&quot;)</code>), some of which stem from the
 use of 32-bit integers (especially in FORTRAN code).  For example, the
 dimensions of an array are limited to <em>2^{31} - 1</em>.
 </p>
@@ -4264,12 +4264,14 @@
 the C/C++ preprocessors), respectively, to specify these locations.
 These default to &lsquo;<samp>-L/usr/local/lib</samp>&rsquo; (<code>LDFLAGS</code>,
 &lsquo;<samp>-L/usr/local/lib64</samp>&rsquo; on most 64-bit Linux OSes) and
-&lsquo;<samp>-I/usr/local/include</samp>&rsquo; (<code>CPPFLAGS</code>) to catch the most common
-cases.  If libraries are still not found, then maybe your
+&lsquo;<samp>-I/usr/local/include</samp>&rsquo; (<code>CPPFLAGS</code>, but note that on most
+systems <samp>/usr/local/include</samp> is regarded as a system include
+directory and so instances in that macro will be skipped) to catch the
+most common cases.  If libraries are still not found, then maybe your
 compiler/linker does not support re-ordering of <samp>-L</samp> and
-<samp>-l</samp> flags (this has been reported to be a problem on HP-UX with
-the native <code>cc</code>).  In this case, use a different compiler (or a
-front end shell script which does the re-ordering).
+<samp>-l</samp> flags (years ago this was reported to be a problem on HP-UX
+with the native <code>cc</code>).  In this case, use a different compiler
+(or a front-end shell script which does the re-ordering).
 </p>
 <p>These flags can also be used to build a faster-running version of R.
 On most platforms using <code>gcc</code>, having &lsquo;<samp>-O3</samp>&rsquo; in
@@ -4641,7 +4643,7 @@
 designed for use in terminals).  In such locales <em>fontsets</em> are
 used, made up of fonts encoded in other encodings.  If the locale you
 are using has an entry in the &lsquo;<samp>XLC_LOCALE</samp>&rsquo; directory (typically
-<samp>/usr/share/X11/locale</samp>, it is likely that all you need to do is to
+<samp>/usr/share/X11/locale</samp>), it is likely that all you need to do is to
 pick a suitable font specification that has fonts in the encodings
 specified there.  If not, you may have to get hold of a suitable locale
 entry for X11.  This may mean that, for example, Japanese text can be
@@ -4673,7 +4675,8 @@
 <a name="index-Linux-1"></a>
 
 <p>Linux is the main development platform for R, so compilation from the
-sources is normally straightforward with the standard compilers.
+sources is normally straightforward with the standard compilers and
+libraries.<a name="DOCF59" href="#FOOT59"><sup>59</sup></a>
 </p>
 <p>Remember that some package management systems (such as <acronym>RPM</acronym> and
 deb) make a distinction between the user version of a package and the
@@ -4714,7 +4717,7 @@
 the best possible performance on the machine on which R is being
 installed: if the compilation is for a site-wide installation, it may
 still be desirable to use something like
-<samp>-mtume=core2</samp>.<a name="DOCF59" href="#FOOT59"><sup>59</sup></a> It is also possible to increase the
+<samp>-mtume=core2</samp>.<a name="DOCF60" href="#FOOT60"><sup>60</sup></a> It is also possible to increase the
 optimization levels to <samp>-O3</samp>: however for many versions of the
 compilers this has caused problems in at least one <acronym>CRAN</acronym>
 package.
@@ -4727,7 +4730,7 @@
 
 <p>is appropriate since most (but not all) software installs its 64-bit
 libraries in <samp>/usr/local/lib64</samp>.  To build a 32-bit version of R
-on &lsquo;<samp>x86_64</samp>&rsquo; with Fedora 21 we used
+on &lsquo;<samp>x86_64</samp>&rsquo; with Fedora 24 we used
 </p>
 <div class="example">
 <pre class="example">CC=&quot;gcc -m32&quot;
@@ -4790,7 +4793,7 @@
 R packages only the variant using <code>libcxxabi</code> was successful.
 </p>
 <p>Most builds of <code>clang</code> have no OpenMP support.  Builds of
-versions 3.7.0 or later may.<a name="DOCF60" href="#FOOT60"><sup>60</sup></a>
+versions 3.7.0 or later may.<a name="DOCF61" href="#FOOT61"><sup>61</sup></a>
 </p>
 <hr>
 <a name="Intel-compilers"></a>
@@ -4829,7 +4832,6 @@
 source</samp>, depending on the compiler version.
 </p>
 <p>Others have reported success with versions 10.x and 11.x.  
-% https://stat.ethz.ch/pipermail/r-devel/2015-September/071717.html
 Bjรธrn-Helge Mevik reported success with version 2015.3 of the compilers,
 using (for a SandyBridge CPU on Centos 6.x)
 </p>
@@ -4854,7 +4856,7 @@
 <p>(&lsquo;macOS&rsquo; was known as &lsquo;OS X&rsquo; from 2012&ndash;2016.)
 </p>
 <p>The instructions here are for &lsquo;<samp>x86_64</samp>&rsquo; builds on 10.9
-(Mavericks) or later.  In principle<a name="DOCF61" href="#FOOT61"><sup>61</sup></a> R can be
+(Mavericks) or later.  In principle<a name="DOCF62" href="#FOOT62"><sup>62</sup></a> R can be
 built for 10.6 to 10.8 but these have not been tested recently.
 </p>
 <p>To build R you need Apple&rsquo;s &lsquo;Command Line Tools&rsquo;: these can be
@@ -4864,7 +4866,7 @@
 Xcode, this provides the command-line tools.  The tools will need to be
 reinstalled when macOS is upgraded, as upgrading partially removes them.)
 </p>
-<p>You need GNU <code>readline</code><a name="DOCF62" href="#FOOT62"><sup>62</sup></a> and a Fortran
+<p>You need GNU <code>readline</code><a name="DOCF63" href="#FOOT63"><sup>63</sup></a> and a Fortran
 compiler.  Those and other binary components are available from
 <a href="https://r.research.att.com/libs">https://r.research.att.com/libs</a>: you will need <code>pcre</code> and
 <code>xz</code> (for <code>libzma</code>) as recent macOS versions provide libraries
@@ -4879,7 +4881,7 @@
 becomes the default device when running R at the console and X11
 would only be used for the command-line-R data editor/viewer and one
 version of Tcl/Tk.  (This option needs an Objective-C
-compiler<a name="DOCF63" href="#FOOT63"><sup>63</sup></a> which can
+compiler<a name="DOCF64" href="#FOOT64"><sup>64</sup></a> which can
 compile the source code of <code>quartz()</code>.)
 </p>
 <p>Use <samp>--without-aqua</samp> if you want a standard Unix-alike build:
@@ -4905,7 +4907,7 @@
 
 <p>with <code>clang</code> and <code>clang++</code> from the &lsquo;Command Line Tools&rsquo;
 and the Fortran compiler from
-<a href="https://r.research.att.com/libs/gfortran-4.8.2-darwin13.tar.bz2">https://r.research.att.com/libs/gfortran-4.8.2-darwin13.tar.bz2</a>.<a name="DOCF64" href="#FOOT64"><sup>64</sup></a>
+<a href="https://r.research.att.com/libs/gfortran-4.8.2-darwin13.tar.bz2">https://r.research.att.com/libs/gfortran-4.8.2-darwin13.tar.bz2</a>.<a name="DOCF65" href="#FOOT65"><sup>65</sup></a>
 </p>
 <p>Other builds of <code>gfortran</code> are available: see
 <a href="https://gcc.gnu.org/wiki/GFortranBinaries">https://gcc.gnu.org/wiki/GFortranBinaries</a> and
@@ -4913,11 +4915,10 @@
 binary distribution of R you will probably need to specify the name
 or path in a personal or site <samp>Makevars</samp> file (see <a href="#Customizing-package-compilation">Customizing package compilation</a>).
 </p>
-<p>More recent and complete distributions of <code>clang</code> are usually
-available from <a href="http://llvm.org/releases/">http://llvm.org/releases/</a>.  In particular, these
-include support for the &lsquo;Address Sanitizer&rsquo; (not included by Apple until
-Xcode 7) and for OpenMP<a name="DOCF65" href="#FOOT65"><sup>65</sup></a> in version
-3.7.0 and later.
+<p>More recent and complete distributions of <code>clang</code> are often
+available from <a href="http://llvm.org/releases/">http://llvm.org/releases/</a>: for example at the time
+of writing for 3.9.0 but not 3.9.1.  In particular, these may include
+support for OpenMP.
 </p>
 <p>Pre-compiled versions of many of the <a href="#Useful-libraries-and-programs">Useful libraries and programs</a>
 are available from <a href="https://r.research.att.com/libs/">https://r.research.att.com/libs/</a>.  You will
@@ -5005,16 +5006,24 @@
 
 <p>although linked versions under <samp>/usr/X11</samp> will be found.
 </p>
-<p>The Fortran compiler for El Capitan from (at the time of writing)
-<a href="http://coudert.name/software/gfortran-6.1-ElCapitan.dmg">http://coudert.name/software/gfortran-6.1-ElCapitan.dmg</a> works on
-Sierra: those at <a href="https://r.research.att.com/">https://r.research.att.com/</a> have failure
-reports.  One way to use the Coudert build is to have a
-<samp>~/.R/Makevars</samp> file similar to
+<p>There are installers<a name="DOCF68" href="#FOOT68"><sup>68</sup></a> for Fortran compilers for El Capiton and Sierra at
+<a href="http://coudert.name/software/gfortran-6.1-ElCapitan.dmg">http://coudert.name/software/gfortran-6.1-ElCapitan.dmg</a> and
+<a href="http://coudert.name/software/gfortran-6.3-Sierra.dmg">http://coudert.name/software/gfortran-6.3-Sierra.dmg</a>: those
+at <a href="https://r.research.att.com/">https://r.research.att.com/</a> have failure reports on Sierra.
+One way to use the Coudert build with a binary distribution of R is
+to have a <samp>~/.R/Makevars</samp> file similar to (El Capitan)
 </p><div class="smallexample">
 <pre class="smallexample">F77 = /usr/local/gfortran/bin/gfortran
 FC = /usr/local/gfortran/bin/gfortran
 FLIBS = -L/usr/local/gfortran/lib/gcc/x86_64-apple-darwin15/6.1.0 -L/usr/local/gfortran/lib -lgfortran -lquadmath -lm
 </pre></div>
+<p>or (Sierra)
+</p><div class="smallexample">
+<pre class="smallexample">F77 = /usr/local/gfortran/bin/gfortran
+FC = /usr/local/gfortran/bin/gfortran
+FLIBS = -L/usr/local/gfortran/lib/gcc/x86_64-apple-darwin16/6.3.0 -L/usr/local/gfortran/lib -lgfortran -lquadmath -lm
+</pre></div>
+
 
 <hr>
 <a name="Tcl_002fTk-headers-and-libraries"></a>
@@ -5066,7 +5075,7 @@
 <a name="Java"></a>
 <h4 class="subsection">C.3.3 Java</h4>
 
-<p>The situation with Java support on macOS is messy.<a name="DOCF68" href="#FOOT68"><sup>68</sup></a>
+<p>The situation with Java support on macOS is messy.<a name="DOCF69" href="#FOOT69"><sup>69</sup></a>
 </p>
 <p>macOS no longer comes with an installed Java runtime (JRE), and a macOS
 upgrade may remove one if already installed: it is intended to be
@@ -5076,7 +5085,7 @@
 directly the latest Java from Oracle (currently from
 <a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">http://www.oracle.com/technetwork/java/javase/downloads/index.html</a>).
 </p>
-<p>You may need to install what Apple calls &lsquo;legacy Java&rsquo;<a name="DOCF69" href="#FOOT69"><sup>69</sup></a> to suppress pop-up messages
+<p>You may need to install what Apple calls &lsquo;legacy Java&rsquo;<a name="DOCF70" href="#FOOT70"><sup>70</sup></a> to suppress pop-up messages
 even if you have a current version installed.
 </p>
 <p>To see what compatible versions of Java are currently installed, run
@@ -5182,11 +5191,11 @@
 
 <p>R has been built successfully on Solaris 10 (both Sparc and
 &lsquo;<samp>x86</samp>&rsquo;) using the (zero cost) Oracle Developer
-Studio<a name="DOCF70" href="#FOOT70"><sup>70</sup></a> compilers: there has been some success with
+Studio<a name="DOCF71" href="#FOOT71"><sup>71</sup></a> compilers: there has been some success with
 <code>gcc</code>/<code>gfortran</code>.  (Recent Sun machines are AMD Opterons
 or Intel Xeons (&lsquo;<samp>amd64</samp>&rsquo;) rather than &lsquo;<samp>x86</samp>&rsquo;, but 32-bit
 &lsquo;<samp>x86</samp>&rsquo; executables are the default.)  How these compilers
-identify<a name="DOCF71" href="#FOOT71"><sup>71</sup></a> themselves is slightly
+identify<a name="DOCF72" href="#FOOT72"><sup>72</sup></a> themselves is slightly
 confusing: Solaris Studio versions 12.3 and 12.4 report C++ 5.12
 and 5.13, and Developer Studio 12.5 reports C++ 5.14.  We will only consider
 12.3 (Nov 2011) and later.
@@ -5206,6 +5215,11 @@
 <samp>/opt/csw</samp>.  Solaris 10 ships with <code>bzlib</code> version 1.0.6
 (sufficient) but <code>zlib</code> version 1.2.3 (too old): OpenCSW has 1.2.8.
 </p>
+<p>The Oracle compilers are unusual in not including
+<samp>/usr/local/include</samp> in the default include search path: R&rsquo;s
+default <code>CPPFLAGS=-I/usr/local/include</code> remedies this.  If you rely
+on OpenCSW software you may need <code>CPPFLAGS=-I/opt/csw/include</code>
+</p>
 <p>You will need <acronym>GNU</acronym> <code>libiconv</code> and <code>readline</code>: the
 Solaris version of <code>iconv</code> is not sufficiently powerful.
 </p>
@@ -5367,7 +5381,7 @@
 </pre></div>
 
 <p>This has often given test failures in the past, in several different
-places.<a name="DOCF72" href="#FOOT72"><sup>72</sup></a>
+places.<a name="DOCF73" href="#FOOT73"><sup>73</sup></a>
 </p>
 <p>Parsing very complex R expressions needs a lot of stack space when
 the Oracle compilers are used: several packages require the stack
@@ -5396,7 +5410,10 @@
 version of Solaris in use.  (This can be ascertained from <code>gcc
 -v</code>.)  <code>gcc</code> makes modified versions of some header files, and
 several reports of problems were due to using <code>gcc</code> compiled on
-one version of Solaris on a later version.  
+one version of Solaris on a later version.  Note that this can even
+apply to OS patches: some 2016 patches to Solaris 10 changed its C
+header files in way incompatible<a name="DOCF74" href="#FOOT74"><sup>74</sup></a>  with the modified versions included with OpenCSW&rsquo;s
+binary distribution.
 </p>
 <p>The notes here are for <code>gcc</code> set up to use the Solaris linker:
 it can also be set up to use GNU <code>ld</code>, but that has not been
@@ -5728,7 +5745,7 @@
 </p>
 <p>We have found that the build process for R is quite sensitive to
 the choice of tools: please follow our instructions <strong>exactly</strong>,
-even to the choice of particular versions of the tools.<a name="DOCF73" href="#FOOT73"><sup>73</sup></a>  The build process for add-on packages is somewhat more
+even to the choice of particular versions of the tools.<a name="DOCF75" href="#FOOT75"><sup>75</sup></a>  The build process for add-on packages is somewhat more
 forgiving, but we recommend using the exact toolset at first, and only
 substituting other tools once you are familiar with the process.
 </p>
@@ -5781,7 +5798,7 @@
 
 <p>It is essential that the directory containing the command line tools
 comes first or second in the path: there are typically like-named
-tools<a name="DOCF74" href="#FOOT74"><sup>74</sup></a> in other directories, and they will <strong>not</strong>
+tools<a name="DOCF76" href="#FOOT76"><sup>76</sup></a> in other directories, and they will <strong>not</strong>
 work. The ordering of the other directories is less important, but if in
 doubt, use the order above.
 </p>
@@ -5830,7 +5847,7 @@
 <a name="The-Inno-Setup-installer-1"></a>
 <h3 class="section">D.2 The Inno Setup installer</h3>
 
-<p>To make the installer package (<samp>R-3.3.2-win.exe</samp>) we
+<p>To make the installer package (<samp>R-3.3.2patched-win.exe</samp>) we
 currently require the Unicode version of Inno Setup 5.3.7 or later from
 <a href="http://jrsoftware.org/">http://jrsoftware.org/</a>. This is <em>not</em> included in
 <samp>Rtools*.exe</samp>.
@@ -6471,33 +6488,33 @@
 <p>for example, <code>X11 font at size 14 could not
 be loaded</code>.</p>
 <h3><a name="FOOT59" href="#DOCF59">(59)</a></h3>
+<p>For example, <code>glibc</code>: other C libraries such as
+<code>musl</code> have been used but are not routinely tested.</p>
+<h3><a name="FOOT60" href="#DOCF60">(60)</a></h3>
 <p>or <code>-mtune=corei7</code> for Intel Core
 i3/15/17 with <code>gcc &gt;= 4.6.0</code>.</p>
-<h3><a name="FOOT60" href="#DOCF60">(60)</a></h3>
+<h3><a name="FOOT61" href="#DOCF61">(61)</a></h3>
 <p>This also needs the OpenMP
 runtime which has sometimes been distributed separately, e.g. for
 3.7.0 at <a href="http://llvm.org/releases">http://llvm.org/releases</a>.</p>
-<h3><a name="FOOT61" href="#DOCF61">(61)</a></h3>
+<h3><a name="FOOT62" href="#DOCF62">(62)</a></h3>
 <p>It will be necessary to
 install later versions of software such as <code>libcurl</code>.</p>
-<h3><a name="FOOT62" href="#DOCF62">(62)</a></h3>
+<h3><a name="FOOT63" href="#DOCF63">(63)</a></h3>
 <p>Apple provides a partial emulation
 of GNU readline 4.2 based on the NetBSD <code>editline</code> library.  That
 is not recommended but for the time being R&rsquo;s installation scripts
 will make use of it if GNU readline is not found.</p>
-<h3><a name="FOOT63" href="#DOCF63">(63)</a></h3>
+<h3><a name="FOOT64" href="#DOCF64">(64)</a></h3>
 <p>These days that is defined by Apple&rsquo;s implementation
 of <code>clang</code>, so it is strongly recommended to use that.</p>
-<h3><a name="FOOT64" href="#DOCF64">(64)</a></h3>
+<h3><a name="FOOT65" href="#DOCF65">(65)</a></h3>
 <p>This
 is a tarball which needs to be unpacked in the Terminal by e.g.
 <code>sudo tar -zxf gfortran-4.8.2-darwin13.tar.bz2 -C /</code>. It does
 not run on Core 2 Duo Macs, and linking failures on macOS Sierra have
 been reported.  On other Sierra machines the reported examples work,
 albeit with many warnings.</p>
-<h3><a name="FOOT65" href="#DOCF65">(65)</a></h3>
-<p>This also needs the OpenMP runtime,
-which was distributed separately at that site for 3.7.0.</p>
 <h3><a name="FOOT66" href="#DOCF66">(66)</a></h3>
 <p>It is reported that for some non-Apple
 toolchains <code>CPPFLAGS</code> needed to contain <code>-D__ACCELERATE__</code>.</p>
@@ -6505,26 +6522,35 @@
 <p>E.g. <em>via</em> <code>tlmgr install cm-super helvetic
 inconsolata texinfo</code> .</p>
 <h3><a name="FOOT68" href="#DOCF68">(68)</a></h3>
+<p>Some of these are unsigned packages: to
+install them you may need to right-click and select <code>Open with -&gt;
+Installer</code>.</p>
+<h3><a name="FOOT69" href="#DOCF69">(69)</a></h3>
 <p>For more
 details see <a href="http://www.macstrategy.com/article.php?3">http://www.macstrategy.com/article.php?3</a>.</p>
-<h3><a name="FOOT69" href="#DOCF69">(69)</a></h3>
+<h3><a name="FOOT70" href="#DOCF70">(70)</a></h3>
 <p>e.g.
 <code>Java For OS X 2015-001</code> from
 <a href="https://support.apple.com/kb/DL1572">https://support.apple.com/kb/DL1572</a>.</p>
-<h3><a name="FOOT70" href="#DOCF70">(70)</a></h3>
+<h3><a name="FOOT71" href="#DOCF71">(71)</a></h3>
 <p>Oracle Solaris Studio prior to 2016, and previously Sun
 Studio.</p>
-<h3><a name="FOOT71" href="#DOCF71">(71)</a></h3>
-<p>using the <samp>-V</samp> flag.</p>
 <h3><a name="FOOT72" href="#DOCF72">(72)</a></h3>
+<p>using the <samp>-V</samp> flag.</p>
+<h3><a name="FOOT73" href="#DOCF73">(73)</a></h3>
 <p>When last checked it failed in <samp>tests/reg-BLAS.R</samp>,
 and on some builds, including for &lsquo;<samp>amd64</samp>&rsquo;, it failed in
 <code>example(eigen)</code>.</p>
-<h3><a name="FOOT73" href="#DOCF73">(73)</a></h3>
+<h3><a name="FOOT74" href="#DOCF74">(74)</a></h3>
+<p>In particular, header
+<samp>cmath</samp> in C++11 mode includes <samp>math.h</samp> and
+<samp>iso/math_c99.h</samp> and <code>gcc</code> had &lsquo;fixed&rsquo; an earlier version
+of the latter.</p>
+<h3><a name="FOOT75" href="#DOCF75">(75)</a></h3>
 <p>For
 example, the Cygwin version of <code>make 3.81</code> fails to work
 correctly.</p>
-<h3><a name="FOOT74" href="#DOCF74">(74)</a></h3>
+<h3><a name="FOOT76" href="#DOCF76">(76)</a></h3>
 <p>such as <code>sort</code>, <code>find</code> and perhaps
 <code>make</code>.</p>
 </div>
diff -ubr R-3.3.2/doc/manual/R-admin.texi R-patched/doc/manual/R-admin.texi
--- R-3.3.2/doc/manual/R-admin.texi	2016-10-04 02:15:05.000000000 -0700
+++ R-patched/doc/manual/R-admin.texi	2017-02-06 15:15:04.000000000 -0800
@@ -571,7 +571,7 @@
 @noindent
 This requires @command{ebook-convert} from @command{Calibre}
 (@uref{http://calibre-ebook.com/download}), or from most Linux
-distributions).  If necessary the path to @command{ebook-convert} can be
+distributions.  If necessary the path to @command{ebook-convert} can be
 set as make macro @env{EBOOK} to by editing @file{doc/manual/Makefile}
 (which contains a commented value suitable for macOS).
 
@@ -2956,7 +2956,7 @@
 distributions.)
 
 Even on 64-bit builds of @R{} there are limits on the size of @R{}
-objects (see @code{help("Memory-limits")}, some of which stem from the
+objects (see @code{help("Memory-limits")}), some of which stem from the
 use of 32-bit integers (especially in FORTRAN code).  For example, the
 dimensions of an array are limited to @math{2^{31} - 1}.
 
@@ -4181,12 +4181,14 @@
 the C/C++ preprocessors), respectively, to specify these locations.
 These default to @samp{-L/usr/local/lib} (@code{LDFLAGS},
 @samp{-L/usr/local/lib64} on most 64-bit Linux OSes) and
-@samp{-I/usr/local/include} (@code{CPPFLAGS}) to catch the most common
-cases.  If libraries are still not found, then maybe your
+@samp{-I/usr/local/include} (@code{CPPFLAGS}, but note that on most
+systems @file{/usr/local/include} is regarded as a system include
+directory and so instances in that macro will be skipped) to catch the
+most common cases.  If libraries are still not found, then maybe your
 compiler/linker does not support re-ordering of @option{-L} and
-@option{-l} flags (this has been reported to be a problem on HP-UX with
-the native @command{cc}).  In this case, use a different compiler (or a
-front end shell script which does the re-ordering).
+@option{-l} flags (years ago this was reported to be a problem on HP-UX
+with the native @command{cc}).  In this case, use a different compiler
+(or a front-end shell script which does the re-ordering).
 
 These flags can also be used to build a faster-running version of @R{}.
 On most platforms using @command{gcc}, having @samp{-O3} in
@@ -4547,7 +4549,7 @@
 designed for use in terminals).  In such locales @emph{fontsets} are
 used, made up of fonts encoded in other encodings.  If the locale you
 are using has an entry in the @samp{XLC_LOCALE} directory (typically
-@file{/usr/share/X11/locale}, it is likely that all you need to do is to
+@file{/usr/share/X11/locale}), it is likely that all you need to do is to
 pick a suitable font specification that has fonts in the encodings
 specified there.  If not, you may have to get hold of a suitable locale
 entry for X11.  This may mean that, for example, Japanese text can be
@@ -4577,7 +4579,9 @@
 @cindex Linux
 
 Linux is the main development platform for @R{}, so compilation from the
-sources is normally straightforward with the standard compilers.
+sources is normally straightforward with the standard compilers and
+libraries.@footnote{For example, @code{glibc}: other C libraries such as
+@code{musl} have been used but are not routinely tested.}
 
 Remember that some package management systems (such as @acronym{RPM} and
 deb) make a distinction between the user version of a package and the
@@ -4633,7 +4637,7 @@
 @noindent
 is appropriate since most (but not all) software installs its 64-bit
 libraries in @file{/usr/local/lib64}.  To build a 32-bit version of @R{}
-on @cputype{x86_64} with Fedora 21 we used
+on @cputype{x86_64} with Fedora 24 we used
 
 @example
 CC="gcc -m32"
@@ -4740,7 +4744,7 @@
 source}, depending on the compiler version.
 
 Others have reported success with versions 10.x and 11.x.  
-% https://stat.ethz.ch/pipermail/r-devel/2015-September/071717.html
+@c https://stat.ethz.ch/pipermail/r-devel/2015-September/071717.html
 Bjรธrn-Helge Mevik reported success with version 2015.3 of the compilers,
 using (for a SandyBridge CPU on Centos 6.x)
 
@@ -4834,12 +4838,10 @@
 or path in a personal or site @file{Makevars} file (@pxref{Customizing
 package compilation}).
 
-More recent and complete distributions of @command{clang} are usually
-available from @uref{http://llvm.org/releases/}.  In particular, these
-include support for the `Address Sanitizer' (not included by Apple until
-Xcode 7) and for OpenMP@footnote{This also needs the OpenMP runtime,
-which was distributed separately at that site for 3.7.0.} in version
-3.7.0 and later.
+More recent and complete distributions of @command{clang} are often
+available from @uref{http://llvm.org/releases/}: for example at the time
+of writing for 3.9.0 but not 3.9.1.  In particular, these may include
+support for OpenMP.
 
 Pre-compiled versions of many of the @ref{Useful libraries and programs}
 are available from @uref{https://r.research.att.com/libs/}.  You will
@@ -4938,16 +4940,26 @@
 @noindent
 although linked versions under @file{/usr/X11} will be found.
 
-The Fortran compiler for El Capitan from (at the time of writing)
-@uref{http://coudert.name/@/software/@/gfortran-6.1-ElCapitan.dmg} works on
-Sierra: those at @uref{https://r.research.att.com/} have failure
-reports.  One way to use the Coudert build is to have a
-@file{~/.R/Makevars} file similar to
+There are installers@footnote{Some of these are unsigned packages: to
+install them you may need to right-click and select @code{Open with ->
+Installer}.} for Fortran compilers for El Capiton and Sierra at
+@uref{http://coudert.name/@/software/@/gfortran-6.1-ElCapitan.dmg} and
+@uref{http://coudert.name/@/software/@/gfortran-6.3-Sierra.dmg}: those
+at @uref{https://r.research.att.com/} have failure reports on Sierra.
+One way to use the Coudert build with a binary distribution of @R{} is
+to have a @file{~/.R/Makevars} file similar to (El Capitan)
 @smallexample
 F77 = /usr/local/gfortran/bin/gfortran
 FC = /usr/local/gfortran/bin/gfortran
 FLIBS = -L/usr/local/gfortran/lib/gcc/x86_64-apple-darwin15/6.1.0 -L/usr/local/gfortran/lib -lgfortran -lquadmath -lm
 @end smallexample
+or (Sierra)
+@smallexample
+F77 = /usr/local/gfortran/bin/gfortran
+FC = /usr/local/gfortran/bin/gfortran
+FLIBS = -L/usr/local/gfortran/lib/gcc/x86_64-apple-darwin16/6.3.0 -L/usr/local/gfortran/lib -lgfortran -lquadmath -lm
+@end smallexample
+
 
 @node Tcl/Tk headers and libraries, Java (macOS), El Capitan and Sierra, macOS
 @subsection Tcl/Tk headers and libraries
@@ -5136,6 +5148,11 @@
 @file{/opt/csw}.  Solaris 10 ships with @code{bzlib} version 1.0.6
 (sufficient) but @code{zlib} version 1.2.3 (too old): OpenCSW has 1.2.8.
 
+The Oracle compilers are unusual in not including
+@file{/usr/local/include} in the default include search path: @R{}'s
+default @code{CPPFLAGS=-I/usr/local/include} remedies this.  If you rely
+on OpenCSW software you may need @code{CPPFLAGS=-I/opt/csw/include}
+
 You will need @acronym{GNU} @code{libiconv} and @code{readline}: the
 Solaris version of @code{iconv} is not sufficiently powerful.
 
@@ -5338,7 +5355,13 @@
 version of Solaris in use.  (This can be ascertained from @command{gcc
 -v}.)  @command{gcc} makes modified versions of some header files, and
 several reports of problems were due to using @command{gcc} compiled on
-one version of Solaris on a later version.  
+one version of Solaris on a later version.  Note that this can even
+apply to OS patches: some 2016 patches to Solaris 10 changed its C
+header files in way incompatible@footnote{In particular, header
+@file{cmath} in C++11 mode includes @file{math.h} and
+@file{iso/math_c99.h} and @command{gcc} had `fixed' an earlier version
+of the latter.}  with the modified versions included with OpenCSW's
+binary distribution.
 
 The notes here are for @command{gcc} set up to use the Solaris linker:
 it can also be set up to use GNU @command{ld}, but that has not been
diff -ubr R-3.3.2/doc/manual/R-data.texi R-patched/doc/manual/R-data.texi
--- R-3.3.2/doc/manual/R-data.texi	2016-10-04 02:15:05.000000000 -0700
+++ R-patched/doc/manual/R-data.texi	2017-02-02 15:15:07.000000000 -0800
@@ -345,7 +345,7 @@
 By default strings are quoted (including the row and column names).
 Argument @code{quote} controls if character and factor variables are
 quoted: some programs, for example @pkg{Mondrian}
-(@uref{https://en.wikipedia.org/wiki/Mondrian_(software)}, do not accept
+(@uref{https://en.wikipedia.org/wiki/Mondrian_(software)}), do not accept
 quoted strings.
 
 Some care is needed if the strings contain embedded quotes.  Three
diff -ubr R-3.3.2/doc/manual/R-exts.texi R-patched/doc/manual/R-exts.texi
--- R-3.3.2/doc/manual/R-exts.texi	2016-10-28 15:15:07.000000000 -0700
+++ R-patched/doc/manual/R-exts.texi	2017-02-15 15:15:13.000000000 -0800
@@ -463,9 +463,9 @@
 suitable @samp{Authors@@R} field is given.  This field can be used to
 provide a refined and machine-readable description of the package
 ``authors'' (in particular specifying their precise @emph{roles}), via
-suitable @R{} code. It should create an object of class @code{"person'},
+suitable @R{} code. It should create an object of class @code{"person"},
 by either a call to @code{person} or a series of calls (one per
-``author'') concatenated by @code{c()}): see the example
+``author'') concatenated by @code{c()}: see the example
 @file{DESCRIPTION} file above.  The roles can include @samp{"aut"}
 (author) for full authors, @samp{"cre"} (creator) for the package
 maintainer, and @samp{"ctb"} (contributor) for other contributors,
@@ -506,10 +506,11 @@
 @acronym{CRAN} package listings.  @xref{Specifying URLs}.
 
 @c DESCRIPTION field BugReports
-The @samp{BugReports} field may contain a single
-@acronym{URL} to which bug reports about the package should be
-submitted.  This @acronym{URL} will be used by @code{bug.report}
-instead of sending an email to the maintainer.
+The @samp{BugReports} field may contain a single @acronym{URL} to which
+bug reports about the package should be submitted.  This @acronym{URL}
+will be used by @code{bug.report} instead of sending an email to the
+maintainer.  A browser is opened for a @samp{http://} or @samp{https://}
+@acronym{URL} (and others are ignored).
 
 @c DESCRIPTION field Priority
 Base and recommended packages (i.e., packages contained in the @R{}
@@ -718,6 +719,7 @@
 GPL-2 GPL-3 LGPL-2 LGPL-2.1 LGPL-3 AGPL-3 Artistic-2.0
 BSD_2_clause BSD_3_clause MIT
 @end example
+@noindent
 as made available @emph{via} @uref{https://www.R-project.org/@/Licenses/} and
 contained in subdirectory @file{share/licenses} of the @R{} source or home
 directory.
@@ -762,6 +764,7 @@
 License: GPL (>= 2) | BSD_3_clause + file LICENSE
 License: Artistic-2.0 | AGPL-3 + file LICENSE
 @end example
+@noindent
 Please note in particular that ``Public domain'' is not a valid license,
 since it is not recognized in some jurisdictions.
 
@@ -1231,8 +1234,8 @@
 this.  The script files must start with a (lower or upper case) letter
 and have one of the extensions @file{.R} or @file{.r}.  If present, the
 @file{demo} subdirectory should also have a @file{00Index} file with one
-line for each demo, giving its name and a description separated by a
-tab or at least three spaces. (This index file is not generated
+line for each demo, giving its name and a description separated by a tab
+or at least three spaces. (This index file is not generated
 automatically.)  Note that a demo does not have a specified encoding and
 so should be an @acronym{ASCII} file (@pxref{Encoding issues}).  As from
 @R{} 3.0.0 @code{demo()} will use the package encoding if there is one,
@@ -1403,8 +1406,8 @@
 
 @c DESCRIPTION field SysDataCompression
 The analogue for @file{sysdata.rda} is field @samp{SysDataCompression}:
-the default (since @R{} 2.12.2) is @code{xz} for files bigger than 1MB
-otherwise @code{gzip}.
+the default is @code{xz} for files bigger than 1MB otherwise
+@code{gzip}.
 
 @node Non-R scripts in packages, Specifying URLs, Data in packages, Package structure
 @subsection Non-R scripts in packages
@@ -1549,7 +1552,7 @@
 @group
 foo <- function(x) @{
     if(!@@HAVE_FOO@@)
-      stop("Sorry, library 'foo' is not available"))
+      stop("Sorry, library 'foo' is not available")
     ...
 @end group
 @end example
@@ -1562,7 +1565,7 @@
 @group
 foo <- function(x) @{
     if(!FALSE)
-      stop("Sorry, library 'foo' is not available"))
+      stop("Sorry, library 'foo' is not available")
     ...
 @end group
 @end example
@@ -2043,8 +2046,8 @@
 _OPENMP}: note that some toolchains used for @R{} (including that of
 macOS and some others using @command{clang}@footnote{Default builds of
 @command{clang} 3.8.0 and later have support for OpenMP, but the
-@code{libomp} library may not be installed.}) have no OpenMP support at
-all, not even @file{omp.h}.
+@code{libomp} run-time library may not be installed.}) have no OpenMP
+support at all, not even @file{omp.h}.
 
 For example, a package with C code written for OpenMP should have in
 @file{src/Makevars} the lines
@@ -2072,26 +2075,36 @@
 
 @noindent
 as the C compiler will be used to link the package code (and there is no
-guarantee that this will work everywhere).
+guarantee that this will work everywhere).  (This does not apply to
+Fortran 9x code, where @code{SHLIB_OPENMP_FCFLAGS} should be used in
+both @code{PKG_FCFLAGS} and @code{PKG_LIBS}.)
+
+For portability, any C/C++ code using the @code{omp_*} functions should
+include the @file{omp.h} header: some compilers (but not all) include it
+when OpenMP mode is switched on (e.g.@: @emph{via} flag
+@option{-fopenmp}).
 
 @c http://openmp.org/wp/openmp-compilers/
 @c clang 3.8.x reports 201307 but has full suport only for 3.1 (201111)
-There is nothing@footnote{In most implementations the
-@code{_OPENMP} macro has value a date which can be mapped to an OpenMP
-version: for example, value @code{201307} is the date of version 4.0
-(July 2013). However this may be used to denote the latest version which
-is partially supported, not that which is fully implemented.}  to say
-what version of OpenMP is supported: version 3.1 is supported by recent
-versions of the Linux, Windows and Solaris platforms, but portable
-packages cannot assume that end users have recent versions.  macOS
-currently uses Apple builds of @command{clang} with no OpenMP support
-(even if invoked as @command{gcc} and despite the @command{man} page
-including the flag @option{-fopenmp} for that command).
+There is nothing@footnote{In most implementations the @code{_OPENMP}
+macro has value a date which can be mapped to an OpenMP version: for
+example, value @code{201307} is the date of version 4.0 (July
+2013). However this may be used to denote the latest version which is
+partially supported, not that which is fully implemented.}  to say what
+version of OpenMP is supported: version 3.1 is supported by recent
+versions@footnote{GCC since 4.7, so @R{} builds for Windows since @R{}
+3.3.0, which also support OpenMP 4.0.} of the Linux, Windows and Solaris
+platforms, but portable packages cannot assume that end users have
+recent versions.@footnote{People do use older versions of OSes such as
+Ubuntu 12.04LTS which has GCC 4.4 or 4.6.} macOS currently uses Apple
+builds of @command{clang} with no OpenMP support (even if invoked as
+@command{gcc} and despite the @command{man} page including the flag
+@option{-fopenmp} for that command).
 
 The performance of OpenMP varies substantially between platforms.  The
 Windows implementation has substantial overheads@footnote{as did the
-GCC-based Apple implementation, but not if the Intel OpenMP runtime was
-used.}, so is only beneficial if quite substantial tasks are run in
+GCC-based Apple implementation, but not the Intel/LLVM OpenMP runtime
+on macOS.}, so is only beneficial if quite substantial tasks are run in
 parallel.  Also, on Windows new threads are started with the
 default@footnote{Windows default, not MinGW-w64 default.} FPU control
 word, so computations done on OpenMP threads will not make use of
@@ -2445,7 +2458,7 @@
 compilers commonly accept C99 extensions to C++98.  A minor
 update@footnote{The changes are linked from
 @uref{https://isocpp.org/@/std/@/standing-documents/@/sd-6-sg10-feature-test-recommendations}.}
-to C++11 (C++14) was approved in August 2014.
+to C++11 (C++14) was published in December 2014.
 
 What standard a C++ compiler aims to support can be hard to determine:
 the value@footnote{Values @code{199711}, @code{201103L} and
@@ -2479,7 +2492,7 @@
 @example
 CXX_STD = CXX11
 @end example
-
+@noindent
 Compilation and linking will then be done with the C++11 compiler.  If
 any other value is given to the @samp{CXX_STD} macro it will be ignored.
 (Further options may become available in the future as the C++ standard
@@ -2844,7 +2857,7 @@
 Use @kbd{R CMD check --help} to obtain more information about the usage
 of the @R{} package checker.  A subset of the checking steps can be
 selected by adding command-line options. It also allows customization by
-setting environment variables @w{@env{_R_CHECK_*_}:}, as described in
+setting environment variables @w{@env{_R_CHECK_*_}} as described in
 @ifset UseExternalXrefs
 @ref{Tools, , Tools, R-ints, R Internals}:
 @end ifset
@@ -2871,7 +2884,7 @@
 @noindent
 which reports unused local assignments.  Not only does this point out
 computations which are unnecessary because their results are unused, it
-also can show errors.  (Two such are to intend to update an object by
+also can uncover errors.  (Two such are to intend to update an object by
 assigning a value but mistype its name or assign in the wrong scope,
 for example using @code{<-} where @code{<<-} was intended.)  This can
 give false positives, most commonly because of non-standard evaluation
@@ -3138,7 +3151,7 @@
 A special case is @emph{package vignettes}.  Vignettes are documents in
 PDF or @HTML{} format obtained from plain text literate source files
 from which @R{} knows how to extract @R{} code and create output (in
-PDF/@HTML{} or intermediate (La)@TeX{}).  Vignette engines do this work,
+PDF/@HTML{} or intermediate @LaTeX{}).  Vignette engines do this work,
 using ``tangle'' and ``weave'' functions respectively.  Sweave, provided
 by the R distribution, is the default engine.  Since @R{} version 3.0.0,
 other vignette engines besides Sweave are supported; see @ref{Non-Sweave
@@ -3285,7 +3298,7 @@
 to the encoding of the current @R{} session.
 
 @code{Stangle()} will produce an @R{} code file in the current locale's
-encoding: for a non-@acronym{ASCII} vignette what that is recorded in a
+encoding: for a non-@acronym{ASCII} vignette what that is is recorded in a
 comment at the top of the file.
 
 @code{Sweave()} will produce a @file{.tex} file in the current
@@ -3300,13 +3313,13 @@
 included within the body of a larger document, or non-Sweave
 vignettes), the encoding may be declared using a comment like
 @example
-%!\VignetteEncoding@{UTF-8@}
+%\VignetteEncoding@{UTF-8@}
 @end example
 @noindent
 If the encoding is UTF-8, this can also be declared using
 the declaration
 @example
-%!\SweaveUTF8
+%\SweaveUTF8
 @end example
 @noindent
 If no declaration is given in the vignette, it will be assumed to be
@@ -3443,10 +3456,6 @@
 package namespace first, then the imports, then the base namespace and
 then the normal search path.
 
-Prior to @R{} 2.14.0, namespaces were optional in packages: a default
-namespace was generated on installation in 2.14.x and 2.15.x.  As from
-3.0.0 a namespace is mandatory.
-
 
 @menu
 * Specifying imports and exports::  
@@ -3690,7 +3699,9 @@
 There are at least two benefits to this approach.  Firstly, the symbol
 lookup is done just once for each symbol rather than each time the
 routine is invoked.  Secondly, this removes any ambiguity in resolving
-symbols that might be present in several compiled DLLs.
+symbols that might be present in several compiled DLLs.  However, this
+approach is nowadays deprecated in favour of supplying registration
+information (see below).
 
 In some circumstances, there will already be an @R{} variable in the
 package with the same name as a native symbol. For example, we may have
@@ -3815,6 +3826,13 @@
 @code{F_bkde} and so on, and so avoid clashes with @R{} code in the
 namespace.
 
+@strong{NB}: Using these arguments for a package which does not register
+native symbols merely slows down the package loading (although at the
+time of writing 90 @acronym{CRAN} packages did so).  Once symbols are
+registered, check that the corresponding @R{} variables are not
+accidentally exported by a pattern in the @file{NAMESPACE} file.
+
+
 @node An example, Namespaces with S4 classes and methods, useDynLib, Package namespaces
 @subsection An example
 
@@ -4123,28 +4141,33 @@
 behaviours are allowed
 (@uref{http://pubs.opengroup.org/@/onlinepubs/@/9699919799/@/utilities/@/echo.html})
 and both occur as defaults on @R{} platforms: portable applications
-should not use @option{-n} (as the first argument) nor escape sequences.
+should not use @option{-n} (as the first argument) nor escape
+sequences. Another common issue is the construction
+@example
+export FOO=value
+@end example
+@noindent
+which is bash-specific (first set the variable then export it by name).
 
 @item
 Make use of the abilities of your compilers to check the
 standards-conformance of your code.  For example, @command{gcc} and
 @command{gfortran}@footnote{@uref{http://fortranwiki.org/@/fortran/@/show/Modernizing+Old+Fortran}
 may help explain some of the warnings from @command{gfortran -Wall
--pedantic}.}  can be used with options @option{-Wall -pedantic} to
-alert you to potential problems.  This is particularly important for
-C++, where @code{g++ -Wall -pedantic} will alert you to the use of GNU
-extensions which fail to compile on most other C++ compilers. If @R{}
-was not configured accordingly, one can achieve this @emph{via} personal
-@file{Makevars} files.
+-pedantic}.}  can be used with options @option{-Wall -pedantic} to alert
+you to potential problems.  This is particularly important for C++,
+where @code{g++ -Wall -pedantic} will alert you to the use of some of
+the GNU extensions which fail to compile on most other C++ compilers. If
+@R{} was not configured accordingly, one can achieve this @emph{via}
+personal @file{Makevars} files.
 @ifset UseExternalXrefs
 @xref{Customizing package compilation, , Customizing package compilation,
 R-admin, R Installation and Administration},
 @end ifset
 
-Although there is a 2011 version of the C++ standard, implementations
-are not universally available.  Portable C++ code needs to follow the
-1998 standard (and not use features from C99).  See also @ref{Using
-C++11 code} to specify a C++11 compiler where available.
+Portable C++ code needs to follow the 1998 standard (and not use
+features from C99), or to specify a C++11 compiler (see @ref{Using C++11
+code}) where available (which is not the case on all @R{} platforms).
 
 If you use FORTRAN 77, @code{ftnchek}
 (@uref{http://www.dsm.fordham.edu/@/~ftnchek/}) provides thorough testing
@@ -4157,7 +4180,7 @@
 @R{} has tested that @code{DOUBLE COMPLEX} works (although an extension
 to the Fortran standards) and so is preferred to @code{COMPLEX*16}.
 (Fortran 9x code can use something like
-@code{COMPLEX(KIND=KIND(0.0D0)}@footnote{See
+@code{COMPLEX(KIND=KIND(0.0D0))}@footnote{See
 @uref{http://people.ds.cam.ac.uk/nmm1/fortran/paper_07.pdf}.}.)
 
 
@@ -4193,18 +4216,19 @@
 on some @R{} platforms (including 64-bit Windows), but 64-bit on most
 modern Unix and Linux platforms.  It is rather unlikely that the use of
 @code{long} in C code has been thought through: if you need a longer
-type than @code{int} you should use a configure test for a C99 type such
-as @code{int_fast64_t} (and failing that, @code{long long} @footnote{but
-note that @code{long long} is not a standard C++ type, and C++ compilers
-set up for strict checking will reject it.}) and typedef your own type
-to be @code{long} or @code{long long}, or use another suitable type
-(such as @code{size_t}).
+type than @code{int} you should use a configure test for a C99/C++11
+type such as @code{int_fast64_t} (and failing that, @code{long long}
+@footnote{but note that @code{long long} is not a standard C++98 type,
+and C++ compilers set up for strict checking will reject it.}) and
+typedef your own type to be @code{long} or @code{long long}, or use
+another suitable type (such as @code{size_t}).
 
 It is not safe to assume that @code{long} and pointer types are the same
 size, and they are not on 64-bit Windows.  If you need to convert
-pointers to and from integers use the C99 integer types @code{intptr_t}
-and @code{uintptr_t} (which are defined in the header @code{<stdint.h>}
-and are not required to be implemented by the C99 standard).
+pointers to and from integers use the C99/C++11 integer types
+@code{intptr_t} and @code{uintptr_t} (which are defined in the header
+@code{<stdint.h>} and are not required to be implemented by the C99
+standard but are used in C code by @R{} itself).
 
 Note that @code{integer} in @acronym{FORTRAN} corresponds to @code{int}
 in C on all @R{} platforms.
@@ -4282,6 +4306,15 @@
 part of @R{}'s namespace and should not be used in packages.
 
 @item
+It is good practice for DLLs to register their symbols
+(@pxref{Registering native routines}), restrict visibility
+(@pxref{Controlling visibility}) and not allow symbol search
+(@pxref{Registering native routines}).  It should be possible for a DLL
+to have only one visible symbol, @code{R_init_@var{pkgname}}, on
+suitable platforms@footnote{At least Linux and Windows, but not macOS.},
+which would completely avoid symbol conflicts.
+
+@item
 It is not portable to call compiled code in @R{} or other packages
 @emph{via} @code{.Internal}, @code{.C}, @code{.Fortran}, @code{.Call} or
 @code{.External}, since such interfaces are subject to change without
@@ -4324,6 +4357,20 @@
 all linkers allow a space after @option{-L} .
 
 @item
+Great care is needed with the use of @code{LinkingTo}.  This puts one or
+more directories on the include search path ahead of system headers but
+currently@footnote{This will change in @R{} 3.4.0.} after those
+specified in the @code{CPPFLAGS} macro of the @R{} build (which normally
+includes @code{-I/usr/local/include}, but most platforms ignore that and
+include it with the system headers).
+
+Any confusion would be avoided by having @code{LinkingTo} headers in a
+directory named after the package.  In any case, name conflicts of
+headers and directories under package @file{include} directories should
+be avoided, both between packages and between a package and system and
+third-party software.
+
+@item
 The @command{ar} utility is often used in makefiles to make static
 libraries.  Its modifier @code{u} is defined by POSIX but is disabled in
 GNU @command{ar} on some recent Linux distributions which use
@@ -4381,7 +4428,7 @@
 @command{pandoc}, which is only available for a very limited range of
 platforms (and has onerous requirements to install from source) and has
 capabilities@footnote{For example, the ability to handle @samp{https://}
-URLs, which even the build in some major Linux distributions in 2016 did
+URLs, which even the build in some major Linux distributions in 2017 did
 not possess.} that vary by build but are not documented.
 
 An external command can be an optional requirement for an imported
@@ -4610,24 +4657,27 @@
 extensions (such as POSIX functions) are supported.  Note that the POSIX
 standards only require recently-defined functions to be declared if
 certain macros are defined with large enough values, and on some
-compiler/OS combinations@footnote{This is seen on Linux and Solaris,
-although each has other ways to turn on all extensions, e.g.@: defining
-@code{_GNU_SOURCE} or @code{__EXTENSIONS__}: the GCC compilers by
-default define @code{_GNU_SOURCE} unless a strict standard such as
-@option{-std=c99} is used.  On OS X extensions are declared unless one
-of these macros is given too small a value.} they are not declared
-otherwise.  So you may need to include something like one of
-@footnote{Solaris 10 does not recognize this value of
-@code{_POSIX_C_SOURCE}, nor values of @code{_XOPEN_SOURCE} beyond 600.}
+compiler/OS combinations@footnote{This is seen on Linux, Solaris and
+FreeBSD, although each has other ways to turn on all extensions, e.g.@:
+defining @code{_GNU_SOURCE}, @code{__EXTENSIONS__} or
+@code{_BSD_SOURCE}: the GCC compilers by default define
+@code{_GNU_SOURCE} unless a strict standard such as @option{-std=c99} is
+used.  On OS X extensions are declared unless one of these macros is
+given too small a value.} they are not declared otherwise.  So you may
+need to include something like one of @footnote{Solaris 10 does not
+recognize this value of @code{_POSIX_C_SOURCE}, nor values of
+@code{_XOPEN_SOURCE} beyond 600.}
 @example
 #define _XOPEN_SOURCE 500
 @end example
+@noindent
 or
 @example
 #ifdef __GLIBC__
 # define _POSIX_C_SOURCE 200809L
 #endif
 @end example
+@noindent
 before @emph{any} headers.  (@code{strdup} and @code{strncasecmp} are
 two such functions.)
 
@@ -4701,7 +4751,8 @@
 @emph{etc} explicitly.
 
 It is an error (and make little sense, although has been seen) to call
-these functions for integer arguments.
+these functions for integer arguments: a few compilers give a compilation
+error.
 
 @item
 The GNU C/C++ compilers support a large number of non-portable
@@ -4715,6 +4766,10 @@
 @uref{https://gcc.gnu.org/@/onlinedocs/@/gcc/@/C-Extensions.html} and
 @uref{https://gcc.gnu.org/@/onlinedocs/@/gcc/@/C_002b_002b-Extensions.html}.
 
+Other GNU extensions which have bitten package writers is the use of
+non-portable characters such as @samp{$} in identifiers and use of C++
+headers under @file{ext}.
+
 The GNU Fortran compiler also supports a large number of non-portable
 extensions, the most commonly encountered one being
 @code{ISNAN}@footnote{There is a portable way to do this in Fortran 2003
@@ -4737,9 +4792,9 @@
 C++11 compilers, as functions like @code{sqrt} and @code{isnan} are
 defined for @code{double} arguments in @file{math.h} and for a range of
 types including @code{double} in @file{cmath}.  Similar issues have been
-seen for @file{stdlib.h} and @file{cstdlib}.  Historically, including
-the C++ version first was a sufficient workaround but for some 2016
-compilers only one can be included.
+seen for @file{stdlib.h} and @file{cstdlib}.  Including the C++ version
+first used to be a sufficient workaround but for some 2016 compilers
+only one could be included.
 
 @item
 Variable-length arrays are C99, not supported by C++98 nor by the C++
@@ -4773,6 +4828,7 @@
 @example
 using std::floor;
 @end example
+@noindent
 but it is usually preferable to use explicit namespace prefixes in the code.
 
 Examples seen in @acronym{CRAN} packages include
@@ -4787,11 +4843,16 @@
 @example
       if(ptr > 0) @{ ....@}
 @end example
+@noindent
 which compares a pointer to the integer @code{0}.  This could just use
 @code{if(ptr)} (pointer addresses cannot be negative) but if needed
 pointers can be tested against @code{nullptr} (C++11 and later) or
 @code{NULL}.
 
+@c gcc6 accepts it, gcc5 does not, it seems.
+Note that although @code{nullptr} was only introduced in C++11, some
+compilers accept it in C++98 mode (but most do not).
+
 @item
 Macros defined by the compiler/OS can cause problems.  Identifiers
 starting with an underscore followed by an upper-case letter or another
@@ -4812,8 +4873,9 @@
 all-upper-case names which have a unique prefix such as the package name.
 
 @item
-@code{typedef}s in OS headers can conflict with those in the package: an
-example is @code{index_t} defined in @file{<sys/types.h>} on Solaris.
+@code{typedef}s in OS headers can conflict with those in the package:
+two examples are @code{ulong} on several OSes and @code{index_t} on
+Solaris.
 
 @item
 If you use OpenMP, check carefully that you have followed the advice in
@@ -4845,6 +4907,7 @@
 ...
 strdup call(s)
 @end example
+@noindent
 where the appropriate value can be found by @command{man strdup} on
 Linux.  (Use of @code{strncasecmp} is similar.)
 
@@ -4863,6 +4926,7 @@
 @example
 erf expm1 fmin fmax lgamma lround loglp round snprintf strcasecmp trunc
 @end example
+@noindent
 and the POSIX function @code{strdup}.
 
 @end itemize
@@ -5082,7 +5146,7 @@
 and mark strings by
 
 @example
-dngettext(("@var{pkg}", @var{<singular string>}, @var{<plural string>}, n)
+dngettext("@var{pkg}", @var{<singular string>}, @var{<plural string>}, n)
 @end example
 
 @item
@@ -5222,13 +5286,10 @@
 @end example
 
 Note the way that information that may need to be updated is picked up
-from object @code{meta}, a parsed version of the @file{DESCRIPTION}
-file@footnote{this object is available since @R{} 2.8.0, so the
-@samp{Depends} field in the @file{DESCRIPTION} file should contain
-something at least as restrictive as @samp{R (>= 2.8}.} -- it is
-tempting to hardcode such information, but it normally then gets
-outdated.  See @code{?bibentry} for further details of the information
-which can be provided.
+from object @code{meta}, a parsed version of the @file{DESCRIPTION} file
+-- it is tempting to hardcode such information, but it normally then
+gets outdated.  See @code{?bibentry} for further details of the
+information which can be provided.
 
 In case a bibentry contains @LaTeX{} markup (e.g., for accented
 characters or mathematical symbols), it may be necessary to provide a
@@ -6390,8 +6451,8 @@
 The ``comment'' character @samp{%} and unpaired braces@footnote{See the
 examples section in the file @file{Paren.Rd} for an example.}
 @emph{almost always} need to be escaped by @samp{\}, and @samp{\\} can
-be used for backslash and needs to be when there two or more adjacent
-backslashes).  In @R{}-like code quoted strings are handled slightly
+be used for backslash and needs to be when there are two or more adjacent
+backslashes.  In @R{}-like code quoted strings are handled slightly
 differently; see @uref{https://developer.r-project.org/parseRd.pdf,
 ``Parsing Rd files''} for details -- in particular braces should not be
 escaped in quoted strings.
@@ -7251,6 +7312,7 @@
                  as.integer(runif(N, 1, 12)), as.integer(runif(N, 1, 28)))
 system.time(a <- as.POSIXct(dates, format = "%Y-%m-%d"))
 @end example
+@noindent
 with timings from the final step
 @example
    user  system elapsed
@@ -7265,6 +7327,7 @@
 "sprintf"                 0.74    17.87       0.98     23.67
 ...
 @end example
+@noindent
 so the conversion from character to @code{POSIXlt} takes most of the
 time.
 
@@ -7277,6 +7340,7 @@
 ## And for the system time
 opreport -l /lib64/libc.so.6
 @end example
+@noindent
 The first report shows where (which library etc) the time was spent:
 @example
 CPU_CLK_UNHALT...|
@@ -7314,6 +7378,7 @@
 584       1.6015  R           day_of_the_week
 ...
 @end example
+@noindent
 @command{opannotate} shows that 31% of the time in @R{} is spent in
 @file{memory.c}, 21% in @file{datetime.c} and 7% in @file{Rstrptime.h}.
 The analysis for @file{libc} showed that calls to @code{wcsftime}
@@ -7633,7 +7698,8 @@
 options(expressions=500)
 @end example
 
-@noindent and re-run the example showing the error.
+@noindent 
+and re-run the example showing the error.
 
 Sometimes there is warning that clearly is the precursor to some later
 error, but it is not obvious where it is coming from.  Setting
@@ -8094,8 +8160,8 @@
 provided @command{llvm-symbolizer}@footnote{part of the LLVM project and
 in distributed in @code{llvm} RPMs and @code{.deb}s on Linux.  It is not
 currently shipped by Apple.} is on the path: if it is available but not
-on the path or has been renamed@footnote{as Ubuntu does.}, one can use an
-environment variable, e.g.@:
+on the path or has been renamed@footnote{as Ubuntu is said to do.}, one
+can use an environment variable, e.g.@:
 
 @example
 ASAN_SYMBOLIZER_PATH=/path/to/llvm-symbolizer
@@ -8128,6 +8194,7 @@
 F77 = gfortran -fsanitize=address
 FC = gfortran -fsanitize=address
 @end example
+@noindent
 (Note that @code{-fsanitize=address} has to be part of the compiler
 specification to ensure it is used for linking.  These settings will not
 be honoured by packages which ignore @file{~/.R/Makevars}.)  It will
@@ -8153,9 +8220,16 @@
 @example
 break __asan_report_error
 @end example
+@noindent
 (See
 @uref{https://code.google.com/@/p/@/address-sanitizer/@/wiki@//AddressSanitizer#gdb}.)
 
+Recent versions@footnote{This is expected to be in @command{gcc} 7 and
+@command{clang} 4.0.0.  Currently for @command{gcc} it is implied by
+@option{-fsanitize=address}.} added the flag
+@option{-fsanitize-address-use-after-scope}: see
+@uref{https://github.com//google//sanitizers//wiki//AddressSanitizerUseAfterScope}.
+
 @menu
 * Using Leak Sanitizer::        
 @end menu
@@ -8250,6 +8324,7 @@
 @example
 -fsanitize=unsigned-integer-overflow
 @end example
+@noindent
 is available as a separate option in some versions of @command{clang}
 (not enabled by @option{-fsanitize=undefined}).
 
@@ -8781,6 +8856,7 @@
 @end multitable
 @end quotation
 
+@noindent
 Do please note the first two.  On the 64-bit Unix/Linux/macOS platforms,
 @code{long} is 64-bit whereas @code{int} and @code{INTEGER} are 32-bit.
 Code ported from S-PLUS (which uses @code{long *} for @code{logical} and
@@ -8993,8 +9069,6 @@
 @quotation
 @cartouche
 @example
-#include <R.h>
-#include <Rinternals.h>
 #include <R_ext/Rdynload.h>
 
 void
@@ -9014,10 +9088,12 @@
 @end quotation
 
 If a shared object/DLL is loaded more than once the most recent version
-is used.  More generally, if the same symbol name appears in several
-shared objects, the most recently loaded occurrence is used.  The
-@code{PACKAGE} argument and registration (see the next section) provide
-good ways to avoid any ambiguity in which occurrence is meant.
+is used.@footnote{Strictly this is OS-specific, but no exceptions have
+been seen for many years.}  More generally, if the same symbol name
+appears in several shared objects, the most recently loaded occurrence
+is used.  The @code{PACKAGE} argument and registration (see the next
+section) provide good ways to avoid any ambiguity in which occurrence is
+meant.
 
 On Unix-alikes the paths used to resolve dynamically linked dependent
 libraries are fixed (for security reasons) when the process is launched,
@@ -9039,20 +9115,39 @@
 @section Registering native routines
 @cindex Registering native routines
 
+@menu
+* Speed considerations::        
+* Converting a package to use registration::  
+* Linking to native routines in other packages::  
+@end menu
+
 By `native' routine, we mean an entry point in compiled code.
 
 In calls to @code{.C}, @code{.Call}, @code{.Fortran} and
 @code{.External}, @R{} must locate the specified native routine by
 looking in the appropriate shared object/DLL.  By default, @R{} uses the
-operating system-specific dynamic loader to lookup the symbol in all
-loaded DLLs and elsewhere.  Alternatively, the author of the DLL
-can explicitly register routines with @R{} and use a single,
+operating-system-specific dynamic loader to lookup the symbol in
+all@footnote{For calls from within a namespace the search is confined to
+the DLL loaded for that package.} loaded DLLs and the @R{} executable
+or libraries it is linked to.  Alternatively, the author of the DLL can
+explicitly register routines with @R{} and use a single,
 platform-independent mechanism for finding the routines in the DLL.  One
 can use this registration mechanism to provide additional information
 about a routine, including the number and type of the arguments, and
-also make it available to @R{} programmers under a different name.  In
-the future, registration may be used to implement a form of ``secure''
-or limited native access.
+also make it available to @R{} programmers under a different name.
+@c No sign of this in 15 years ....
+@c In the future, registration may be used to
+@c implement a form of ``secure'' or limited native access.
+
+Registering routines has two main advantages: it provides a
+faster@footnote{For unregistered entry points the OS's @code{dlsym}
+routine is used to find addresses.  Its performance varies considerably
+by OS and even in the best case it will need to search a much larger
+symbol table than, say, the table of @code{.Call} entry points.} way to
+find the address of the entry point @emph{via} tables stored in the DLL
+at compilation time, and it provides a run-time check that the entry
+point is called with the right number of arguments and, optionally, the
+right argument types.
 
 @findex R_registerRoutines
 To register routines with @R{}, one calls the C routine
@@ -9064,7 +9159,7 @@
 information about the methods.  The remaining 4 arguments are arrays
 describing the routines for each of the 4 different interfaces:
 @code{.C}, @code{.Call}, @code{.Fortran} and @code{.External}.  Each
-argument is a @code{FIND}-terminated array of the element types given in
+argument is a @code{NULL}-terminated array of the element types given in
 the following table:
 
 @quotation
@@ -9076,7 +9171,7 @@
 @end multitable
 @end quotation
 
-Currently, the @code{R_ExternalMethodDef} is the same as
+Currently, the @code{R_ExternalMethodDef} type is the same as
 @code{R_CallMethodDef} type and contains fields for the name of the
 routine by which it can be accessed in @R{}, a pointer to the actual
 native symbol (i.e., the routine itself), and the number of arguments
@@ -9101,9 +9196,7 @@
 along with any other routines for the @code{.Call} interface. For
 routines with a variable number of arguments invoked @emph{via} the
 @code{.External} interface, one specifies @code{-1} for the number of
-arguments which tells @R{} not to check the actual number passed.  Note
-that the number of arguments passed to @code{.External} were not
-checked prior to @R{} 3.0.0.
+arguments which tells @R{} not to check the actual number passed.
 
 Routines for use with the @code{.C} and @code{.Fortran} interfaces are
 described with similar data structures, but which have two additional
@@ -9136,6 +9229,7 @@
 We would register it as
 
 @example
+@group
 static R_NativePrimitiveArgType myC_t[] = @{
     REALSXP, INTSXP, STRSXP, LGLSXP
 @};
@@ -9144,15 +9238,20 @@
    @{"myC", (DL_FUNC) &myC, 4, myC_t@}
    @{NULL, NULL, 0@}
 @};
+@end group
 @end example
 
-One can also specify whether each argument is used simply as input, or
-as output, or as both input and output.  The style field in the
-description of a method is used for this.  The purpose is to
-allow@footnote{but this is not currently done.} @R{} to transfer values
-more efficiently across the @R{}-C/FORTRAN interface by avoiding copying
-values when it is not necessary. Typically, one omits this information
-in the registration data.
+@c Never implemented ....
+@c One can also specify whether each argument is used simply as input, or
+@c as output, or as both input and output.  The style field in the
+@c description of a method is used for this.  The purpose is to
+@c allow@footnote{but this is not currently done.} @R{} to transfer values
+@c more efficiently across the @R{}-C/FORTRAN interface by avoiding copying
+@c values when it is not necessary. Typically, one omits this information
+@c in the registration data.
+
+Note that @code{.Fortran} entry points are mapped to lowercase, so
+registration should use lowercase only.
 
 Having created the arrays describing each routine, the last step is to
 actually register them with @R{}.  We do this by calling
@@ -9174,25 +9273,25 @@
 @code{.Fortran} and @code{.External} interfaces.  In our example, these
 are given as @code{NULL} since we have no routines of these types.
 
-When @R{} unloads a shared object/DLL, its registrations are
-automatically removed.  There is no other facility for unregistering a
-symbol.
+When @R{} unloads a shared object/DLL, its registrations are removed.
+There is no other facility for unregistering a symbol.
 
 Examples of registering routines can be found in the different packages
-in the @R{} source tree (e.g., @pkg{stats}).  Also, there is a
-brief, high-level introduction in @emph{R News} (volume 1/3, September
-2001, pages 20--23, @uref{https://www.r-project.org/@/doc/@/Rnews/Rnews_2001-3.pdf}).
+in the @R{} source tree (e.g., @pkg{stats} and @pkg{graphics}).  Also,
+there is a brief, high-level introduction in @emph{R News} (volume 1/3,
+September 2001, pages 20--23,
+@uref{https://www.r-project.org/@/doc/@/Rnews/Rnews_2001-3.pdf}).
 
 Once routines are registered, they can be referred to as @R{} objects if
 they this is arranged in the @code{useDynLib} call in the package's
-@file{NAMESPACE} file (see @ref{useDynLib}).  This avoids the overhead
-of looking up an entry point each time it is used, and ensure that the
-entry point in the package is the one used (without a @code{PACKAGE =
-"pkg"} argument).  So for example the @pkg{stats} package has
+@file{NAMESPACE} file (see @ref{useDynLib}).  So for example the
+@pkg{stats} package has
 @example
 # Refer to all C/Fortran routines by their name prefixed by C_
 useDynLib(stats, .registration = TRUE, .fixes = "C_")
 @end example
+
+@noindent
 in its @file{NAMESPACE} file, and then @code{ansari.test}'s default
 methods can contain
 @example
@@ -9201,12 +9300,67 @@
 		as.integer(m), as.integer(n))$p
 @end example
 
-@menu
-* Speed considerations::        
-* Linking to native routines in other packages::  
-@end menu
+@noindent
+This avoids the overhead of looking up an entry point each time it is
+used, and ensures that the entry point in the package is the one used
+(without a @code{PACKAGE = "pkg"} argument).
 
-@node Speed considerations, Linking to native routines in other packages, Registering native routines, Registering native routines
+@code{R_init_} routines are often of the form
+@example
+void attribute_visible R_init_mypkg(DllInfo *dll)
+@{
+    R_registerRoutines(dll, CEntries, CallEntries, FortEntries,
+                       ExternalEntries);
+    R_useDynamicSymbols(dll, FALSE);
+    R_forceSymbols(dll, TRUE);
+...
+@}
+@end example
+
+@noindent
+@findex R_useDynamicSymbols
+@findex R_forceSymbols
+The @code{R_useDynamicSymbols} call says the DLL is not to be searched
+for entry points specified by character strings so @code{.C} etc calls
+will only find registered symbols: the @code{R_forceSymbols} call only
+allows @code{.C} etc calls which specify entry points by @R{} objects
+such as @code{C_pansari} (and not by character strings).  Each provides
+some protection against accidentally finding your entry points when
+people supply a character string without a package, and avoids slowing
+down such searches.  (For the visibility attribute @pxref{Controlling
+visibility}.)
+
+In more detail, if a package @code{mypkg} contains entry points
+@code{reg} and @code{unreg} and the first is registered as a 0-argument
+@code{.Call} routine, we could use (from code in the package)
+
+@example
+.Call("reg")
+.Call("unreg")
+@end example
+
+@noindent
+Without or with registration, these will both work.  If
+@code{R_init_mypkg} calls @code{R_useDynamicSymbols(dll, FALSE)}, only
+the first will work.  If in addition to registration the
+@file{NAMESPACE} file contains
+
+@example
+useDynLib(mypkg, .registration = TRUE, .fixes = "C_")
+@end example
+
+@noindent
+then we can call @code{.Call(C_reg)}.  Finally, if @code{R_init_mypkg}
+also calls @code{R_forceSymbols(dll, TRUE)}, only @code{.Call(C_reg)}
+will work (and not @code{.Call("reg")}).  This is usually what we want:
+it ensures that all of our own @code{.Call} calls go directly to the
+intended code in our package and that no one else accidentally finds our
+entry points.  (Should someone need to call our code from outside the
+package, for example for debugging, they can use
+@code{.Call(mypkg:::C_reg)}.)
+
+
+@node Speed considerations, Converting a package to use registration, Registering native routines, Registering native routines
 @subsection Speed considerations
 
 Sometimes registering native routines or using a @code{PACKAGE} argument
@@ -9219,12 +9373,17 @@
 @example
 foo <- function(x) .Call("foo", x)
 @end example
+@noindent
 with C code
 @example
+@group
+#include <Rinternals.h>
+
 SEXP foo(SEXP x)
 @{
     return x;
 @}
+@end group
 @end example
 If we compile with by @command{R CMD SHLIB foo.c}, load the code by
 @code{dyn.load("foo.so")} and run @code{foo(pi)} it took around 22
@@ -9232,6 +9391,7 @@
 @example
 foo2 <- function(x) .Call("foo", x, PACKAGE = "foo")
 @end example
+@noindent
 reduced the time to 1.7 us.
 
 Now consider making these functions part of a package whose
@@ -9250,19 +9410,19 @@
 @example
 foo3 <- function(x) .Call(C_foo, x)
 @end example
+@noindent
 then the address for the native routine is looked up just once when the
 package is loaded, and @code{foo3(pi)} takes about 0.8 us.
 
-Versions using @code{.C()} rather than @code{.Call()} take about 0.2 us
+Versions using @code{.C()} rather than @code{.Call()} took about 0.2 us
 longer.
 
 These are all quite small differences, but C routines are not uncommonly
-invoked millions of times for run times of a few microseconds, and those
-doing such things may wish to be aware of the differences.
+invoked millions of times for run times of a few microseconds each, and
+those doing such things may wish to be aware of the differences.
 
-On Linux and Solaris there is a much smaller overhead in looking up
-symbols so @code{foo(pi)} takes around 5 times as long as
-@code{foo3(pi)}.
+On Linux and Solaris there is a smaller overhead in looking up
+symbols.
 
 Symbol lookup on Windows used to be far slower, so @R{} maintains a
 small cache.  If the cache is currently empty enough that the symbol can
@@ -9271,9 +9431,274 @@
 registered symbols and so these never contribute to the cache: however
 many other packages do rely on symbol lookup.
 
+In more recent versions of @R{} all the standard packages register
+native symbols and do not allow symbol search, so in a new session
+@code{foo()} can only look in @file{foo.so} and may be as fast as
+@code{foo2()}.  This will no longer apply when many contributed packages
+are loaded, and generally those last loaded are searched first.  For
+example, consider @R{} 3.3.2 on x86_64 Linux.  In an empty @R{} session,
+both @code{foo()} and @code{foo2()} took about 0.75 us; however after
+packages @CRANpkg{igraph} and @CRANpkg{spatstat} had been loaded (which
+loaded another 12 DLLs), @code{foo()} took 3.6 us but @code{foo2()}
+still took about 0.80 us.  Using registration in a package reduced this
+to 0.55 us and @code{foo3()} took 0.40 us, times which were unchanged
+when further packages were loaded.
+
+@node Converting a package to use registration, Linking to native routines in other packages, Speed considerations, Registering native routines
+@subsection Example: converting a package to use registration
+
+The @pkg{splines} package was converted to use symbol registration in
+2001, but we can use it as an example@footnote{Because it is a standard
+package, one would need to rename it before attempting to reproduce the
+account here.} of what needs to be done for a small package.
+
+@itemize
+
+@item
+Find the relevant entry points.
+This is somewhat OS-specific, but something like the following should be
+possible at the OS command-line
+
+@example
+@group
+nm -g /path/to/splines.so | grep " T "
+0000000000002670 T _spline_basis
+0000000000001ec0 T _spline_value
+@end group
+@end example
+
+@noindent
+This indicates that there are two relevant entry points. (They may or
+may not have a leading underscore, as here. Fortran entry points will
+have a trailing underscore.)  Check in the @R{} code that they are
+called by the package and how: in this case they are used by
+@code{.Call}.
+
+Alternatively, examine the package's @R{} code for all @code{.C},
+@code{.Fortran}, @code{.Call} and @code{.External} calls.
+
+@item
+Construct the registration table.
+First write skeleton registration code, conventionally in file
+@file{src/init.c} (or at the end of the only C source file in the
+package):
+
+@example
+@group
+#include <stdlib.h> // for NULL
+#include <R_ext/Rdynload.h>
+
+#define CALLDEF(name, n)  @{#name, (DL_FUNC) &name, n@}
+
+const static R_CallMethodDef R_CallDef[] = @{
+   CALLDEF(spline_basis, ?),
+   CALLDEF(spline_value, ?),
+   @{NULL, NULL, 0@}
+@};
+
+void R_init_splines(DllInfo *dll)
+@{
+    R_registerRoutines(dll, NULL, R_CallDef, NULL, NULL);
+@}
+@end group
+@end example
+
+@noindent
+and then replace the @code{?} in the skeleton with the actual numbers of
+arguments.  You will need to add declarations of the functions unless
+appending to the only C source file.  Some packages will already have
+these in a header file, or you could create one and include it in
+@file{init.c}, for example @file{splines.h} containing
+
+@smallexample
+@group
+#include <Rinternals.h> // for SEXP
+extern SEXP spline_basis(SEXP knots, SEXP order, SEXP xvals, SEXP derivs);
+extern SEXP spline_value(SEXP knots, SEXP coeff, SEXP order, SEXP x, SEXP deriv);
+@end group
+@end smallexample
+
+For examples of registering other types of calls, see packages
+@pkg{graphics} and @pkg{stats}.  In particular, when registering entry
+points for @code{.Fortran} one needs declarations as if called from C,
+such as
+
+@example
+@group
+#include <R_ext/RS.h>
+void F77_NAME(supsmu)(int *n, double *x, double *y,
+                      double *w, int *iper, double *span, double *alpha,
+                      double *smo, double *sc, double *edf);
+@end group
+@end example
+
+One can get away with inaccurate argument lists in the declarations: it
+is easy to specify the arguments for @code{.Call} (all @code{SEXP}) and
+@code{.External} (one @code{SEXP}) and as the arguments for @code{.C}
+and @code{.Fortran} are all pointers, specifying them as @code{void *}
+suffices. (For most platforms one can omit all the arguments.)
+
+@item
+(Optional but highly recommended.)  Restrict @code{.Call} etc to using the
+symbols you chose to register by editing @file{src/init.c} to contain
+
+@example
+@group
+void R_init_splines(DllInfo *dll)
+@{
+    R_registerRoutines(dll, NULL, R_CallDef, NULL, NULL);
+    R_useDynamicSymbols(dll, FALSE);
+@}
+@end group
+@end example
+
+@end itemize
+
+A skeleton for the steps so far can be made using tools in @R{} 3.4.0
+and later.
 
+The remaining steps are optional but recommended.
+
+@itemize
+@item
+Edit the @file{NAMESPACE} file to create @R{} objects for the registered
+symbols:
+
+@example
+useDynLib(splines, .registration = TRUE, .fixes = "C_")
+@end example
+
+@item
+Find all the relevant calls in the @R{} code and edit them to use the
+@R{} objects.  This entailed changing the lines
+
+@smallexample
+temp <- .Call("spline_basis", knots, ord, x, derivs, PACKAGE = "splines")
+y[accept] <- .Call("spline_value", knots, coeff, ord, x[accept], deriv, PACKAGE = "splines")
+y = .Call"spline_value", knots, coef(object), ord, x, deriv, PACKAGE = "splines"))
+@end smallexample
+@noindent
+to
+
+@smallexample
+temp <- .Call(C_spline_basis, knots, ord, x, derivs)
+y[accept] <- .Call(C_spline_value, knots, coeff, ord, x[accept], deriv)
+y = .Call(C_spline_value, knots, coef(object), ord, x, deriv))
+@end smallexample
+
+@item
+Restrict @code{.Call} to using the @R{} symbols by editing
+@file{src/init.c} to contain
+
+@example
+@group
+void R_init_splines(DllInfo *dll)
+@{
+    R_registerRoutines(dll, NULL, R_CallDef, NULL, NULL);
+    R_useDynamicSymbols(dll, FALSE);
+    R_forceSymbols(dll, TRUE);
+@}
+@end group
+@end example
+
+@item
+Consider visibility.  On some OSes we can hide entry points from the
+loader, which precludes any possible name clashes and calling them
+accidentally (usually with incorrect arguments and crashing the @R{}
+process). If we repeat the first step we now see
+
+@example
+@group
+nm -g /path/to/splines.so | grep " T "
+0000000000002e00 T _R_init_splines
+00000000000025e0 T _spline_basis
+0000000000001e20 T _spline_value
+@end group
+@end example
 
-@node Linking to native routines in other packages,  , Speed considerations, Registering native routines
+@noindent
+If there were any entry points not intended to be used by the package we
+should try to avoid exporting them, for example by making them
+@code{static}.  Now the two relevant entry points are only accessed
+@emph{via} the registration table, we can hide them.  There are two ways
+to do so on some Unix-alikes.  We can hide individual entry points
+@emph{via}
+
+@example
+@group
+#include <R_ext/Visibility.h>
+
+SEXP attribute_hidden
+spline_basis(SEXP knots, SEXP order, SEXP xvals, SEXP derivs)
+@dots{}
+
+SEXP attribute_hidden
+spline_value(SEXP knots, SEXP coeff, SEXP order, SEXP x, SEXP deriv)
+@dots{}
+@end group
+@end example
+
+@noindent
+Alternatively, we can change the default visibility for all C symbols by
+including
+
+@example
+PKG_CFLAGS = $(C_VISIBILITY)
+@end example
+
+@noindent
+in @file{src/Makevars}, and then we need to allow registration by
+declaring @code{R_init_splines} to be visible:
+
+@example
+@group
+#include <R_ext/Visibility.h>
+
+void attribute_visible
+R_init_splines(DllInfo *dll)
+@dots{}
+@end group
+@end example
+
+@noindent
+@xref{Controlling visibility} for more details, including using Fortran
+code and ways to restrict visibility on Windows.
+
+@item
+We end up with a file @file{src/init.c} containing
+
+@quotation
+@cartouche
+@example
+#include <stdlib.h>
+#include <R_ext/Rdynload.h>
+#include <R_ext/Visibility.h>  // optional
+
+#include "splines.h"
+
+#define CALLDEF(name, n)  @{#name, (DL_FUNC) &name, n@}
+
+const static R_CallMethodDef R_CallDef[] = @{
+    CALLDEF(spline_basis, 4),
+    CALLDEF(spline_value, 5),
+    @{NULL, NULL, 0@}
+@};
+
+void
+attribute_visible  // optional
+R_init_splines(DllInfo *dll)
+@{
+    R_registerRoutines(dll, NULL, R_CallDef, NULL, NULL);
+    R_useDynamicSymbols(dll, FALSE);
+    R_forceSymbols(dll, TRUE);
+@}
+@end example
+@end cartouche
+@end quotation
+
+@end itemize
+
+@node Linking to native routines in other packages,  , Converting a package to use registration, Registering native routines
 @subsection Linking to native routines in other packages
 
 In addition to registering C routines to be called by @R{}, it can at
@@ -9295,7 +9720,7 @@
 @example
 R_RegisterCCallable("packA", "myCfun", myCfun);
 @end example
-
+@noindent
 in its initialization function @code{R_init_packA}.  A package
 @pkg{packB} that wants to use this routine would retrieve the function
 pointer with a call of the form
@@ -9322,8 +9747,9 @@
 (so the path to their compiled code has been registered).
 
 
-A @acronym{CRAN} example of the use of this mechanism is package
-@CRANpkg{lme4}, which links to @CRANpkg{Matrix}.
+@acronym{CRAN} examples of the use of this mechanism include @CRANpkg{coxme}
+linking to @CRANpkg{bdsmatrix} and @CRANpkg{xts} linking to
+@CRANpkg{zoo}
 
 @node Creating shared objects, Interfacing C++ code, Registering native routines, System and foreign language interfaces
 @section Creating shared objects
@@ -9746,7 +10172,7 @@
 @example
 PKG_LIBS= -L<something> -lexB
 @end example
-
+@noindent
 and one possibility is that @code{<something>} is the path to the
 installed @file{pkgB/libs} directory.  To find that we need to ask @R{}
 where it is by something like
@@ -9770,7 +10196,7 @@
 before: libexB.dll.a
 libexB.dll.a: exB.def
 @end example
-
+@noindent
 and then installing package @pkg{packA} will make and use the import
 library for @file{exB.dll}.  (One way to prepare the exports file is to
 use @file{pexports.exe}.)
@@ -11540,7 +11966,7 @@
 Package @CRANpkg{RODBC} uses external pointers to maintain its
 @emph{channels}, connections to databases.  There can be several
 connections open at once, and the status information for each is stored
-in a C structure (pointed to by @code{this_handle}) in the code extract
+in a C structure (pointed to by @code{thisHandle} in the code extract
 below) that is returned @emph{via} an external pointer as part of the RODBC
 `channel' (as the @code{"handle_ptr"} attribute).  The external pointer
 is created by
@@ -12092,9 +12518,10 @@
 output stream.
 
 Functions @code{Rvprintf} and @code{REvprintf} are analogues using the
-@code{vprintf} interface.  Because that is a C99 interface, they are
-only defined by @file{R_ext/Print.h} in C++ code if the macro
-@code{R_USE_C99_IN_CXX} is defined when it is included.
+@code{vprintf} interface.  Because that is a C99@footnote{also part of
+C++11.} interface, they are only defined by @file{R_ext/Print.h} in C++
+code if the macro @code{R_USE_C99_IN_CXX} is defined when it is
+included.
 
 Another circumstance when it may be important to use these functions is
 when using parallel computation on a cluster of computational nodes, as
@@ -12379,7 +12806,7 @@
 The Gamma function, the natural logarithm of its absolute value and
 first four derivatives and the n-th derivative of Psi, the digamma
 function, which is the derivative of @code{lgammafn}. In other words,
-@code{digamma(x)} is the same as @code{(psigamma(x,0)},
+@code{digamma(x)} is the same as @code{psigamma(x,0)},
 @code{trigamma(x) == psigamma(x,1)}, etc.
 @end deftypefun
 
@@ -13012,7 +13439,9 @@
 big-endian@footnote{@uref{https://en.wikipedia.org/@/wiki/@/Endianness}.}
 systems (e.g.@: most OSes on Sparc and PowerPC hardware) and not on
 little-endian systems (nowadays all the commoner @R{} platforms).  It
-can be useful when manipulating binary files.
+can be useful when manipulating binary files.  NB: these macros apply
+only to the C compiler used to build @R{}, not necessarily to another C
+or C++ compiler.
 
 Header file @file{Rversion.h} (@strong{not} included by @file{R.h})
 defines a macro @code{R_VERSION} giving the version number encoded as an
@@ -13088,17 +13517,18 @@
 @section Controlling visibility
 @cindex Visibility
 
-Header @file{R_ext/Visibility} has some definitions for controlling the
+Header @file{R_ext/Visibility.h} has some definitions for controlling the
 visibility of entry points.  These are only effective when
 @samp{HAVE_VISIBILITY_ATTRIBUTE} is defined -- this is checked when @R{}
 is configured and recorded in header @file{Rconfig.h} (included by
-@file{R_ext/Visibility.h}).  It is generally defined on modern
-Unix-alikes with a recent compiler@footnote{It is defined by the Intel
-compilers, but also hides unsatisfied references and so cannot be used
-with @R{}.}, but not supported on macOS nor Windows.  Minimizing the
-visibility of symbols in a shared library will both speed up its loading
-(unlikely to be significant) and reduce the possibility of linking to
-other entry points of the same name.
+@file{R_ext/Visibility.h}).  It is often defined on modern Unix-alikes
+with a recent compiler@footnote{It is defined by the Intel compilers,
+but also hides unsatisfied references and so cannot be used with @R{}.
+It is not supported by the AIX nor Solaris compilers.}, but not
+supported on macOS nor Windows.  Minimizing the visibility of symbols in
+a shared library will both speed up its loading (unlikely to be
+significant) and reduce the possibility of linking to other entry points
+of the same name.
 
 C/C++ entry points prefixed by @code{attribute_hidden} will not be
 visible in the shared object.  There is no comparable mechanism for
@@ -14014,9 +14444,12 @@
 @end example
 
 @noindent
-Note that @code{uintptr_t} is a C99 type for which a substitute is
-defined in @R{}, so your code needs to define @code{HAVE_UINTPTR_T}
-appropriately.
+Note that @code{uintptr_t} is an optional C99 type for which a
+substitute is defined in @R{}, so your code needs to define
+@code{HAVE_UINTPTR_T} appropriately.  To do so, test if the type is
+defined in C header @file{stdint.h} or C++ header @file{cstdint} and if
+so include the header and define @code{HAVE_UINTPTR_T} before including
+@file{Rinterface.h}.
 
 These will be set@footnote{at least on platforms where the values are
 available, that is having @code{getrlimit} and on Linux or having
@@ -14349,11 +14782,6 @@
 use its value for @code{InstallPath}.
 @end itemize
 
-Prior to @R{} 2.12.0 @file{R.dll} and the various front-end executables
-were in @file{R_HOME\bin}, but they are now in @file{R_HOME\bin\i386} or
-@file{R_HOME\bin\x64}.  So you may need to arrange to look first in the
-architecture-specific subdirectory and then in @file{R_HOME\bin}.
-
 @node Function and variable index, Concept index, Linking GUIs and other front-ends to R, Top
 @unnumbered Function and variable index
 
diff -ubr R-3.3.2/doc/manual/R-intro.R R-patched/doc/manual/R-intro.R
--- R-3.3.2/doc/manual/R-intro.R	2016-09-13 15:15:07.000000000 -0700
+++ R-patched/doc/manual/R-intro.R	2017-01-30 15:15:14.000000000 -0800
@@ -195,8 +195,7 @@
 
 d <- outer(0:9, 0:9)
 fr <- table(outer(d, d, "-"))
-plot(as.numeric(names(fr)), fr, type="h",
-     xlab="Determinant", ylab="Frequency")
+plot(fr, xlab="Determinant", ylab="Frequency")
 
 ##
 
diff -ubr R-3.3.2/doc/manual/R-intro.texi R-patched/doc/manual/R-intro.texi
--- R-3.3.2/doc/manual/R-intro.texi	2016-10-04 02:15:05.000000000 -0700
+++ R-patched/doc/manual/R-intro.texi	2017-02-02 15:15:07.000000000 -0800
@@ -1922,13 +1922,12 @@
 @example
 > d <- outer(0:9, 0:9)
 > fr <- table(outer(d, d, "-"))
-> plot(as.numeric(names(fr)), fr, type="h",
-       xlab="Determinant", ylab="Frequency")
+> plot(fr, xlab="Determinant", ylab="Frequency")
 @end example
 
-Notice the coercion of the @code{names} attribute of the frequency table
-to numeric in order to recover the range of the determinant values.  The
-``obvious'' way of doing this problem with @code{for} loops, to be
+Notice that @code{plot()} here uses a histogram like plot method, because
+it ``sees'' that @code{fr} is of class @code{"table"}.
+The ``obvious'' way of doing this problem with @code{for} loops, to be
 discussed in @ref{Loops and conditional execution}, is so inefficient as
 to be impractical.
 
@@ -3377,7 +3376,7 @@
 @var{@dots{}}; @var{expr_m}@}}, in which case the value of the group
 is the result of the last expression in the group evaluated.  Since such
 a group is also an expression it may, for example, be itself included in
-parentheses and used a part of an even larger expression, and so on.
+parentheses and used as part of an even larger expression, and so on.
 
 @node Control statements,  , Grouped expressions, Loops and conditional execution
 @section Control statements
@@ -6676,7 +6675,7 @@
 
 File @emph{permissions} are a related topic.  @R{} has support for the
 POSIX concepts of read/write/execute permission for owner/group/all but
-this may be only partially supported on the filesystem (so for example
+this may be only partially supported on the filesystem, so for example
 on Windows only read-only files (for the account running the @R{}
 session) are recognized.  Access Control Lists (ACLs) are employed on
 several filesystems, but do not have an agreed standard and @R{} has no
diff -ubr R-3.3.2/doc/manual/R-ints.texi R-patched/doc/manual/R-ints.texi
--- R-3.3.2/doc/manual/R-ints.texi	2016-09-14 15:15:08.000000000 -0700
+++ R-patched/doc/manual/R-ints.texi	2017-02-02 15:15:07.000000000 -0800
@@ -1051,7 +1051,7 @@
 
 `Special' primitive and internal functions evaluate their arguments
 internally @emph{after} @code{R_Visible} has been set, and evaluation of
-the arguments (e.g.@: an assignment as in PR#9263)) can change the value
+the arguments (e.g.@: an assignment as in PR#9263) can change the value
 of the flag.
 
 The @code{R_Visible} flag can also get altered during the evaluation of
@@ -2261,7 +2261,7 @@
 @noindent
 ).  One could argue about @code{~}, but it is known to the parser and has
 semantics quite unlike a normal function.  And @code{:} is documented
-with different argument names in its two meanings.)
+with different argument names in its two meanings.
 
 The QC functions @code{codoc} and @code{checkS3methods} also make use of
 these environments (effectively placing them in front of base in the
@@ -2651,7 +2651,7 @@
 roots for each physical or logical file system (`volume'), organized
 under @emph{drives} (with file paths starting @code{D:} for an
 @acronym{ASCII} letter, case-insensitively) and @emph{network shares}
-(with paths like @code{\netname\topdir\myfiles\a file}.  There is a
+(with paths like @code{\netname\topdir\myfiles\a file}).  There is a
 current drive, and path names without a drive part are relative to the
 current drive.  Further, each drive has a current directory, and
 relative paths are relative to that current directory, on a particular
@@ -4091,6 +4091,11 @@
 base/recommended packages which are overwritten when this package's
 namespace is loaded. 
 Default: false (but true for CRAN submission checks).
+
+@item _R_CHECK_TESTS_NLINES_
+Number of trailing lines of test output to reproduce in the log.  If
+@code{0} all lines except the @R{} preamble are reproduced.
+Default: 13.
 @end vtable
 
 CRAN's submission checks use something like
@@ -4279,7 +4284,7 @@
 @node Use of TeX dialects, Current and future directions, Testing R code, Top
 @chapter Use of TeX dialects
 
-Various dialects of TeX and used for different purposes in @R{}.  The
+Various dialects of TeX are used for different purposes in @R{}.  The
 policy is that manuals be written in @samp{texinfo}, and for convenience
 the main and Windows FAQs are also.  This has the advantage that is is
 easy to produce @HTML{} and plain text versions as well as typeset manuals.
diff -ubr R-3.3.2/doc/manual/R-lang.texi R-patched/doc/manual/R-lang.texi
--- R-3.3.2/doc/manual/R-lang.texi	2016-02-26 15:15:07.000000000 -0800
+++ R-patched/doc/manual/R-lang.texi	2017-02-02 15:15:07.000000000 -0800
@@ -1840,7 +1840,7 @@
 
 The most important example of a class method for @code{[} is that used
 for data frames.  It is not described in detail here (see the help
-page for @code{[.data.frame}, but in broad terms, if two indices are
+page for @code{[.data.frame}), but in broad terms, if two indices are
 supplied (even if one is empty) it creates matrix-like indexing for a
 structure that is basically a list of vectors of the same length.  If a
 single index is supplied, it is interpreted as indexing the list of
diff -ubr R-3.3.2/m4/R.m4 R-patched/m4/R.m4
--- R-3.3.2/m4/R.m4	2016-09-14 15:15:37.000000000 -0700
+++ R-patched/m4/R.m4	2017-01-05 15:15:05.000000000 -0800
@@ -3113,10 +3113,11 @@
 #include <string.h>
 #include <zlib.h>
 int main() {
-#ifdef ZLIB_VERSION
-/* Work around Debian bug: it uses 1.2.3.4 even though there was no such
-   version on the master site zlib.net */
-  exit(strncmp(ZLIB_VERSION, "1.2.5", 5) < 0);
+#ifdef ZLIB_VERNUM
+  if (ZLIB_VERNUM < 0x1250) {
+    exit(1);
+  }
+  exit(0);
 #else
   exit(1);
 #endif
diff -ubr R-3.3.2/share/texmf/bibtex/bib/RJournal.bib R-patched/share/texmf/bibtex/bib/RJournal.bib
--- R-3.3.2/share/texmf/bibtex/bib/RJournal.bib	2016-10-30 16:15:08.000000000 -0700
+++ R-patched/share/texmf/bibtex/bib/RJournal.bib	2017-02-15 15:15:22.000000000 -0800
@@ -32,8 +32,8 @@
 
 
 
-@Article{nolting-moore-stieha-etal:,
-  author       = {Ben C. Nolting and Christopher M. Moore and Christopher R. Stieha and Maria K. Cameron and Karen C. Abbott}, 
+@Article{moore-stieha-nolting-etal:,
+  author       = {Christopher M. Moore and Christopher R. Stieha and Ben C. Nolting and Maria K. Cameron and Karen C. Abbott}, 
   title        = {QPot: An R Package for Stochastic Differential Equation Quasi-Potential Analysis}, 
   journal      = {The R Journal},
   year         = ,
@@ -41,7 +41,7 @@
   number       = ,
   pages        = {},  
   month        = ,
-  url          = {http://journal.r-project.org/archive/-/nolting-moore-stieha-etal.pdf}
+  url          = {http://journal.r-project.org/archive/-/moore-stieha-nolting-etal.pdf}
 }
 
 
@@ -131,7 +131,7 @@
 
 
 @Article{tang-horikoshi-li:,
-  author       = {Yuan Tang and Massaki Horikoshi and Wenxuan Li}, 
+  author       = {Yuan Tang and Masaaki Horikoshi and Wenxuan Li}, 
   title        = {ggfortify: Unified Interface to Visualize Statistical Result of Popular R Packages}, 
   journal      = {The R Journal},
   year         = ,
@@ -228,6 +228,272 @@
 
 
 
+@Article{schloerke-wickham-cook-etal:,
+  author       = {Barret Schloerke and Hadley Wickham and Dianne Cook and and Heike Hofmann}, 
+  title        = {Escape from Boxland: Generating a Library of High-Dimensional Geometric Shapes}, 
+  journal      = {The R Journal},
+  year         = ,
+  volume       = ,
+  number       = ,
+  pages        = {},  
+  month        = ,
+  url          = {http://journal.r-project.org/archive/-/schloerke-wickham-cook-etal.pdf}
+}
+
+
+
+@Article{sachs-gabriel:,
+  author       = {Michael C Sachs and Erin E Gabriel}, 
+  title        = {An Introduction to Principal Surrogate Evaluation with the pseval Package}, 
+  journal      = {The R Journal},
+  year         = ,
+  volume       = ,
+  number       = ,
+  pages        = {},  
+  month        = ,
+  url          = {http://journal.r-project.org/archive/-/sachs-gabriel.pdf}
+}
+
+
+
+@Article{fachada-rodrigues-lopes-etal:,
+  author       = {Nuno Fachada and Joรฃo Rodrigues and Vitor V. Lopes and Rui C. Martins and Agostinho C. Rosa}, 
+  title        = {micompr: An R Package for Multivariate Independent Comparison of Observations}, 
+  journal      = {The R Journal},
+  year         = ,
+  volume       = ,
+  number       = ,
+  pages        = {},  
+  month        = ,
+  url          = {http://journal.r-project.org/archive/-/fachada-rodrigues-lopes-etal.pdf}
+}
+
+
+
+@Article{koitka-friedrich:,
+  author       = {Sven Koitka and Christoph M. Friedrich}, 
+  title        = {nmfgpu4R: GPU-Accelerated Computation of the Non-Negative Matrix Factorization (NMF) Using CUDA Capable Hardware}, 
+  journal      = {The R Journal},
+  year         = ,
+  volume       = ,
+  number       = ,
+  pages        = {},  
+  month        = ,
+  url          = {http://journal.r-project.org/archive/-/koitka-friedrich.pdf}
+}
+
+
+
+@Article{lipsitz-belloni-chernozhukov-etal:,
+  author       = {Michael Lipsitz and Alexandre Belloni and Victor Chernozhukov and Ivan Fernandez-Val}, 
+  title        = {quantreg.nonpar: An R Package for Performing Nonparametric Series Quantile Regression}, 
+  journal      = {The R Journal},
+  year         = ,
+  volume       = ,
+  number       = ,
+  pages        = {},  
+  month        = ,
+  url          = {http://journal.r-project.org/archive/-/lipsitz-belloni-chernozhukov-etal.pdf}
+}
+
+
+
+@Article{geraci:,
+  author       = {Marco Geraci}, 
+  title        = {Qtools: A Collection of Models and Tools for Quantile Inference}, 
+  journal      = {The R Journal},
+  year         = ,
+  volume       = ,
+  number       = ,
+  pages        = {},  
+  month        = ,
+  url          = {http://journal.r-project.org/archive/-/geraci.pdf}
+}
+
+
+
+@Article{imdadullah-aslam-altaf:,
+  author       = {Muhammad Imdadullah and Muhammad Aslam and Saima Altaf}, 
+  title        = {mctest: An R Package for Detection of Collinearity Among Regressors}, 
+  journal      = {The R Journal},
+  year         = ,
+  volume       = ,
+  number       = ,
+  pages        = {},  
+  month        = ,
+  url          = {http://journal.r-project.org/archive/-/imdadullah-aslam-altaf.pdf}
+}
+
+
+
+@Article{some-wansouwe-kokonendji:,
+  author       = {Sobom M. Somรฉ and Wanbitching E. Wansouwรฉ and Cรฉlestin C. Kokonendji}, 
+  title        = {Ake: An R Package for Discrete and Continuous Associated Kernel Estimations}, 
+  journal      = {The R Journal},
+  year         = ,
+  volume       = ,
+  number       = ,
+  pages        = {},  
+  month        = ,
+  url          = {http://journal.r-project.org/archive/-/some-wansouwe-kokonendji.pdf}
+}
+
+
+
+@Article{pebesma-mailund-hiebert:,
+  author       = {Edzer Pebesma and Thomas Mailund and James Hiebert}, 
+  title        = {Measurement units in R}, 
+  journal      = {The R Journal},
+  year         = ,
+  volume       = ,
+  number       = ,
+  pages        = {},  
+  month        = ,
+  url          = {http://journal.r-project.org/archive/-/pebesma-mailund-hiebert.pdf}
+}
+
+
+
+@Article{guevara-hartmann-mendoza:,
+  author       = {Miguel R. Guevara and Dominik Hartmann and Marcelo Mendoza}, 
+  title        = {diverse: an R Package to Measure Diversity in Complex Systems}, 
+  journal      = {The R Journal},
+  year         = ,
+  volume       = ,
+  number       = ,
+  pages        = {},  
+  month        = ,
+  url          = {http://journal.r-project.org/archive/-/guevara-hartmann-mendoza.pdf}
+}
+
+
+
+@Article{olmedo-ortegafarias-delafuentesaiz-etal:,
+  author       = {Guillermo Federico Olmedo and Samuel Ortega-Farรญas and Daniel de la Fuente-Sรกiz and David Fonseca-Luengo and Fernando Fuentes-Peรฑailillo}, 
+  title        = {water: Tools and Functions to estimate Actual Evapotranspiration using Land Surface Energy Balance Models in R}, 
+  journal      = {The R Journal},
+  year         = ,
+  volume       = ,
+  number       = ,
+  pages        = {},  
+  month        = ,
+  url          = {http://journal.r-project.org/archive/-/olmedo-ortegafarias-delafuentesaiz-etal.pdf}
+}
+
+
+
+@Article{goksuluk-korkmaz-zararsiz-etal:,
+  author       = {Dincer Goksuluk and Selcuk Korkmaz and Gokmen Zararsiz and Ergun Karaagaoglu}, 
+  title        = {easyROC: An Interactive Web-tool for ROC Curve Analysis Using R Language Environment}, 
+  journal      = {The R Journal},
+  year         = ,
+  volume       = ,
+  number       = ,
+  pages        = {},  
+  month        = ,
+  url          = {http://journal.r-project.org/archive/-/goksuluk-korkmaz-zararsiz-etal.pdf}
+}
+
+
+
+@Article{moore-stieha-nolting-etal:,
+  author       = { "Christopher M. Moore"}, 
+  title        = {QPot: An R Package for Stochastic Differential Equation Quasi-Potential Analysis}, 
+  journal      = {The R Journal},
+  year         = ,
+  volume       = ,
+  number       = ,
+  pages        = {},  
+  month        = ,
+  url          = {http://journal.r-project.org/archive/-/moore-stieha-nolting-etal.pdf}
+}
+
+
+
+@Article{young:,
+  author       = {Derek Young}, 
+  title        = {Normal Tolerance Interval Procedures in the tolerance Package}, 
+  journal      = {The R Journal},
+  year         = ,
+  volume       = ,
+  number       = ,
+  pages        = {},  
+  month        = ,
+  url          = {http://journal.r-project.org/archive/-/young.pdf}
+}
+
+
+
+@Article{vitolo-fry-buytaert:,
+  author       = {Claudia Vitolo and Matthew Fry and Wouter Buytaert}, 
+  title        = {RNRFA: an R package to retrieve, filter and visualize data from the UK National River Flow Archive}, 
+  journal      = {The R Journal},
+  year         = ,
+  volume       = ,
+  number       = ,
+  pages        = {},  
+  month        = ,
+  url          = {http://journal.r-project.org/archive/-/vitolo-fry-buytaert.pdf}
+}
+
+
+
+@Article{meiramachado-sestelo:,
+  author       = {Luis Meira-Machado and Marta Sestelo}, 
+  title        = {condSURV: An R Package for the Estimation of the Conditional Survival Function for Ordered Multivariate Failure Time Data}, 
+  journal      = {The R Journal},
+  year         = ,
+  volume       = ,
+  number       = ,
+  pages        = {},  
+  month        = ,
+  url          = {http://journal.r-project.org/archive/-/meiramachado-sestelo.pdf}
+}
+
+
+
+@Article{roocks:,
+  author       = {Patrick Roocks}, 
+  title        = {Computing Pareto Frontiers and Database Preferences with the rPref Package}, 
+  journal      = {The R Journal},
+  year         = ,
+  volume       = ,
+  number       = ,
+  pages        = {},  
+  month        = ,
+  url          = {http://journal.r-project.org/archive/-/roocks.pdf}
+}
+
+
+
+@Article{sola-irigoien-mestres-etal:,
+  author       = {Concepcion Arenas Sola and Itziar Irigoien and Francesc Mestres and Concepciรณn Arenas}, 
+  title        = {Weighted Distance Based Discriminant Analysis: The R package  WeDiBaDis}, 
+  journal      = {The R Journal},
+  year         = ,
+  volume       = ,
+  number       = ,
+  pages        = {},  
+  month        = ,
+  url          = {http://journal.r-project.org/archive/-/sola-irigoien-mestres-etal.pdf}
+}
+
+
+
+@Article{sola-irigoien-mestres-etal:,
+  author       = {Concepcion Arenas Sola and Itziar Irigoien and Francesc Mestres and Concepciรณn Arenas}, 
+  title        = {Weighted Distance Based Discriminant Analysis: The R package  WeDiBaDis}, 
+  journal      = {The R Journal},
+  year         = ,
+  volume       = ,
+  number       = ,
+  pages        = {},  
+  month        = ,
+  url          = {http://journal.r-project.org/archive/-/sola-irigoien-mestres-etal.pdf}
+}
+
+
+
 @Article{RJournal:2009-1:Chambers,
   author       = {John M. Chambers}, 
   title        = {Facets of {R}}, 
diff -ubr R-3.3.2/src/appl/optim.c R-patched/src/appl/optim.c
--- R-3.3.2/src/appl/optim.c	2015-08-25 15:19:01.000000000 -0700
+++ R-patched/src/appl/optim.c	2016-12-28 15:15:07.000000000 -0800
@@ -279,7 +279,7 @@
     double oldsize;
     double **P;
     double size, step, temp, trystep;
-    char tstr[9]; // allow for 10^8 iters ...
+    char tstr[12]; // allow for 10^8 iters and pacify gcc7
     double VH, VL, VR;
 
     if (maxit <= 0) {
@@ -368,7 +368,7 @@
 
 	    // avoid buffer overflow at 100001 iters. (PR#15240)
 	    if (trace) {
-		snprintf(tstr, 9, "%5d", funcount);
+		snprintf(tstr, 12, "%5d", funcount);
 		Rprintf("%s%s %f %f\n", action, tstr, VH, VL);
 	    }
 
diff -ubr R-3.3.2/src/extra/tzone/Make.zi R-patched/src/extra/tzone/Make.zi
--- R-3.3.2/src/extra/tzone/Make.zi	2016-04-19 15:15:05.000000000 -0700
+++ R-patched/src/extra/tzone/Make.zi	2016-11-07 15:15:08.000000000 -0800
@@ -1,6 +1,6 @@
 ## Makefile to be run on a Unix box with zic
 
-VERSION = 2016d
+VERSION = 2016i
 TZDIR = zoneinfo
 TZTMP = tz
 TARFILE = tzdata$(VERSION).tar.gz
diff -ubr R-3.3.2/src/extra/tzone/Notes R-patched/src/extra/tzone/Notes
--- R-3.3.2/src/extra/tzone/Notes	2016-09-14 15:15:24.000000000 -0700
+++ R-patched/src/extra/tzone/Notes	2016-11-07 15:15:08.000000000 -0800
@@ -22,11 +22,11 @@
 To remake it, download the current version of tzdataXXXXx.tar.gz from
 http://www.iana.org/time-zones to this directory and run
 
-make -f Make.zi VERSION=2016d
+make -f Make.zi VERSION=2016i
 
 for the appropriate version.  If zic is not on the path, use something like
 
-make -f Make.zi VERSION=2016d ZIC=/usr/sbin/zic
+make -f Make.zi VERSION=2016i ZIC=/usr/sbin/zic
 
 NB: it seems that this needs to be done on a system with 64-bit time_t
 or the catalogs will be confined to 1902-2038.  And even that did not
Binary files R-3.3.2/src/extra/tzone/zoneinfo.zip and R-patched/src/extra/tzone/zoneinfo.zip differ
diff -ubr R-3.3.2/src/include/GraphicsBase.h R-patched/src/include/GraphicsBase.h
--- R-3.3.2/src/include/GraphicsBase.h	2015-08-25 15:15:17.000000000 -0700
+++ R-patched/src/include/GraphicsBase.h	2016-11-14 15:15:11.000000000 -0800
@@ -2,11 +2,15 @@
  *  R : A Computer Language for Statistical Data Analysis
  *  Copyright (C) 2001-8 The R Core Team.
  *
- *  This program is free software; you can redistribute it and/or modify
+ *  This header file is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU Lesser General Public License as published by
  *  the Free Software Foundation; either version 2.1 of the License, or
  *  (at your option) any later version.
  *
+ *  This file is part of R. R is distributed under the terms of the
+ *  GNU General Public License, either Version 2, June 1991 or Version 3,
+ *  June 2007. See doc/COPYRIGHTS for details of the copyright status of R.
+ *
  *  This program is distributed in the hope that it will be useful,
  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
diff -ubr R-3.3.2/src/include/R.h R-patched/src/include/R.h
--- R-3.3.2/src/include/R.h	2016-10-04 02:14:57.000000000 -0700
+++ R-patched/src/include/R.h	2016-11-14 15:15:12.000000000 -0800
@@ -2,11 +2,15 @@
  *  R : A Computer Language for Statistical Data Analysis
  *  Copyright (C) 2000-2016 The R Core Team.
  *
- *  This program is free software; you can redistribute it and/or modify
+ *  This header file is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU Lesser General Public License as published by
  *  the Free Software Foundation; either version 2.1 of the License, or
  *  (at your option) any later version.
  *
+ *  This file is part of R. R is distributed under the terms of the
+ *  GNU General Public License, either Version 2, June 1991 or Version 3,
+ *  June 2007. See doc/COPYRIGHTS for details of the copyright status of R.
+ *  
  *  This program is distributed in the hope that it will be useful,
  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
diff -ubr R-3.3.2/src/include/R_ext/Applic.h R-patched/src/include/R_ext/Applic.h
--- R-3.3.2/src/include/R_ext/Applic.h	2016-03-16 16:02:15.000000000 -0700
+++ R-patched/src/include/R_ext/Applic.h	2016-11-14 15:15:12.000000000 -0800
@@ -2,11 +2,15 @@
  *  R : A Computer Language for Statistical Data Analysis
  *  Copyright (C) 1998-2015   The R Core Team
  *
- *  This program is free software; you can redistribute it and/or modify
+ *  This header file is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU Lesser General Public License as published by
  *  the Free Software Foundation; either version 2.1 of the License, or
  *  (at your option) any later version.
  *
+ *  This file is part of R. R is distributed under the terms of the
+ *  GNU General Public License, either Version 2, June 1991 or Version 3,
+ *  June 2007. See doc/COPYRIGHTS for details of the copyright status of R.
+ *
  *  This program is distributed in the hope that it will be useful,
  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
diff -ubr R-3.3.2/src/include/R_ext/Arith.h R-patched/src/include/R_ext/Arith.h
--- R-3.3.2/src/include/R_ext/Arith.h	2016-10-04 02:14:57.000000000 -0700
+++ R-patched/src/include/R_ext/Arith.h	2016-11-14 15:15:12.000000000 -0800
@@ -3,11 +3,15 @@
  *  Copyright (C) 1995, 1996  Robert Gentleman and Ross Ihaka
  *  Copyright (C) 1998--2016  The R Core Team.
  *
- *  This program is free software; you can redistribute it and/or modify
+ *  This header file is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU Lesser General Public License as published by
  *  the Free Software Foundation; either version 2.1 of the License, or
  *  (at your option) any later version.
  *
+ *  This file is part of R. R is distributed under the terms of the
+ *  GNU General Public License, either Version 2, June 1991 or Version 3,
+ *  June 2007. See doc/COPYRIGHTS for details of the copyright status of R.
+ *
  *  This program is distributed in the hope that it will be useful,
  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
diff -ubr R-3.3.2/src/include/R_ext/BLAS.h R-patched/src/include/R_ext/BLAS.h
--- R-3.3.2/src/include/R_ext/BLAS.h	2015-08-25 15:15:19.000000000 -0700
+++ R-patched/src/include/R_ext/BLAS.h	2016-11-14 15:15:12.000000000 -0800
@@ -2,11 +2,15 @@
  *  R : A Computer Language for Statistical Data Analysis
  *  Copyright (C) 2003-12 The R Core Team.
  *
- *  This program is free software; you can redistribute it and/or modify
+ *  This header file is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU Lesser General Public License as published by
  *  the Free Software Foundation; either version 2.1 of the License, or
  *  (at your option) any later version.
  *
+ *  This file is part of R. R is distributed under the terms of the
+ *  GNU General Public License, either Version 2, June 1991 or Version 3,
+ *  June 2007. See doc/COPYRIGHTS for details of the copyright status of R.
+ *
  *  This program is distributed in the hope that it will be useful,
  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
diff -ubr R-3.3.2/src/include/R_ext/Boolean.h R-patched/src/include/R_ext/Boolean.h
--- R-3.3.2/src/include/R_ext/Boolean.h	2015-08-25 15:15:19.000000000 -0700
+++ R-patched/src/include/R_ext/Boolean.h	2016-11-14 15:15:12.000000000 -0800
@@ -2,11 +2,15 @@
  *  R : A Computer Language for Statistical Data Analysis
  *  Copyright (C) 2000, 2001 The R Core Team.
  *
- *  This program is free software; you can redistribute it and/or modify
+ *  This header file is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU Lesser General Public License as published by
  *  the Free Software Foundation; either version 2.1 of the License, or
  *  (at your option) any later version.
  *
+ *  This file is part of R. R is distributed under the terms of the
+ *  GNU General Public License, either Version 2, June 1991 or Version 3,
+ *  June 2007. See doc/COPYRIGHTS for details of the copyright status of R.
+ *
  *  This program is distributed in the hope that it will be useful,
  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
diff -ubr R-3.3.2/src/include/R_ext/Callbacks.h R-patched/src/include/R_ext/Callbacks.h
--- R-3.3.2/src/include/R_ext/Callbacks.h	2016-03-02 15:02:03.000000000 -0800
+++ R-patched/src/include/R_ext/Callbacks.h	2016-11-14 15:15:12.000000000 -0800
@@ -2,11 +2,15 @@
  *  R : A Computer Language for Statistical Data Analysis
  *  Copyright (C) 2001-2016 The R Core Team.
  *
- *  This program is free software; you can redistribute it and/or modify
+ *  This header file is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU Lesser General Public License as published by
  *  the Free Software Foundation; either version 2.1 of the License, or
  *  (at your option) any later version.
  *
+ *  This file is part of R. R is distributed under the terms of the
+ *  GNU General Public License, either Version 2, June 1991 or Version 3,
+ *  June 2007. See doc/COPYRIGHTS for details of the copyright status of R.
+ *
  *  This program is distributed in the hope that it will be useful,
  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
diff -ubr R-3.3.2/src/include/R_ext/Complex.h R-patched/src/include/R_ext/Complex.h
--- R-3.3.2/src/include/R_ext/Complex.h	2015-08-25 15:15:20.000000000 -0700
+++ R-patched/src/include/R_ext/Complex.h	2016-11-14 15:15:12.000000000 -0800
@@ -2,11 +2,15 @@
  *  R : A Computer Language for Statistical Data Analysis
  *  Copyright (C) 1998-2001   The R Core Team
  *
- *  This program is free software; you can redistribute it and/or modify
+ *  This header file is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU Lesser General Public License as published by
  *  the Free Software Foundation; either version 2.1 of the License, or
  *  (at your option) any later version.
  *
+ *  This file is part of R. R is distributed under the terms of the
+ *  GNU General Public License, either Version 2, June 1991 or Version 3,
+ *  June 2007. See doc/COPYRIGHTS for details of the copyright status of R.
+ *
  *  This program is distributed in the hope that it will be useful,
  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
diff -ubr R-3.3.2/src/include/R_ext/Constants.h R-patched/src/include/R_ext/Constants.h
--- R-3.3.2/src/include/R_ext/Constants.h	2015-08-25 15:15:20.000000000 -0700
+++ R-patched/src/include/R_ext/Constants.h	2016-11-14 15:15:12.000000000 -0800
@@ -3,11 +3,15 @@
  *  Copyright (C) 1995, 1996  Robert Gentleman and Ross Ihaka
  *  Copyright (C) 1998-2012   The R Core Team.
  *
- *  This program is free software; you can redistribute it and/or modify
+ *  This header file is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU Lesser General Public License as published by
  *  the Free Software Foundation; either version 2.1 of the License, or
  *  (at your option) any later version.
  *
+ *  This file is part of R. R is distributed under the terms of the
+ *  GNU General Public License, either Version 2, June 1991 or Version 3,
+ *  June 2007. See doc/COPYRIGHTS for details of the copyright status of R.
+ *
  *  This program is distributed in the hope that it will be useful,
  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
diff -ubr R-3.3.2/src/include/R_ext/Error.h R-patched/src/include/R_ext/Error.h
--- R-3.3.2/src/include/R_ext/Error.h	2015-08-25 15:15:17.000000000 -0700
+++ R-patched/src/include/R_ext/Error.h	2016-11-14 15:15:12.000000000 -0800
@@ -2,11 +2,15 @@
  *  R : A Computer Language for Statistical Data Analysis
  *  Copyright (C) 1998-2005   The R Core Team
  *
- *  This program is free software; you can redistribute it and/or modify
+ *  This header file is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU Lesser General Public License as published by
  *  the Free Software Foundation; either version 2.1 of the License, or
  *  (at your option) any later version.
  *
+ *  This file is part of R. R is distributed under the terms of the
+ *  GNU General Public License, either Version 2, June 1991 or Version 3,
+ *  June 2007. See doc/COPYRIGHTS for details of the copyright status of R.
+ *
  *  This program is distributed in the hope that it will be useful,
  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
diff -ubr R-3.3.2/src/include/R_ext/GraphicsDevice.h R-patched/src/include/R_ext/GraphicsDevice.h
--- R-3.3.2/src/include/R_ext/GraphicsDevice.h	2015-08-25 15:15:19.000000000 -0700
+++ R-patched/src/include/R_ext/GraphicsDevice.h	2016-11-14 15:15:12.000000000 -0800
@@ -2,11 +2,15 @@
  *  R : A Computer Language for Statistical Data Analysis
  *  Copyright (C) 2001-11 The R Core Team.
  *
- *  This program is free software; you can redistribute it and/or modify
+ *  This header file is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU Lesser General Public License as published by
  *  the Free Software Foundation; either version 2.1 of the License, or
  *  (at your option) any later version.
  *
+ *  This file is part of R. R is distributed under the terms of the
+ *  GNU General Public License, either Version 2, June 1991 or Version 3,
+ *  June 2007. See doc/COPYRIGHTS for details of the copyright status of R.
+ *
  *  This program is distributed in the hope that it will be useful,
  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
diff -ubr R-3.3.2/src/include/R_ext/GraphicsEngine.h R-patched/src/include/R_ext/GraphicsEngine.h
--- R-3.3.2/src/include/R_ext/GraphicsEngine.h	2016-03-16 16:02:15.000000000 -0700
+++ R-patched/src/include/R_ext/GraphicsEngine.h	2016-11-14 15:15:12.000000000 -0800
@@ -2,11 +2,15 @@
  *  R : A Computer Language for Statistical Data Analysis
  *  Copyright (C) 2001-11 The R Core Team.
  *
- *  This program is free software; you can redistribute it and/or modify
+ *  This header file is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU Lesser General Public License as published by
  *  the Free Software Foundation; either version 2.1 of the License, or
  *  (at your option) any later version.
  *
+ *  This file is part of R. R is distributed under the terms of the
+ *  GNU General Public License, either Version 2, June 1991 or Version 3,
+ *  June 2007. See doc/COPYRIGHTS for details of the copyright status of R.
+ *
  *  This program is distributed in the hope that it will be useful,
  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
diff -ubr R-3.3.2/src/include/R_ext/Itermacros.h R-patched/src/include/R_ext/Itermacros.h
--- R-3.3.2/src/include/R_ext/Itermacros.h	2016-03-16 16:02:15.000000000 -0700
+++ R-patched/src/include/R_ext/Itermacros.h	2016-11-14 15:15:12.000000000 -0800
@@ -2,11 +2,15 @@
  *  R : A Computer Language for Statistical Data Analysis
  *  Copyright (C) 2001-12  The R Core Team.
  *
- *  This program is free software; you can redistribute it and/or modify
+ *  This header file is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU Lesser General Public License as published by
  *  the Free Software Foundation; either version 2.1 of the License, or
  *  (at your option) any later version.
  *
+ *  This file is part of R. R is distributed under the terms of the
+ *  GNU General Public License, either Version 2, June 1991 or Version 3,
+ *  June 2007. See doc/COPYRIGHTS for details of the copyright status of R.
+ *
  *  This program is distributed in the hope that it will be useful,
  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
diff -ubr R-3.3.2/src/include/R_ext/Lapack.h R-patched/src/include/R_ext/Lapack.h
--- R-3.3.2/src/include/R_ext/Lapack.h	2016-03-16 16:02:15.000000000 -0700
+++ R-patched/src/include/R_ext/Lapack.h	2016-11-14 15:15:12.000000000 -0800
@@ -3,11 +3,15 @@
  *  Copyright (C) 2003-2016 The R Core Team.
  *  Copyright (C) 2008   The R Foundation
  *
- *  This program is free software; you can redistribute it and/or modify
+ *  This header file is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU Lesser General Public License as published by
  *  the Free Software Foundation; either version 2.1 of the License, or
  *  (at your option) any later version.
  *
+ *  This file is part of R. R is distributed under the terms of the
+ *  GNU General Public License, either Version 2, June 1991 or Version 3,
+ *  June 2007. See doc/COPYRIGHTS for details of the copyright status of R.
+ *
  *  This program is distributed in the hope that it will be useful,
  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
diff -ubr R-3.3.2/src/include/R_ext/Linpack.h R-patched/src/include/R_ext/Linpack.h
--- R-3.3.2/src/include/R_ext/Linpack.h	2015-08-25 15:15:19.000000000 -0700
+++ R-patched/src/include/R_ext/Linpack.h	2016-11-14 15:15:12.000000000 -0800
@@ -3,11 +3,15 @@
  *  Copyright (C) 1997        Robert Gentleman and Ross Ihaka
  *  Copyright (C) 1999-2015   The R Core Team.
  *
- *  This program is free software; you can redistribute it and/or modify
+ *  This header file is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU Lesser General Public License as published by
  *  the Free Software Foundation; either version 2.1 of the License, or
  *  (at your option) any later version.
  *
+ *  This file is part of R. R is distributed under the terms of the
+ *  GNU General Public License, either Version 2, June 1991 or Version 3,
+ *  June 2007. See doc/COPYRIGHTS for details of the copyright status of R.
+ *
  *  This program is distributed in the hope that it will be useful,
  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
diff -ubr R-3.3.2/src/include/R_ext/MathThreads.h R-patched/src/include/R_ext/MathThreads.h
--- R-3.3.2/src/include/R_ext/MathThreads.h	2015-08-25 15:15:20.000000000 -0700
+++ R-patched/src/include/R_ext/MathThreads.h	2016-11-14 15:15:12.000000000 -0800
@@ -2,11 +2,15 @@
  *  R : A Computer Language for Statistical Data Analysis
  *  Copyright (C) 2000-2014 The R Core Team.
  *
- *  This program is free software; you can redistribute it and/or modify
+ *  This header file is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU Lesser General Public License as published by
  *  the Free Software Foundation; either version 2.1 of the License, or
  *  (at your option) any later version.
  *
+ *  This file is part of R. R is distributed under the terms of the
+ *  GNU General Public License, either Version 2, June 1991 or Version 3,
+ *  June 2007. See doc/COPYRIGHTS for details of the copyright status of R.
+ *
  *  This program is distributed in the hope that it will be useful,
  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
diff -ubr R-3.3.2/src/include/R_ext/Memory.h R-patched/src/include/R_ext/Memory.h
--- R-3.3.2/src/include/R_ext/Memory.h	2016-10-04 02:14:57.000000000 -0700
+++ R-patched/src/include/R_ext/Memory.h	2016-11-14 15:15:12.000000000 -0800
@@ -2,11 +2,15 @@
  *  R : A Computer Language for Statistical Data Analysis
  *  Copyright (C) 1998-2016  The R Core Team
  *
- *  This program is free software; you can redistribute it and/or modify
+ *  This header file is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU Lesser General Public License as published by
  *  the Free Software Foundation; either version 2.1 of the License, or
  *  (at your option) any later version.
  *
+ *  This file is part of R. R is distributed under the terms of the
+ *  GNU General Public License, either Version 2, June 1991 or Version 3,
+ *  June 2007. See doc/COPYRIGHTS for details of the copyright status of R.
+ *
  *  This program is distributed in the hope that it will be useful,
  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
diff -ubr R-3.3.2/src/include/R_ext/Print.h R-patched/src/include/R_ext/Print.h
--- R-3.3.2/src/include/R_ext/Print.h	2015-08-25 15:15:19.000000000 -0700
+++ R-patched/src/include/R_ext/Print.h	2016-11-14 15:15:12.000000000 -0800
@@ -2,11 +2,15 @@
  *  R : A Computer Language for Statistical Data Analysis
  *  Copyright (C) 1998-2010    The R Core Team
  *
- *  This program is free software; you can redistribute it and/or modify
+ *  This header file is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU Lesser General Public License as published by
  *  the Free Software Foundation; either version 2.1 of the License, or
  *  (at your option) any later version.
  *
+ *  This file is part of R. R is distributed under the terms of the
+ *  GNU General Public License, either Version 2, June 1991 or Version 3,
+ *  June 2007. See doc/COPYRIGHTS for details of the copyright status of R.
+ *
  *  This program is distributed in the hope that it will be useful,
  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
diff -ubr R-3.3.2/src/include/R_ext/PrtUtil.h R-patched/src/include/R_ext/PrtUtil.h
--- R-3.3.2/src/include/R_ext/PrtUtil.h	2015-08-25 15:15:20.000000000 -0700
+++ R-patched/src/include/R_ext/PrtUtil.h	2016-11-14 15:15:12.000000000 -0800
@@ -2,11 +2,15 @@
  *  R : A Computer Language for Statistical Data Analysis
  *  Copyright (C) 1998-2014    The R Core Team
  *
- *  This program is free software; you can redistribute it and/or modify
+ *  This header file is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU Lesser General Public License as published by
  *  the Free Software Foundation; either version 2.1 of the License, or
  *  (at your option) any later version.
  *
+ *  This file is part of R. R is distributed under the terms of the
+ *  GNU General Public License, either Version 2, June 1991 or Version 3,
+ *  June 2007. See doc/COPYRIGHTS for details of the copyright status of R.
+ *
  *  This program is distributed in the hope that it will be useful,
  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
diff -ubr R-3.3.2/src/include/R_ext/R-ftp-http.h R-patched/src/include/R_ext/R-ftp-http.h
--- R-3.3.2/src/include/R_ext/R-ftp-http.h	2016-10-04 02:14:57.000000000 -0700
+++ R-patched/src/include/R_ext/R-ftp-http.h	2016-11-14 15:15:12.000000000 -0800
@@ -2,11 +2,15 @@
  *  R : A Computer Language for Statistical Data Analysis
  *  Copyright (C) 2001-2016 The R Core Team.
  *
- *  This program is free software; you can redistribute it and/or modify
+ *  This header file is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU Lesser General Public License as published by
  *  the Free Software Foundation; either version 2.1 of the License, or
  *  (at your option) any later version.
  *
+ *  This file is part of R. R is distributed under the terms of the
+ *  GNU General Public License, either Version 2, June 1991 or Version 3,
+ *  June 2007. See doc/COPYRIGHTS for details of the copyright status of R.
+ *
  *  This program is distributed in the hope that it will be useful,
  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
diff -ubr R-3.3.2/src/include/R_ext/RS.h R-patched/src/include/R_ext/RS.h
--- R-3.3.2/src/include/R_ext/RS.h	2016-10-04 02:14:57.000000000 -0700
+++ R-patched/src/include/R_ext/RS.h	2016-11-14 15:15:12.000000000 -0800
@@ -2,11 +2,15 @@
  *  R : A Computer Language for Statistical Data Analysis
  *  Copyright (C) 1999-2016 The R Core Team.
  *
- *  This program is free software; you can redistribute it and/or modify
+ *  This header file is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU Lesser General Public License as published by
  *  the Free Software Foundation; either version 2.1 of the License, or
  *  (at your option) any later version.
  *
+ *  This file is part of R. R is distributed under the terms of the
+ *  GNU General Public License, either Version 2, June 1991 or Version 3,
+ *  June 2007. See doc/COPYRIGHTS for details of the copyright status of R.
+ *
  *  This program is distributed in the hope that it will be useful,
  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
diff -ubr R-3.3.2/src/include/R_ext/Rallocators.h R-patched/src/include/R_ext/Rallocators.h
--- R-3.3.2/src/include/R_ext/Rallocators.h	2016-10-04 02:14:57.000000000 -0700
+++ R-patched/src/include/R_ext/Rallocators.h	2016-11-14 15:15:12.000000000 -0800
@@ -2,11 +2,15 @@
  *  R : A Computer Language for Statistical Data Analysis
  *  Copyright (C) 2014-2016  The R Core Team
  *
- *  This program is free software; you can redistribute it and/or modify
+ *  This header file is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU Lesser General Public License as published by
  *  the Free Software Foundation; either version 2.1 of the License, or
  *  (at your option) any later version.
  *
+ *  This file is part of R. R is distributed under the terms of the
+ *  GNU General Public License, either Version 2, June 1991 or Version 3,
+ *  June 2007. See doc/COPYRIGHTS for details of the copyright status of R.
+ *
  *  This program is distributed in the hope that it will be useful,
  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
diff -ubr R-3.3.2/src/include/R_ext/Random.h R-patched/src/include/R_ext/Random.h
--- R-3.3.2/src/include/R_ext/Random.h	2016-03-16 16:02:15.000000000 -0700
+++ R-patched/src/include/R_ext/Random.h	2016-11-14 15:15:12.000000000 -0800
@@ -2,11 +2,15 @@
  *  R : A Computer Language for Statistical Data Analysis
  *  Copyright (C) 1998-2016    The R Core Team
  *
- *  This program is free software; you can redistribute it and/or modify
+ *  This header file is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU Lesser General Public License as published by
  *  the Free Software Foundation; either version 2.1 of the License, or
  *  (at your option) any later version.
  *
+ *  This file is part of R. R is distributed under the terms of the
+ *  GNU General Public License, either Version 2, June 1991 or Version 3,
+ *  June 2007. See doc/COPYRIGHTS for details of the copyright status of R.
+ *
  *  This program is distributed in the hope that it will be useful,
  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
diff -ubr R-3.3.2/src/include/R_ext/Rdynload.h R-patched/src/include/R_ext/Rdynload.h
--- R-3.3.2/src/include/R_ext/Rdynload.h	2015-08-25 15:15:19.000000000 -0700
+++ R-patched/src/include/R_ext/Rdynload.h	2016-11-14 15:15:12.000000000 -0800
@@ -2,11 +2,15 @@
  *  R : A Computer Language for Statistical Data Analysis
  *  Copyright (C) 2001-12  The R Core Team.
  *
- *  This program is free software; you can redistribute it and/or modify
+ *  This header file is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU Lesser General Public License as published by
  *  the Free Software Foundation; either version 2.1 of the License, or
  *  (at your option) any later version.
  *
+ *  This file is part of R. R is distributed under the terms of the
+ *  GNU General Public License, either Version 2, June 1991 or Version 3,
+ *  June 2007. See doc/COPYRIGHTS for details of the copyright status of R.
+ *
  *  This program is distributed in the hope that it will be useful,
  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
diff -ubr R-3.3.2/src/include/R_ext/Riconv.h R-patched/src/include/R_ext/Riconv.h
--- R-3.3.2/src/include/R_ext/Riconv.h	2015-08-25 15:15:19.000000000 -0700
+++ R-patched/src/include/R_ext/Riconv.h	2016-11-14 15:15:12.000000000 -0800
@@ -2,11 +2,15 @@
  *  R : A Computer Language for Statistical Data Analysis
  *  Copyright (C) 2005     the R Core Team
  *
- *  This program is free software; you can redistribute it and/or modify
+ *  This header file is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU Lesser General Public License as published by
  *  the Free Software Foundation; either version 2.1 of the License, or
  *  (at your option) any later version.
  *
+ *  This file is part of R. R is distributed under the terms of the
+ *  GNU General Public License, either Version 2, June 1991 or Version 3,
+ *  June 2007. See doc/COPYRIGHTS for details of the copyright status of R.
+ *
  *  This program is distributed in the hope that it will be useful,
  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
diff -ubr R-3.3.2/src/include/R_ext/Utils.h R-patched/src/include/R_ext/Utils.h
--- R-3.3.2/src/include/R_ext/Utils.h	2016-10-04 02:14:57.000000000 -0700
+++ R-patched/src/include/R_ext/Utils.h	2016-11-14 15:15:12.000000000 -0800
@@ -2,10 +2,14 @@
  *  R : A Computer Language for Statistical Data Analysis
  *  Copyright (C) 1998-2016    The R Core Team
  *
- *  This program is free software; you can redistribute it and/or modify
+ *  This header file is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU Lesser General Public License as published by
  *  the Free Software Foundation; either version 2.1 of the License, or
  *  (at your option) any later version.
+
+ *  This file is part of R. R is distributed under the terms of the
+ *  GNU General Public License, either Version 2, June 1991 or Version 3,
+ *  June 2007. See doc/COPYRIGHTS for details of the copyright status of R.
  *
  *  This program is distributed in the hope that it will be useful,
  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
diff -ubr R-3.3.2/src/include/R_ext/Visibility.h R-patched/src/include/R_ext/Visibility.h
--- R-3.3.2/src/include/R_ext/Visibility.h	2015-08-25 15:15:19.000000000 -0700
+++ R-patched/src/include/R_ext/Visibility.h	2016-11-14 15:15:12.000000000 -0800
@@ -2,11 +2,15 @@
  *  R : A Computer Language for Statistical Data Analysis
  *  Copyright (C) 2008    the R Core Team
  *
- *  This program is free software; you can redistribute it and/or modify
+ *  This header file is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU Lesser General Public License as published by
  *  the Free Software Foundation; either version 2.1 of the License, or
  *  (at your option) any later version.
  *
+ *  This file is part of R. R is distributed under the terms of the
+ *  GNU General Public License, either Version 2, June 1991 or Version 3,
+ *  June 2007. See doc/COPYRIGHTS for details of the copyright status of R.
+ *
  *  This program is distributed in the hope that it will be useful,
  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
diff -ubr R-3.3.2/src/include/R_ext/eventloop.h R-patched/src/include/R_ext/eventloop.h
--- R-3.3.2/src/include/R_ext/eventloop.h	2016-10-04 02:14:57.000000000 -0700
+++ R-patched/src/include/R_ext/eventloop.h	2016-11-14 15:15:12.000000000 -0800
@@ -2,11 +2,15 @@
  *  R : A Computer Language for Statistical Data Analysis
  *  Copyright (C) 2000-2016 The R Core Team.
  *
- *  This program is free software; you can redistribute it and/or modify
+ *  This header file is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU Lesser General Public License as published by
  *  the Free Software Foundation; either version 2.1 of the License, or
  *  (at your option) any later version.
  *
+ *  This file is part of R. R is distributed under the terms of the
+ *  GNU General Public License, either Version 2, June 1991 or Version 3,
+ *  June 2007. See doc/COPYRIGHTS for details of the copyright status of R.
+ *
  *  This program is distributed in the hope that it will be useful,
  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
diff -ubr R-3.3.2/src/include/R_ext/libextern.h R-patched/src/include/R_ext/libextern.h
--- R-3.3.2/src/include/R_ext/libextern.h	2015-08-25 15:15:19.000000000 -0700
+++ R-patched/src/include/R_ext/libextern.h	2016-11-14 15:15:12.000000000 -0800
@@ -2,11 +2,15 @@
  *  R : A Computer Language for Statistical Data Analysis
  *  Copyright (C) 2001, 2004  The R Core Team.
  *
- *  This program is free software; you can redistribute it and/or modify
+ *  This header file is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU Lesser General Public License as published by
  *  the Free Software Foundation; either version 2.1 of the License, or
  *  (at your option) any later version.
  *
+ *  This file is part of R. R is distributed under the terms of the
+ *  GNU General Public License, either Version 2, June 1991 or Version 3,
+ *  June 2007. See doc/COPYRIGHTS for details of the copyright status of R.
+ *
  *  This program is distributed in the hope that it will be useful,
  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
diff -ubr R-3.3.2/src/include/R_ext/stats_package.h R-patched/src/include/R_ext/stats_package.h
--- R-3.3.2/src/include/R_ext/stats_package.h	2015-08-25 15:15:20.000000000 -0700
+++ R-patched/src/include/R_ext/stats_package.h	2016-11-14 15:15:12.000000000 -0800
@@ -2,11 +2,15 @@
  *  R : A Computer Language for Statistical Data Analysis
  *  Copyright (C) 2007  The R Core Team.
  *
- *  This program is free software; you can redistribute it and/or modify
+ *  This header file is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU Lesser General Public License as published by
  *  the Free Software Foundation; either version 2.1 of the License, or
  *  (at your option) any later version.
  *
+ *  This file is part of R. R is distributed under the terms of the
+ *  GNU General Public License, either Version 2, June 1991 or Version 3,
+ *  June 2007. See doc/COPYRIGHTS for details of the copyright status of R.
+ *
  *  This program is distributed in the hope that it will be useful,
  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
diff -ubr R-3.3.2/src/include/R_ext/stats_stubs.h R-patched/src/include/R_ext/stats_stubs.h
--- R-3.3.2/src/include/R_ext/stats_stubs.h	2015-08-25 15:15:20.000000000 -0700
+++ R-patched/src/include/R_ext/stats_stubs.h	2016-11-14 15:15:12.000000000 -0800
@@ -2,11 +2,15 @@
  *  R : A Computer Language for Statistical Data Analysis
  *  Copyright (C) 2007  The R Core Team.
  *
- *  This program is free software; you can redistribute it and/or modify
+ *  This header file is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU Lesser General Public License as published by
  *  the Free Software Foundation; either version 2.1 of the License, or
  *  (at your option) any later version.
  *
+ *  This file is part of R. R is distributed under the terms of the
+ *  GNU General Public License, either Version 2, June 1991 or Version 3,
+ *  June 2007. See doc/COPYRIGHTS for details of the copyright status of R.
+ *
  *  This program is distributed in the hope that it will be useful,
  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
diff -ubr R-3.3.2/src/include/Rconnections.h R-patched/src/include/Rconnections.h
--- R-3.3.2/src/include/Rconnections.h	2016-01-29 15:15:06.000000000 -0800
+++ R-patched/src/include/Rconnections.h	2017-02-14 15:15:13.000000000 -0800
@@ -36,6 +36,7 @@
 typedef struct urlconn {
     void *ctxt;
     UrlScheme type;
+    int status;
 } *Rurlconn;
 
 /* used in internet module */
diff -ubr R-3.3.2/src/include/Rdefines.h R-patched/src/include/Rdefines.h
--- R-3.3.2/src/include/Rdefines.h	2016-03-16 16:02:19.000000000 -0700
+++ R-patched/src/include/Rdefines.h	2016-11-14 15:15:13.000000000 -0800
@@ -2,11 +2,15 @@
  *  R : A Computer Language for Statistical Data Analysis
  *  Copyright (C) 1999-2016 The R Core Team.
  *
- *  This program is free software; you can redistribute it and/or modify
+ *  This header file is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU Lesser General Public License as published by
  *  the Free Software Foundation; either version 2.1 of the License, or
  *  (at your option) any later version.
  *
+ *  This file is part of R. R is distributed under the terms of the
+ *  GNU General Public License, either Version 2, June 1991 or Version 3,
+ *  June 2007. See doc/COPYRIGHTS for details of the copyright status of R.
+ *
  *  This program is distributed in the hope that it will be useful,
  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
diff -ubr R-3.3.2/src/include/Rdynpriv.h R-patched/src/include/Rdynpriv.h
--- R-3.3.2/src/include/Rdynpriv.h	2016-03-16 16:02:20.000000000 -0700
+++ R-patched/src/include/Rdynpriv.h	2016-11-14 15:15:13.000000000 -0800
@@ -10,7 +10,7 @@
  *  This program is distributed in the hope that it will be useful,
  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  GNU Lesser General Public License for more details.
+ *  GNU General Public License for more details.
  *
  *  You should have received a copy of the GNU General Public License
  *  along with this program; if not, a copy is available at
diff -ubr R-3.3.2/src/include/Rgraphics.h R-patched/src/include/Rgraphics.h
--- R-3.3.2/src/include/Rgraphics.h	2016-03-16 16:02:20.000000000 -0700
+++ R-patched/src/include/Rgraphics.h	2016-11-14 15:15:13.000000000 -0800
@@ -3,11 +3,15 @@
  *  Copyright (C) 1995, 1996  Robert Gentleman and Ross Ihaka
  *  Copyright (C) 1998--2016  R Core Team
  *
- *  This program is free software; you can redistribute it and/or modify
+ *  This header file is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU Lesser General Public License as published by
  *  the Free Software Foundation; either version 2.1 of the License, or
  *  (at your option) any later version.
  *
+ *  This file is part of R. R is distributed under the terms of the
+ *  GNU General Public License, either Version 2, June 1991 or Version 3,
+ *  June 2007. See doc/COPYRIGHTS for details of the copyright status of R.
+ *
  *  This program is distributed in the hope that it will be useful,
  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
diff -ubr R-3.3.2/src/include/Rinlinedfuns.h R-patched/src/include/Rinlinedfuns.h
--- R-3.3.2/src/include/Rinlinedfuns.h	2016-03-16 16:02:19.000000000 -0700
+++ R-patched/src/include/Rinlinedfuns.h	2016-11-14 15:15:13.000000000 -0800
@@ -11,7 +11,7 @@
  *  This program is distributed in the hope that it will be useful,
  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
- *  GNU Lesser General Public License for more details.
+ *  GNU General Public License for more details.
  *
  *  You should have received a copy of the GNU General Public License
  *  along with this program; if not, a copy is available at
diff -ubr R-3.3.2/src/include/Rinterface.h R-patched/src/include/Rinterface.h
--- R-3.3.2/src/include/Rinterface.h	2016-03-16 16:02:20.000000000 -0700
+++ R-patched/src/include/Rinterface.h	2017-01-01 15:15:05.000000000 -0800
@@ -24,6 +24,9 @@
 
    It should not be included by package sources unless they are
    providing such a front-end.
+
+   If CSTACK_DEFNS is defined, if appropriate define HAVE_UINTPTR_T and
+   include <stdint.h> (or <cstdint>) before including this.
 */
 
 #ifndef RINTERFACE_H_
diff -ubr R-3.3.2/src/include/Rinternals.h R-patched/src/include/Rinternals.h
--- R-3.3.2/src/include/Rinternals.h	2016-10-04 02:14:57.000000000 -0700
+++ R-patched/src/include/Rinternals.h	2016-11-14 15:15:13.000000000 -0800
@@ -3,11 +3,15 @@
  *  Copyright (C) 1995, 1996  Robert Gentleman and Ross Ihaka
  *  Copyright (C) 1999-2016   The R Core Team.
  *
- *  This program is free software; you can redistribute it and/or modify
+ *  This header file is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU Lesser General Public License as published by
  *  the Free Software Foundation; either version 2.1 of the License, or
  *  (at your option) any later version.
  *
+ *  This file is part of R. R is distributed under the terms of the
+ *  GNU General Public License, either Version 2, June 1991 or Version 3,
+ *  June 2007. See doc/COPYRIGHTS for details of the copyright status of R.
+ *  
  *  This program is distributed in the hope that it will be useful,
  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
diff -ubr R-3.3.2/src/include/Rmodules/RX11.h R-patched/src/include/Rmodules/RX11.h
--- R-3.3.2/src/include/Rmodules/RX11.h	2015-08-25 15:15:22.000000000 -0700
+++ R-patched/src/include/Rmodules/RX11.h	2016-11-14 15:15:13.000000000 -0800
@@ -2,11 +2,15 @@
  *  R : A Computer Language for Statistical Data Analysis
  *  Copyright (C) 2001-2014 The R Core Team.
  *
- *  This program is free software; you can redistribute it and/or modify
+ *  This header file is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU Lesser General Public License as published by
  *  the Free Software Foundation; either version 2.1 of the License, or
  *  (at your option) any later version.
  *
+ *  This file is part of R. R is distributed under the terms of the
+ *  GNU General Public License, either Version 2, June 1991 or Version 3,
+ *  June 2007. See doc/COPYRIGHTS for details of the copyright status of R.
+ *
  *  This program is distributed in the hope that it will be useful,
  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
diff -ubr R-3.3.2/src/include/Rmodules/Rinternet.h R-patched/src/include/Rmodules/Rinternet.h
--- R-3.3.2/src/include/Rmodules/Rinternet.h	2015-03-18 16:02:15.000000000 -0700
+++ R-patched/src/include/Rmodules/Rinternet.h	2016-11-17 15:15:05.000000000 -0800
@@ -1,3 +1,22 @@
+/*
+ *  R : A Computer Language for Statistical Data Analysis
+ *  Copyright (C) 2004-2015 The R Core Team
+ *
+ *  This program is free software; you can redistribute it and/or modify
+ *  it under the terms of the GNU General Public License as published by
+ *  the Free Software Foundation; either version 2 of the License, or
+ *  (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ *  You should have received a copy of the GNU General Public License
+ *  along with this program; if not, a copy is available at
+ *  https://www.R-project.org/Licenses/
+ */
+
 #ifndef R_INTERNET_MODULE_H
 #define R_INTERNET_MODULE_H
 
diff -ubr R-3.3.2/src/include/Rmodules/Rlapack.h R-patched/src/include/Rmodules/Rlapack.h
--- R-3.3.2/src/include/Rmodules/Rlapack.h	2015-08-25 15:15:22.000000000 -0700
+++ R-patched/src/include/Rmodules/Rlapack.h	2016-11-14 15:15:13.000000000 -0800
@@ -2,11 +2,15 @@
  *  R : A Computer Language for Statistical Data Analysis
  *  Copyright (C) 2001-2010 The R Core Team.
  *
- *  This program is free software; you can redistribute it and/or modify
+ *  This header file is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU Lesser General Public License as published by
  *  the Free Software Foundation; either version 2.1 of the License, or
  *  (at your option) any later version.
  *
+ *  This file is part of R. R is distributed under the terms of the
+ *  GNU General Public License, either Version 2, June 1991 or Version 3,
+ *  June 2007. See doc/COPYRIGHTS for details of the copyright status of R.
+ * 
  *  This program is distributed in the hope that it will be useful,
  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
diff -ubr R-3.3.2/src/include/S.h R-patched/src/include/S.h
--- R-3.3.2/src/include/S.h	2016-03-16 16:02:19.000000000 -0700
+++ R-patched/src/include/S.h	2016-11-14 15:15:13.000000000 -0800
@@ -3,11 +3,15 @@
  *  Copyright (C) 1995, 1996  Robert Gentleman and Ross Ihaka
  *  Copyright (C) 1997--2016 The R Core Team.
  *
- *  This program is free software; you can redistribute it and/or modify
+ *  This header file is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU Lesser General Public License as published by
  *  the Free Software Foundation; either version 2.1 of the License, or
  *  (at your option) any later version.
  *
+ *  This file is part of R. R is distributed under the terms of the
+ *  GNU General Public License, either Version 2, June 1991 or Version 3,
+ *  June 2007. See doc/COPYRIGHTS for details of the copyright status of R.
+ *
  *  This program is distributed in the hope that it will be useful,
  *  but WITHOUT ANY WARRANTY; without even the implied warranty of
  *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
Binary files R-3.3.2/src/library/Recommended/Matrix.tgz and R-patched/src/library/Recommended/Matrix.tgz differ
Only in R-3.3.2/src/library/Recommended: Matrix_1.2-7.1.tar.gz
Only in R-patched/src/library/Recommended: Matrix_1.2-8.tar.gz
Binary files R-3.3.2/src/library/Recommended/mgcv.tgz and R-patched/src/library/Recommended/mgcv.tgz differ
Only in R-3.3.2/src/library/Recommended: mgcv_1.8-15.tar.gz
Only in R-patched/src/library/Recommended: mgcv_1.8-16.tar.gz
Binary files R-3.3.2/src/library/Recommended/nlme.tgz and R-patched/src/library/Recommended/nlme.tgz differ
Only in R-3.3.2/src/library/Recommended: nlme_3.1-128.tar.gz
Only in R-patched/src/library/Recommended: nlme_3.1-131.tar.gz
Binary files R-3.3.2/src/library/Recommended/survival.tgz and R-patched/src/library/Recommended/survival.tgz differ
Only in R-3.3.2/src/library/Recommended: survival_2.39-5.tar.gz
Only in R-patched/src/library/Recommended: survival_2.40-1.tar.gz
diff -ubr R-3.3.2/src/library/base/R/datetime.R R-patched/src/library/base/R/datetime.R
--- R-3.3.2/src/library/base/R/datetime.R	2016-09-14 15:15:13.000000000 -0700
+++ R-patched/src/library/base/R/datetime.R	2016-12-05 15:15:07.000000000 -0800
@@ -25,6 +25,25 @@
     if(!location || nzchar(tz)) return(Sys.getenv("TZ", unset = NA_character_))
     lt <- normalizePath("/etc/localtime") # Linux, macOS, ...
     if (grepl(pat <- "^/usr/share/zoneinfo/", lt)) sub(pat, "", lt)
+    else if (lt == "/etc/localtime" && file.exists("/etc/timezone") &&
+	     dir.exists("/usr/share/zoneinfo") &&
+	     { # Debian etc.
+		 info <- file.info(normalizePath("/etc/timezone"),
+				   extra_cols = FALSE)
+		 (!info$isdir && info$size <= 200L)
+	     } && {
+		 tz1 <- tryCatch(readBin("/etc/timezone", "raw", 200L),
+				 error = function(e) raw(0L))
+		 length(tz1) > 0L &&
+		     all(tz1 %in% as.raw(c(9:10, 13L, 32:126)))
+	     } && {
+		tz2 <- gsub("^[[:space:]]+|[[:space:]]+$", "", rawToChar(tz1))
+		tzp <- file.path("/usr/share/zoneinfo", tz2)
+		file.exists(tzp) && !dir.exists(tzp) &&
+		    identical(file.size(normalizePath(tzp)),
+			      file.size(lt))
+	     })
+	tz2
     else NA_character_
 }
 
diff -ubr R-3.3.2/src/library/base/R/dynload.R R-patched/src/library/base/R/dynload.R
--- R-3.3.2/src/library/base/R/dynload.R	2015-08-25 15:17:36.000000000 -0700
+++ R-patched/src/library/base/R/dynload.R	2016-11-23 15:15:04.000000000 -0800
@@ -1,7 +1,7 @@
 #  File src/library/base/R/dynload.R
 #  Part of the R package, https://www.R-project.org
 #
-#  Copyright (C) 1995-2015 The R Core Team
+#  Copyright (C) 1995-2016 The R Core Team
 #
 #  This program is free software; you can redistribute it and/or modify
 #  it under the terms of the GNU General Public License as published by
@@ -91,7 +91,8 @@
     dll <- which.max(w)
     if(sum(w) > 1L)
         warning(gettextf("multiple DLLs match '%s'. Using '%s'",
-                         dll, dll[["path"]]), domain = NA)
+			 names(dll), dlls[[dll]][["path"]]),
+		domain = NA)
 
     getDLLRegisteredRoutines(dlls[[dll]], addNames)
 }
diff -ubr R-3.3.2/src/library/base/R/pmax.R R-patched/src/library/base/R/pmax.R
--- R-3.3.2/src/library/base/R/pmax.R	2016-08-17 15:15:04.000000000 -0700
+++ R-patched/src/library/base/R/pmax.R	2017-01-24 15:15:04.000000000 -0800
@@ -1,7 +1,7 @@
 #  File src/library/base/R/pmax.R
 #  Part of the R package, https://www.R-project.org
 #
-#  Copyright (C) 1995-2016 The R Core Team
+#  Copyright (C) 1995-2017 The R Core Team
 #
 #  This program is free software; you can redistribute it and/or modify
 #  it under the terms of the GNU General Public License as published by
@@ -23,85 +23,82 @@
 {
     elts <- list(...)
     if(length(elts) == 0L) stop("no arguments")
-    i4 <- isS4(elts[[1L]])
-    if(!i4 && all(vapply(elts, function(x) is.atomic(x) && !is.object(x), NA))) {
-	## NB: NULL passes is.atomic
+    if(all(vapply(elts, function(x) is.atomic(x) && !is.object(x), NA))) { # incl. NULL
 	mmm <- .Internal(pmax(na.rm, ...))
+	mostattributes(mmm) <- attributes(elts[[1L]])
     } else {
-	mmm <- as.vector(elts[[1L]]) # attr(mmm, "dim") <- NULL  # dim<- would drop names
+	mmm <- elts[[1L]] ## attr(mmm, "dim") <- NULL  # dim<- would drop names
 	has.na <- FALSE
+        as <- methods::as
+        asL <- function(x) if(isS4(x)) as(x, "logical") else x
 	for (each in elts[-1L]) {
-	    each <- as.vector(each) # attr(each, "dim") <- NULL
+	    ## attr(each, "dim") <- NULL ## FIXME: deal with d.fr.s !
 	    l1 <- length(each); l2 <- length(mmm)
-	    if(l2 < l1) {
-		if (l2 && l1 %% l2)
+	    if(l2 && (l2 < l1 || !l1)) {
+		if (l1 %% l2)
 		    warning("an argument will be fractionally recycled")
 		mmm <- rep(mmm, length.out = l1)
-	    } else if(l1 && l1 < l2) {
+	    } else if(l1 && (l1 < l2 || !l2)) {
 		if (l2 %% l1)
 		    warning("an argument will be fractionally recycled")
 		each <- rep(each, length.out = l2)
 	    }
-	    nas <- cbind(is.na(mmm), is.na(each))
-	    if(has.na || (has.na <- any(nas))) {
-		mmm [nas[, 1L]] <- each[nas[, 1L]]
-		each[nas[, 2L]] <- mmm [nas[, 2L]]
-	    }
-	    change <- mmm < each
+	    na.m <- is.na(mmm)
+	    na.e <- is.na(each)
+	    if(has.na || (has.na <- any(na.m) || any(na.e))) {
+		if(any(na.m <- asL(na.m))) mmm [na.m] <- each[na.m]
+		if(any(na.e <- asL(na.e))) each[na.e] <- mmm [na.e]
+	    }
+	    nS4 <- !isS4(mmm)
+	    if(isS4(change <- mmm < each) && (nS4 || !isS4(each))) # e.g., keep sparse 'each'
+		change <- as(change, "logical")# not as.vector(): kills the d.fr. case
 	    change <- change & !is.na(change)
 	    mmm[change] <- each[change]
-	    if (has.na && !na.rm) mmm[nas[, 1L] | nas[, 2L]] <- NA
-	}
+	    if (has.na && !na.rm) mmm[na.m | na.e] <- NA
+	    if(nS4) mostattributes(mmm) <- attributes(elts[[1L]])
     }
-    if(i4) {
-	r <- elts[[1L]] # i.e. a valid S4 object
-	tryCatch({ r[] <- mmm; r }, error = mmm)
     }
-    else { # !isS4(.) ; to improve for S3 ?
-	mostattributes(mmm) <- attributes(elts[[1L]])
 	mmm
-    }
 }
 
 pmin <- function (..., na.rm = FALSE)
 {
     elts <- list(...)
     if(length(elts) == 0L) stop("no arguments")
-    i4 <- isS4(elts[[1L]])
-    if(!i4 && all(vapply(elts, function(x) is.atomic(x) && !is.object(x), NA))) {
+    if(all(vapply(elts, function(x) is.atomic(x) && !is.object(x), NA))) { # incl. NULL
 	mmm <- .Internal(pmin(na.rm, ...))
+	mostattributes(mmm) <- attributes(elts[[1L]])
     } else {
-	mmm <- as.vector(elts[[1L]]) # attr(mmm, "dim") <- NULL  # dim<- would drop names
+	mmm <- elts[[1L]] ## attr(mmm, "dim") <- NULL  # dim<- would drop names
 	has.na <- FALSE
+        as <- methods::as
+        asL <- function(x) if(isS4(x)) as(x, "logical") else x
 	for (each in elts[-1L]) {
-	    each <- as.vector(each) # attr(each, "dim") <- NULL
+	    ## attr(each, "dim") <- NULL ## FIXME: deal with d.fr.s !
 	    l1 <- length(each); l2 <- length(mmm)
-	    if(l2 < l1) {
-		if (l2 && l1 %% l2)
+	    if(l2 && (l2 < l1 || !l1)) {
+		if (l1 %% l2)
 		    warning("an argument will be fractionally recycled")
 		mmm <- rep(mmm, length.out = l1)
-	    } else if(l1 && l1 < l2) {
+	    } else if(l1 && (l1 < l2 || !l2)) {
 		if (l2 %% l1)
 		    warning("an argument will be fractionally recycled")
 		each <- rep(each, length.out = l2)
 	    }
-	    nas <- cbind(is.na(mmm), is.na(each))
-	    if(has.na || (has.na <- any(nas))) {
-		mmm [nas[, 1L]] <- each[nas[, 1L]]
-		each[nas[, 2L]] <- mmm [nas[, 2L]]
-	    }
-	    change <- mmm > each
+	    na.m <- is.na(mmm)
+	    na.e <- is.na(each)
+	    if(has.na || (has.na <- any(na.m) || any(na.e))) {
+		if(any(na.m <- asL(na.m))) mmm [na.m] <- each[na.m]
+		if(any(na.e <- asL(na.e))) each[na.e] <- mmm [na.e]
+	    }
+	    nS4 <- !isS4(mmm)
+	    if(isS4(change <- mmm > each) && (nS4 || !isS4(each))) # e.g., keep sparse 'each'
+		change <- as(change, "logical")# not as.vector(): kills the d.fr. case
 	    change <- change & !is.na(change)
 	    mmm[change] <- each[change]
-	    if (has.na && !na.rm) mmm[nas[, 1L] | nas[, 2L]] <- NA
-	}
+	    if (has.na && !na.rm) mmm[na.m | na.e] <- NA
+	    if(nS4) mostattributes(mmm) <- attributes(elts[[1L]])
     }
-    if(i4) {
-	r <- elts[[1L]] # i.e. a valid S4 object
-	tryCatch({ r[] <- mmm; r }, error = mmm)
     }
-    else { # !isS4(.) ; to improve for S3 ?
-	mostattributes(mmm) <- attributes(elts[[1L]])
 	mmm
-    }
 }
diff -ubr R-3.3.2/src/library/base/R/zdatetime.R R-patched/src/library/base/R/zdatetime.R
--- R-3.3.2/src/library/base/R/zdatetime.R	2015-08-25 15:17:34.000000000 -0700
+++ R-patched/src/library/base/R/zdatetime.R	2016-12-14 15:15:06.000000000 -0800
@@ -1,7 +1,7 @@
 #  File src/library/base/R/zdatetime.R
 #  Part of the R package, https://www.R-project.org
 #
-#  Copyright (C) 1995-2015 The R Core Team
+#  Copyright (C) 1995-2016 The R Core Team
 #
 #  This program is free software; you can redistribute it and/or modify
 #  it under the terms of the GNU General Public License as published by
@@ -25,7 +25,7 @@
           "1985-6-30", "1987-12-31", "1989-12-31", "1990-12-31",
           "1992-6-30", "1993-6-30", "1994-6-30","1995-12-31",
           "1997-6-30", "1998-12-31", "2005-12-31", "2008-12-31", 
-          "2012-6-30", "2015-6-30")
+          "2012-6-30", "2015-6-30", "2016-12-31")
     .leap.seconds <- strptime(paste(.leap.seconds , "23:59:60"),
                               "%Y-%m-%d %H:%M:%S")
     c(as.POSIXct(.leap.seconds, "GMT")) # lose the timezone
diff -ubr R-3.3.2/src/library/base/man/DateTimeClasses.Rd R-patched/src/library/base/man/DateTimeClasses.Rd
--- R-3.3.2/src/library/base/man/DateTimeClasses.Rd	2016-09-14 15:15:17.000000000 -0700
+++ R-patched/src/library/base/man/DateTimeClasses.Rd	2016-12-16 15:15:09.000000000 -0800
@@ -1,6 +1,6 @@
 % File src/library/base/man/DateTimeClasses.Rd
 % Part of the R package, https://www.R-project.org
-% Copyright 1995-2015 R Core Team
+% Copyright 1995-2016 R Core Team
 % Distributed under GPL 2 or later
 
 \name{DateTimeClasses}
@@ -151,8 +151,10 @@
   attribute (e.g., by \code{c(x)}).
 
   Unfortunately, the conversion is complicated by the operation of time
-  zones and leap seconds (26 days have been 86401 seconds long so far,
-  the last at the time of writing being added in 2015: the times of the
+  zones and leap seconds (according to this version of \R's data,
+  \Sexpr{length(.leap.seconds)} days have been 86401 seconds long so
+  far, the last being on (actually, immediately before)
+  \Sexpr{format(as.Date(utils::tail(.leap.seconds, 1)))}: the times of the
   extra seconds are in the object \code{.leap.seconds}).  The details of
   this are entrusted to the OS services where possible.  It seems that
   some rare systems used to use leap seconds, but all known current
@@ -266,6 +268,10 @@
   Not only are components and attributes optional; several components
   may have values meaning \sQuote{not yet determined} and the same time
   represented in different time zones will look quite different.
+
+  Currently the \emph{order} of the list components of \code{"POSIXlt"}
+  objects must not be changed, as several C-based conversion methods
+  rely on the order for efficiency.
 }
 \examples{\donttest{% <-->  may fail on platforms wrongly set up
 (z <- Sys.time())             # the current date, as class "POSIXct"
@@ -274,7 +280,7 @@
 
 as.POSIXlt(Sys.time(), "GMT") # the current time in GMT
 format(.leap.seconds)         # the leap seconds in your time zone
-print(.leap.seconds, tz = "PST8PDT")  # and in Seattle's
+format(.leap.seconds, tz = "PST8PDT")  # and in Seattle's
 
 ## look at *internal* representation of "POSIXlt" :
 leapS <- as.POSIXlt(.leap.seconds)
diff -ubr R-3.3.2/src/library/base/man/NULL.Rd R-patched/src/library/base/man/NULL.Rd
--- R-3.3.2/src/library/base/man/NULL.Rd	2015-08-25 15:18:17.000000000 -0700
+++ R-patched/src/library/base/man/NULL.Rd	2017-01-01 15:15:06.000000000 -0800
@@ -1,6 +1,6 @@
 % File src/library/base/man/NULL.Rd
 % Part of the R package, https://www.R-project.org
-% Copyright 1995-2012 R Core Team
+% Copyright 1995-2016 R Core Team
 % Distributed under GPL 2 or later
 
 \name{NULL}
@@ -18,11 +18,6 @@
   \code{NULL} represents the null object in \R: it is a \link{reserved}
   word.  \code{NULL} is often returned by expressions and functions
   whose value is undefined.
-
-  \code{as.null} ignores its argument and returns the value \code{NULL}.
-
-  \code{is.null} returns \code{TRUE} if its argument
-  is \code{NULL} and \code{FALSE} otherwise.
 }
 \arguments{
   \item{x}{an object to be tested or coerced.}
@@ -30,12 +25,19 @@
 }
 \details{
   \code{NULL} can be indexed (see \link{Extract}) in just about any
-  syntactically legal way: whether is makes sense or not, the result is
+  syntactically legal way: whether it makes sense or not, the result is
   always \code{NULL}.  Objects with value \code{NULL} can be changed by
   replacement operators and will be coerced to the type of the
   right-hand side.
 
-  \code{NULL} is also used as the empty \link{pairlist}.
+  \code{NULL} is also used as the empty \link{pairlist}: see the
+  examples. Because pairlists are often promoted to lists, you may
+  encounter \code{NULL} being promoted to an empty list.
+
+  Objects with value \code{NULL} cannot have attributes as there is only
+  one null object: attempts to assign them are either an error
+  (\code{\link{attr}}) or promote the object to an empty list with
+  attribute(s) (\code{\link{attributes}} and \code{\link{structure}}).
 }
 \note{
   \code{is.null} is a \link{primitive} function.
@@ -45,8 +47,15 @@
   \emph{The New S Language}.
   Wadsworth & Brooks/Cole.
 }
+\value{
+  \code{as.null} ignores its argument and returns \code{NULL}.
+
+  \code{is.null} returns \code{TRUE} if its argument's value
+  is \code{NULL} and \code{FALSE} otherwise.
+}
 \examples{
 is.null(list())     # FALSE (on purpose!)
+is.null(pairlist()) # TRUE
 is.null(integer(0)) # FALSE
 is.null(logical(0)) # FALSE
 as.null(list(a = 1, b = "c"))
diff -ubr R-3.3.2/src/library/base/man/Trig.Rd R-patched/src/library/base/man/Trig.Rd
--- R-3.3.2/src/library/base/man/Trig.Rd	2015-08-25 15:18:13.000000000 -0700
+++ R-patched/src/library/base/man/Trig.Rd	2016-12-01 15:15:05.000000000 -0800
@@ -1,6 +1,6 @@
 % File src/library/base/man/Trig.Rd
 % Part of the R package, https://www.R-project.org
-% Copyright 1995-2015 R Core Team
+% Copyright 1995-2016 R Core Team
 % Distributed under GPL 2 or later
 
 \name{Trig}
@@ -51,11 +51,18 @@
   \code{cospi} etc.
 
   \code{cospi(x)}, \code{sinpi(x)}, and \code{tanpi(x)} are accurate
-  for \code{x} which are multiples of a half.
+  for \code{x} values which are multiples of a half.
 
   All except \code{atan2} are \link{internal generic} \link{primitive}
   functions: methods can be defined for them individually or via the
   \code{\link[=S3groupGeneric]{Math}} group generic.
+  
+  These are all wrappers to system calls of the same name (with prefix
+  \code{c} for complex arguments) where available.  (\code{cospi},
+  \code{sinpi}, and \code{tanpi} are part of a C11 extension
+  and provided by e.g.\sspace{}macOS and Solaris: where not yet
+  available call to \code{cos} \emph{etc} are used, with special cases
+  for  multiples of a half.)
 }
 
 \value{
@@ -82,6 +89,7 @@
    Complex arguments for  \code{cospi}, \code{sinpi}, and \code{tanpi}
    are not yet implemented.% but patches are welcome
 }
+
 \section{S4 methods}{
   All except \code{atan2} are S4 generic functions: methods can be defined
   for them individually or via the
@@ -97,9 +105,10 @@
   Chapter 4. Elementary Transcendental Functions: Logarithmic,
   Exponential, Circular and Hyperbolic Functions
 
-  For \code{cospi}, \code{sinpi}, and \code{tanpi} the draft C11
-  extension ISO/IEC TS 18661
-  (\url{http://www.open-std.org/jtc1/sc22/wg14/www/docs/n1785.pdf}).
+  For \code{cospi}, \code{sinpi}, and \code{tanpi} the C11 extension
+  ISO/IEC TS 18661-4:2015 (draft at
+  \url{http://www.open-std.org/jtc1/sc22/wg14/www/docs/n1785.pdf}).
+  
 }
 \examples{
 x <- seq(-3, 7, by = 1/8)
diff -ubr R-3.3.2/src/library/base/man/assignOps.Rd R-patched/src/library/base/man/assignOps.Rd
--- R-3.3.2/src/library/base/man/assignOps.Rd	2016-05-17 15:15:09.000000000 -0700
+++ R-patched/src/library/base/man/assignOps.Rd	2017-01-14 15:15:04.000000000 -0800
@@ -1,6 +1,6 @@
 % File src/library/base/man/assignOps.Rd
 % Part of the R package, https://www.R-project.org
-% Copyright 1995-2016 R Core Team
+% Copyright 1995-2017 R Core Team
 % Distributed under GPL 2 or later
 
 \name{assignOps}
@@ -62,7 +62,7 @@
   \emph{The New S Language}.
   Wadsworth & Brooks/Cole.
 
-  Chamber, J. M. (1998)
+  Chambers, J. M. (1998)
   \emph{Programming with Data.  A Guide to the S Language}.
   Springer (for \code{=}).
 }
diff -ubr R-3.3.2/src/library/base/man/attr.Rd R-patched/src/library/base/man/attr.Rd
--- R-3.3.2/src/library/base/man/attr.Rd	2015-08-25 15:17:53.000000000 -0700
+++ R-patched/src/library/base/man/attr.Rd	2017-01-01 15:15:06.000000000 -0800
@@ -1,6 +1,6 @@
 % File src/library/base/man/attr.Rd
 % Part of the R package, https://www.R-project.org
-% Copyright 1995-2010 R Core Team
+% Copyright 1995-2016 R Core Team
 % Distributed under GPL 2 or later
 
 \name{attr}
@@ -46,6 +46,9 @@
   The extractor function allows (and does not match) empty and missing
   values of \code{which}: the replacement function does not.
 
+  \code{\link{NULL}} objects cannot have attributes and attempting to
+  assign one by \code{attr} gives an error.
+
   Both are \link{primitive} functions.
 }
 \value{
diff -ubr R-3.3.2/src/library/base/man/attributes.Rd R-patched/src/library/base/man/attributes.Rd
--- R-3.3.2/src/library/base/man/attributes.Rd	2015-08-25 15:18:14.000000000 -0700
+++ R-patched/src/library/base/man/attributes.Rd	2017-01-01 15:15:06.000000000 -0800
@@ -1,6 +1,6 @@
 % File src/library/base/man/attributes.Rd
 % Part of the R package, https://www.R-project.org
-% Copyright 1995-2011 R Core Team
+% Copyright 1995-2016 R Core Team
 % Distributed under GPL 2 or later
 
 \name{attributes}
@@ -56,6 +56,9 @@
   as if they were (and can be set by the replacement form of
   \code{attributes}).
 
+  \code{\link{NULL}} objects cannot have attributes and attempts to
+  assign them will promote the object to an empty list.
+
   Both assignment and replacement forms of \code{attributes} are
   \link{primitive} functions.
 }
@@ -64,7 +67,8 @@
   \emph{The New S Language}.
   Wadsworth & Brooks/Cole.
 }
-\seealso{\code{\link{attr}}.
+\seealso{
+  \code{\link{attr}},  \code{\link{structure}}.
 }
 \examples{
 x <- cbind(a = 1:3, pi = pi) # simple matrix with dimnames
diff -ubr R-3.3.2/src/library/base/man/c.Rd R-patched/src/library/base/man/c.Rd
--- R-3.3.2/src/library/base/man/c.Rd	2016-10-04 02:14:49.000000000 -0700
+++ R-patched/src/library/base/man/c.Rd	2017-01-01 15:15:06.000000000 -0800
@@ -30,7 +30,7 @@
 \details{
   The output type is determined from the highest type of the components
   in the hierarchy NULL < raw < logical < integer < double < complex < character
-  < list < expression.  Pairlists are treated as lists, but non-vector
+  < list < expression.  Pairlists are treated as lists, whereas non-vector
   components (such names and calls) are treated as one-element lists
   which cannot be unlisted even if \code{recursive = TRUE}.
 
@@ -43,7 +43,7 @@
   \code{c} is sometimes used for its side effect of removing attributes
   except names, for example to turn an array into a vector.
   \code{as.vector} is a more intuitive way to do this, but also drops
-  names.  Note too that methods other than the default are not required
+  names.  Note that methods other than the default are not required
   to do this (and they will almost certainly preserve a class attribute).
 
   This is a \link{primitive} function.
diff -ubr R-3.3.2/src/library/base/man/class.Rd R-patched/src/library/base/man/class.Rd
--- R-3.3.2/src/library/base/man/class.Rd	2016-10-04 02:14:49.000000000 -0700
+++ R-patched/src/library/base/man/class.Rd	2017-01-01 15:15:06.000000000 -0800
@@ -1,6 +1,6 @@
 % File src/library/base/man/class.Rd
 % Part of the R package, https://www.R-project.org
-% Copyright 1995-2010 R Core Team
+% Copyright 1995-2016 R Core Team
 % Distributed under GPL 2 or later
 
 \name{class}
@@ -45,6 +45,9 @@
   \code{oldClass<-} get and set the attribute, which can also be done
   directly.)
 
+  Note that \code{\link{NULL}} objects cannot have attributes (hence not
+  classes) and attempting to assign a class is an error.
+
   When a generic function \code{fun} is applied to an object with class
   attribute \code{c("first", "second")}, the system searches for a
   function called \code{fun.first} and, if it finds it, applies it to
@@ -84,9 +87,9 @@
   on the \code{oldClass} for efficiency, and \link{internal generic}s
   only dispatch on objects for which \code{\link{is.object}} is true.
 
-  In some versions of \R, assigning a zero-length vector with
-  \code{class} removes the class: in others it is an error (whereas it
-  works for \code{oldClass}.  It is clearer to always assign \code{NULL}
+  In older versions of \R, assigning a zero-length vector with
+  \code{class} removed the class: it is now an error (whereas it
+  still works for \code{oldClass}).  It is clearer to always assign \code{NULL}
   to remove the class.
 }
 
diff -ubr R-3.3.2/src/library/base/man/connections.Rd R-patched/src/library/base/man/connections.Rd
--- R-3.3.2/src/library/base/man/connections.Rd	2016-09-14 15:15:18.000000000 -0700
+++ R-patched/src/library/base/man/connections.Rd	2017-02-14 15:15:12.000000000 -0800
@@ -232,9 +232,8 @@
   No attempt is made to decode a percent-encoded \samp{file:} URL: call
   \code{\link{URLdecode}} if necessary.
 
-  The \code{"internal"} method does not follow re-directed HTTP URLs:
-  both methods \code{"wininet"} (the default on Windows) and
-  \code{"libcurl"} do (including for HTTPS URLs).
+  All the methods attempt to follow redirected HTTP URLs, but the
+  \code{"internal"} method is unable to follow redirections to HTTPS URLs.
 
   Server-side cached data is always accepted.
 
@@ -494,10 +493,15 @@
 #endif
 }
 \note{
+  On a Unix-alike, \code{url} with the default method and an explicit
+  \code{open} argument (as used by for example \code{\link{readLines}}
+  with a character string \code{con} argument specifying a URL) will
+  re-try with method \code{"libcurl"} if an HTTP redirection to a
+  \samp{https://} URL is encountered.
+  
   \R's connections are modelled on those in S version 4 (see Chambers,
   1998).  However \R goes well beyond the S model, for example in output
   text connections and URL, compressed and socket connections.
-
   The default open mode in \R is \code{"r"} except for socket connections.
   This differs from S, where it is the equivalent of \code{"r+"},
   known as \code{"*"}.
diff -ubr R-3.3.2/src/library/base/man/grepRaw.Rd R-patched/src/library/base/man/grepRaw.Rd
--- R-3.3.2/src/library/base/man/grepRaw.Rd	2015-08-25 15:17:41.000000000 -0700
+++ R-patched/src/library/base/man/grepRaw.Rd	2016-11-05 16:15:04.000000000 -0700
@@ -1,6 +1,6 @@
 % File src/library/base/man/grepRaw.Rd
 % Part of the R package, https://www.R-project.org
-% Copyright 1995-2011 R Core Team
+% Copyright 1995-2016 R Core Team
 % Distributed under GPL 2 or later
 
 \name{grepRaw}
@@ -80,4 +80,10 @@
 
   \code{\link{grep}} for matching character vectors.
 }
+\examples{
+grepRaw("no match", "textText")  # integer(0): no match
+grepRaw("adf", "adadfadfdfadadf") # 3 - the first match
+grepRaw("adf", "adadfadfdfadadf", all=TRUE, fixed=TRUE)
+## [1]  3  6 13 -- three matches
+}
 \keyword{utilities}
diff -ubr R-3.3.2/src/library/base/man/list.Rd R-patched/src/library/base/man/list.Rd
--- R-3.3.2/src/library/base/man/list.Rd	2015-08-25 15:17:40.000000000 -0700
+++ R-patched/src/library/base/man/list.Rd	2017-01-01 15:15:06.000000000 -0800
@@ -86,7 +86,8 @@
   \code{\link{as.environment}()} method for list objects.
 
   An empty pairlist, \code{pairlist()} is the same as
-  \code{\link{NULL}}.  This is different from \code{list()}.
+  \code{\link{NULL}}.  This is different from \code{list()}: some but
+  not all operations will promote an empty pairlist to an empty list.
 
   \code{as.pairlist} is implemented as \code{\link{as.vector}(x,
   "pairlist")}, and hence will dispatch methods for the generic function
diff -ubr R-3.3.2/src/library/base/man/tempfile.Rd R-patched/src/library/base/man/tempfile.Rd
--- R-3.3.2/src/library/base/man/tempfile.Rd	2016-09-14 15:15:18.000000000 -0700
+++ R-patched/src/library/base/man/tempfile.Rd	2016-12-21 15:15:06.000000000 -0800
@@ -69,14 +69,29 @@
   has no effect on \code{tempdir()}: the per-session temporary directory
   is created before the interpreter is started.
 }
+
 \section{Note on parallel}{
-  \R processes forked by functions such as \code{\link{mclapply}} in
-  package \pkg{parallel} (or \CRANpkg{multicore}) share a per-session
-  temporary directory.  Further, the \sQuote{guaranteed not to be
-    currently in use} applies only at the time of asking, and two
-  children could ask simultaneously.  This is circumvented
-  by ensuring that \code{tempfile} calls in different children try
-  different names.
+  \R processes forked by functions such as \code{\link{mclapply}} and
+  \code{\link{makeForkCluster}} in package \pkg{parallel} share a
+  per-session temporary directory.  Further, the \sQuote{guaranteed not
+    to be currently in use} applies only at the time of asking, and two
+  children could ask simultaneously.  This is circumvented by ensuring
+  that \code{tempfile} calls in different children try different names.
+}
+
+\source{
+  The final component of \code{tempdir()} is created by the POSIX system
+  call \code{mkdtmp}, or if this is not available (e.g.\sspace{}on
+  Windows) a version derived from the source code of GNU \code{glibc}.
+  % The substitute was once used on Solaris 10: this nowadays has the
+  % call but no man page for it. It has used \code{.}
+  
+  It will be of the form \file{RtmpXXXXXX} where the last 6 characters
+  are replaced in a platform-specific way.  POSIX only requires that the
+  replacements be ASCII, which allows \code{.} (so the value may appear
+  to have a file extension) and \link{regexp} metacharacters such as
+  \code{+}.  Most commonly the replacements are from the \link{regexp}
+  pattern \code{[A-Za-z0-9]}, but \code{.} \emph{has} been seen.
 }
 
 \references{
diff -ubr R-3.3.2/src/library/compiler/man/compile.Rd R-patched/src/library/compiler/man/compile.Rd
--- R-3.3.2/src/library/compiler/man/compile.Rd	2016-03-16 16:03:45.000000000 -0700
+++ R-patched/src/library/compiler/man/compile.Rd	2016-12-02 15:15:09.000000000 -0800
@@ -1,6 +1,6 @@
 % File src/library/compiler/man/compile.Rd
 % Part of the R package, https://www.R-project.org
-% Copyright 2011 R Core Team
+% Copyright 2011-2016 R Core Team
 % Distributed under GPL 2 or later
 
 \name{compile}
@@ -28,23 +28,23 @@
 }
 \arguments{
   \item{f}{a closure.}
-  \item{options}{list of named compiler options}
+  \item{options}{list of named compiler options: see \sQuote{Details}.}
   \item{env}{the top level environment for the compiling.}
-  \item{file,infile,outfile}{pathnames; outfile defaults to infile with a .Rc
-                             extension in place of any existing extension.}
+  \item{file,infile,outfile}{pathnames; outfile defaults to infile with
+    a \file{.Rc} extension in place of any existing extension.}
   \item{ascii}{logical; should the compiled file be saved in ascii format?}
-  \item{verbose}{logical; should the compiler show what is being compiled}
+  \item{verbose}{logical; should the compiler show what is being compiled?}
   \item{envir}{environment to evaluate loaded expressions in.}
   \item{chdir}{logical; change directory before evaluation?}
   \item{code}{byte code expression or compiled closure}
-  \item{e}{expression to compile}
-  \item{level}{integer; the JIT level to use}
-  \item{enable}{logical; enable compiling packages if \code{TRUE}}
-  \item{name}{character string; name of option to return}
-  \item{...}{named compiler options to set}
+  \item{e}{expression to compile.}
+  \item{level}{integer; the JIT level to use (\code{0} to \code{3}).}
+  \item{enable}{logical; enable compiling packages if \code{TRUE}.}
+  \item{name}{character string; name of option to return.}
+  \item{...}{named compiler options to set.}
 }
 \description{
-  These functions provide an interface to a byte code compiler for R.
+  These functions provide an interface to a byte code compiler for \R.
 }
 \details{
   The function \code{cmpfun} compiles the body of a closure and
@@ -54,7 +54,7 @@
   \code{compile} compiles an expression into a byte code object; the
   object can then be evaluated with \code{eval}.
 
-  \code{cmpfile} parses the expression in \code{infile}, compiles
+  \code{cmpfile} parses the expressions in \code{infile}, compiles
   them, and writes the compiled expressions to \code{outfile}.  If
   \code{outfile} is not provided, it is formed from \code{infile} by
   replacing or appending a \code{.Rc} suffix.
@@ -67,16 +67,17 @@
   that may be useful to give a hint of what is going on.
 
   \code{enableJIT} enables or disables just-in-time (JIT)
-  compilation. JIT is disabled if the argument is 0. If \code{enable} is
-  1 then closures are compiled before their first use.  If \code{enable}
+  compilation. JIT is disabled if the argument is 0. If \code{level} is
+  1 then closures are compiled before their first use.  If \code{level}
   is 2, then in addition closures are also compiled before they are
   duplicated (useful for some packages, like \code{lattice}, that store
-  closures in lists).  If \code{enable} is 3 then in addition all loops
-  are compiled before they are executed.  JIT level 3 requires
-  optimization level 2 or 3. JIT can also be enabled by starting \R with
-  the environment variable \code{R_ENABLE_JIT} set to one of these
-  values. Calling \code{enableJIT} with a negative argument returns the
-  current JIT level.
+  closures in lists).  If \code{level} is 3 then in addition all loops
+  are compiled before they are executed.  JIT level 3 requires the
+  compiler option \code{optimize} to be 2 or 3.  The JIT level can also
+  be selected by starting \R with the environment variable
+  \code{R_ENABLE_JIT} set to one of these values. Calling
+  \code{enableJIT} with a negative argument returns the current JIT
+  level. The default JIT level is \code{3}.
 
   \code{compilePKGS} enables or disables compiling packages when they
   are installed.  This requires that the package use lazy loading as
@@ -91,12 +92,12 @@
   The \code{options} argument can be used to control compiler operation.
   There are currently three options: \code{optimize},
   \code{suppressAll}, and \code{suppressUndefined}. \code{optimize}
-  specifies the optimization level, which can be an integer form 0 to 3.
-  \code{suppressAll} should be a scalar logical; if \code{TRUE} no
-  messages will be shown. \code{suppressUndefined} can be \code{TRUE} to
-  suppress all messages about undefined variables, or it can be a
-  character vector of the names of variables for which messages should
-  not be shown.
+  specifies the optimization level, an integer from \code{0} to \code{3}
+  (the current out-of-the-box default is \code{2}).  \code{suppressAll}
+  should be a scalar logical; if \code{TRUE} no messages will be
+  shown. \code{suppressUndefined} can be \code{TRUE} to suppress all
+  messages about undefined variables, or it can be a character vector of
+  the names of variables for which messages should not be shown.
 
   \code{getCompilerOption} returns the value of the specified option.
   The default value is returned unless a value is supplied in the
diff -ubr R-3.3.2/src/library/datasets/data/precip.R R-patched/src/library/datasets/data/precip.R
--- R-3.3.2/src/library/datasets/data/precip.R	2010-03-17 07:43:10.000000000 -0700
+++ R-patched/src/library/datasets/data/precip.R	2016-11-23 15:15:04.000000000 -0800
@@ -12,7 +12,7 @@
 "Baltimore", "Boston", "Detroit", "Sault Ste. Marie", "Duluth",
 "Minneapolis/St Paul", "Jackson", "Kansas City", "St Louis", "Great Falls",
 "Omaha", "Reno", "Concord", "Atlantic City", "Albuquerque", "Albany",
-"Buffalo", "New York", "Charlotte", "Raleigh", "Bismark", "Cincinati",
+"Buffalo", "New York", "Charlotte", "Raleigh", "Bismark", "Cincinnati",
 "Cleveland", "Columbus", "Oklahoma City", "Portland", "Philadelphia",
 "Pittsburg", "Providence", "Columbia", "Sioux Falls", "Memphis",
 "Nashville", "Dallas", "El Paso", "Houston", "Salt Lake City", "Burlington", 
diff -ubr R-3.3.2/src/library/datasets/man/precip.Rd R-patched/src/library/datasets/man/precip.Rd
--- R-3.3.2/src/library/datasets/man/precip.Rd	2015-08-25 15:17:19.000000000 -0700
+++ R-patched/src/library/datasets/man/precip.Rd	2016-11-23 15:15:04.000000000 -0800
@@ -1,6 +1,6 @@
 % File src/library/datasets/man/precip.Rd
 % Part of the R package, https://www.R-project.org
-% Copyright 1995-2007 R Core Team
+% Copyright 1995-2016 R Core Team
 % Distributed under GPL 2 or later
 
 \name{precip}
@@ -23,9 +23,20 @@
   \emph{Interactive Data Analysis}.
   New York: Wiley.
 }
+\note{
+  The dataset version up to Nov.16, 2016 had a typo in \code{"Cincinnati"}'s
+  name.  The examples show how to recreate that version.
+}
 \examples{
 require(graphics)
 dotchart(precip[order(precip)], main = "precip data")
 title(sub = "Average annual precipitation (in.)")
+
+## Old ("wrong") version of dataset (just name change):
+precip.O <- local({
+   p <- precip; names(p)[names(p) == "Cincinnati"] <- "Cincinati" ; p })
+stopifnot(all(precip == precip.O),
+	  match("Cincinnati", names(precip)) == 46,
+	  identical(names(precip)[-46], names(precip.O)[-46]))
 }
 \keyword{datasets}
diff -ubr R-3.3.2/src/library/grDevices/src/devPS.c R-patched/src/library/grDevices/src/devPS.c
--- R-3.3.2/src/library/grDevices/src/devPS.c	2016-01-04 15:15:05.000000000 -0800
+++ R-patched/src/library/grDevices/src/devPS.c	2017-01-16 15:15:12.000000000 -0800
@@ -412,10 +412,10 @@
 	/* check for incomplete encoding file */
 	if(!state->p) return 1;
 	while (isspace((int)* state->p)) state->p++;
-	if (state->p == '\0' || *state->p == '%'|| *state->p == '\n') { state->p = NULL; continue; }
+	if (*state->p == '\0' || *state->p == '%'|| *state->p == '\n') { state->p = NULL; continue; }
 	state->p0 = state->p;
 	while (!isspace((int)*state->p)) state->p++;
-	if (state->p != '\0') *state->p++ = '\0';
+	if (*state->p != '\0') *state->p++ = '\0';
 	if(c == 45) strcpy(dest, "/minus"); else strcpy(dest, state->p0);
 	break;
     }
@@ -513,13 +513,15 @@
 	if (!(fp = R_fopen(R_ExpandFileName(buf), "r"))) return 0;
     }
     if (GetNextItem(fp, buf, -1, &state)) return 0; /* encoding name */
-    strcpy(encname, buf+1);
+    strncpy(encname, buf+1, 99); 
+    encname[99] = '\0';
     if (!isPDF) snprintf(enccode, 5000, "/%s [\n", encname);
     else enccode[0] = '\0';
     if (GetNextItem(fp, buf, 0, &state)) { fclose(fp); return 0;} /* [ */
     for(i = 0; i < 256; i++) {
 	if (GetNextItem(fp, buf, i, &state)) { fclose(fp); return 0; }
-	strcpy(encnames[i].cname, buf+1);
+	strncpy(encnames[i].cname, buf+1, 39);
+	encnames[i].cname[39] = '\0';
 	strcat(enccode, " /"); strcat(enccode, encnames[i].cname);
 	if(i%8 == 7) strcat(enccode, "\n");
     }
diff -ubr R-3.3.2/src/library/grDevices/tests/ps-tests.Rout.save R-patched/src/library/grDevices/tests/ps-tests.Rout.save
--- R-3.3.2/src/library/grDevices/tests/ps-tests.Rout.save	2016-10-27 15:15:05.000000000 -0700
+++ R-patched/src/library/grDevices/tests/ps-tests.Rout.save	2017-02-14 15:15:11.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
@@ -95,4 +95,4 @@
 > 
 > proc.time()
    user  system elapsed 
-  0.391   0.022   0.400 
+  0.336   0.011   0.339 
diff -ubr R-3.3.2/src/library/grDevices/tests/xfig-tests.Rout.save R-patched/src/library/grDevices/tests/xfig-tests.Rout.save
--- R-3.3.2/src/library/grDevices/tests/xfig-tests.Rout.save	2016-10-27 15:15:05.000000000 -0700
+++ R-patched/src/library/grDevices/tests/xfig-tests.Rout.save	2017-02-14 15:15:11.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
@@ -102,4 +102,4 @@
 > 
 > proc.time()
    user  system elapsed 
-  0.169   0.013   0.169 
+  0.120   0.012   0.122 
diff -ubr R-3.3.2/src/library/graphics/man/boxplot.Rd R-patched/src/library/graphics/man/boxplot.Rd
--- R-3.3.2/src/library/graphics/man/boxplot.Rd	2015-08-25 15:17:08.000000000 -0700
+++ R-patched/src/library/graphics/man/boxplot.Rd	2016-12-02 15:15:09.000000000 -0800
@@ -164,14 +164,14 @@
 ## boxplot on a matrix:
 mat <- cbind(Uni05 = (1:100)/21, Norm = rnorm(100),
              `5T` = rt(100, df = 5), Gam2 = rgamma(100, shape = 2))
-boxplot(as.data.frame(mat),
-        main = "boxplot(as.data.frame(mat), main = ...)")
+boxplot(mat) # directly, calling boxplot.matrix()
+
+## boxplot on a data frame:
+df. <- as.data.frame(mat)
 par(las = 1) # all axis labels horizontal
-boxplot(as.data.frame(mat), main = "boxplot(*, horizontal = TRUE)",
-        horizontal = TRUE)
+boxplot(df., main = "boxplot(*, horizontal = TRUE)", horizontal = TRUE)
 
 ## Using 'at = ' and adding boxplots -- example idea by Roger Bivand :
-
 boxplot(len ~ dose, data = ToothGrowth,
         boxwex = 0.25, at = 1:3 - 0.2,
         subset = supp == "VC", col = "yellow",
Binary files R-3.3.2/src/library/grid/inst/doc/displaylist.pdf and R-patched/src/library/grid/inst/doc/displaylist.pdf differ
Binary files R-3.3.2/src/library/grid/inst/doc/frame.pdf and R-patched/src/library/grid/inst/doc/frame.pdf differ
Binary files R-3.3.2/src/library/grid/inst/doc/grid.pdf and R-patched/src/library/grid/inst/doc/grid.pdf differ
Binary files R-3.3.2/src/library/grid/inst/doc/grobs.pdf and R-patched/src/library/grid/inst/doc/grobs.pdf differ
Binary files R-3.3.2/src/library/grid/inst/doc/interactive.pdf and R-patched/src/library/grid/inst/doc/interactive.pdf differ
Binary files R-3.3.2/src/library/grid/inst/doc/locndimn.pdf and R-patched/src/library/grid/inst/doc/locndimn.pdf differ
Binary files R-3.3.2/src/library/grid/inst/doc/moveline.pdf and R-patched/src/library/grid/inst/doc/moveline.pdf differ
Binary files R-3.3.2/src/library/grid/inst/doc/nonfinite.pdf and R-patched/src/library/grid/inst/doc/nonfinite.pdf differ
Binary files R-3.3.2/src/library/grid/inst/doc/plotexample.pdf and R-patched/src/library/grid/inst/doc/plotexample.pdf differ
Binary files R-3.3.2/src/library/grid/inst/doc/rotated.pdf and R-patched/src/library/grid/inst/doc/rotated.pdf differ
Binary files R-3.3.2/src/library/grid/inst/doc/saveload.pdf and R-patched/src/library/grid/inst/doc/saveload.pdf differ
Binary files R-3.3.2/src/library/grid/inst/doc/sharing.pdf and R-patched/src/library/grid/inst/doc/sharing.pdf differ
Binary files R-3.3.2/src/library/grid/inst/doc/viewports.pdf and R-patched/src/library/grid/inst/doc/viewports.pdf differ
diff -ubr R-3.3.2/src/library/grid/tests/testls.Rout.save R-patched/src/library/grid/tests/testls.Rout.save
--- R-3.3.2/src/library/grid/tests/testls.Rout.save	2016-10-27 15:15:05.000000000 -0700
+++ R-patched/src/library/grid/tests/testls.Rout.save	2017-02-14 15:15:11.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
@@ -340,4 +340,4 @@
 > 
 > proc.time()
    user  system elapsed 
-  0.231   0.015   0.233 
+  0.241   0.008   0.237 
diff -ubr R-3.3.2/src/library/methods/R/BasicFunsList.R R-patched/src/library/methods/R/BasicFunsList.R
--- R-3.3.2/src/library/methods/R/BasicFunsList.R	2016-03-16 16:03:40.000000000 -0700
+++ R-patched/src/library/methods/R/BasicFunsList.R	2016-10-31 16:15:08.000000000 -0700
@@ -1,7 +1,7 @@
 #  File src/library/methods/R/BasicFunsList.R
 #  Part of the R package, https://www.R-project.org
 #
-#  Copyright (C) 1995-2014 The R Core Team
+#  Copyright (C) 1995-2016 The R Core Team
 #
 #  This program is free software; you can redistribute it and/or modify
 #  it under the terms of the GNU General Public License as published by
@@ -45,8 +45,7 @@
 , "%*%" = function(x, y) standardGeneric("%*%")
 , "xtfrm" = function(x) standardGeneric("xtfrm")
 ### these have a different arglist from the primitives
-, "c" = structure(function(x, ..., recursive = FALSE) standardGeneric("c"),
-                  signature="x")
+, "c" = structure(function(x, ...) standardGeneric("c"), signature="x")
 , "all" = structure(function(x, ..., na.rm = FALSE) standardGeneric("all"),
                     signature="x")
 , "any" = structure(function(x, ..., na.rm = FALSE) standardGeneric("any"),
diff -ubr R-3.3.2/src/library/methods/R/Methods.R R-patched/src/library/methods/R/Methods.R
--- R-3.3.2/src/library/methods/R/Methods.R	2016-10-04 02:14:53.000000000 -0700
+++ R-patched/src/library/methods/R/Methods.R	2017-01-11 15:15:14.000000000 -0800
@@ -672,7 +672,10 @@
     for(i in seq_along(where)) {
         wherei <- where[[i]]
         table <- get(fM, wherei, inherits=FALSE)
-        mi <- .findMethodInTable(signature, table, fdef)
+        ## because we are using the table from the package, we must
+        ## search for both the unexpanded & expanded signature, which
+        ## .findMethodInTable does not do.
+        mi <- .findMethodForFdef(signature, table, fdef)
         found[i] <- !is.null(mi)
     }
     value <- where[found]
diff -ubr R-3.3.2/src/library/methods/R/methodsTable.R R-patched/src/library/methods/R/methodsTable.R
--- R-3.3.2/src/library/methods/R/methodsTable.R	2016-03-16 16:03:40.000000000 -0700
+++ R-patched/src/library/methods/R/methodsTable.R	2017-01-11 15:15:14.000000000 -0800
@@ -743,9 +743,19 @@
     stop("Internal error in finding inherited methods; didn't return a unique method", domain = NA)
 }
 
-.findMethodInTable <- function(signature, table, fdef = NULL)
+.findMethodForFdef <- function(signature, table, fdef = NULL) {
+    value <- .findMethodInTable(signature, table, fdef)
+    if(is.null(value) && is(fdef, "genericFunction")) { # try without expanding signature
+        fullSig <- .matchSigLength(signature, fdef, environment(fdef), FALSE)
+        if(!identical(fullSig, signature))
+            value <- .findMethodInTable(signature, table, fdef, FALSE)
+    }
+    value
+}
+
+.findMethodInTable <- function(signature, table, fdef = NULL , expdSig = TRUE)
 {
-    if(is(fdef, "genericFunction"))
+    if(is(fdef, "genericFunction") && expdSig)
         signature <- .matchSigLength(signature, fdef, environment(fdef), FALSE)
     label <- .sigLabel(signature)
 ##     allMethods <- objects(table, all.names=TRUE)
diff -ubr R-3.3.2/src/library/methods/man/NextMethod.Rd R-patched/src/library/methods/man/NextMethod.Rd
--- R-3.3.2/src/library/methods/man/NextMethod.Rd	2016-10-09 15:15:08.000000000 -0700
+++ R-patched/src/library/methods/man/NextMethod.Rd	2017-01-09 15:15:15.000000000 -0800
@@ -38,29 +38,21 @@
   \code{defined} slot of the method from which \code{callNextMethod} is
   called) is deleted from a copy of the methods for the current generic,
   and \code{\link{selectMethod}} is called to find the next method (the
-  result is cached in a special object, so the search only typically
-  happens once per session per combination of argument classes).
+  result is cached in the method object where the call occurred, so the search typically
+  happens only once per session per combination of argument classes).
 
-  Note that the preceding definition means that the next method is
-  defined uniquely when \code{setMethod} inserts the method containing
-  the \code{callNextMethod} call, given the definitions of the classes
-  in the signature. The choice does not depend on the path that gets us
-  to that method (for example, through inheritance or from another
-  \code{callNextMethod} call). This definition was not enforced in
-  versions of \R prior to 2.3.0, where the method was selected based on
-  the target signature, and so could vary depending on the actual
-  arguments.
-
-  It is also legal, and often useful, for the method called by
-  \code{callNextMethod} to itself have a call to
-  \code{callNextMethod}. This generally works as you would expect, but
-  for completeness be aware that it is possible to have ambiguous
-  inheritance in the S structure, in the sense that the same two
-  classes can appear as superclasses \emph{in the opposite order} in
-  two other class definitions.  In this case the effect of a nested
-  instance of \code{callNextMethod} is not well defined.  Such
-  inconsistent class hierarchies are both rare and nearly always the
-  result of bad design, but they are possible, and currently undetected.
+  The next method is defined from the \emph{signature} of the current
+  method, not from the actual classes of the arguments.
+  In particular, modifying any of the arguments has no effect on the
+  selection.
+  As a result, the selected next method can be called with invalid
+  arguments if the calling function assigns objects of a different
+  class before the \code{callNextMethod()} call.
+  Be careful of any assignments to such arguments.
+
+  It is possible for the selection of the next method to be ambiguous,
+  even though the original set of methods was consistent.
+  See the section \dQuote{Ambiguous Selection}.
 
   The statement that the method is called with the current arguments is
   more precisely as follows.  Arguments that were missing in the current
@@ -71,17 +63,56 @@
   means that the next method sees the same actual arguments, but
   arguments are evaluated only once.
 }
+\section{Ambiguous Selection}{
+There are two fairly common situations in which the choice of a next
+method is ambiguous, even when the original set of methods uniquely
+defines all method selection unambiguously.
+In these situations, \code{callNextMethod()} should be replaced,
+either by a call to a specific function or by recalling the generic
+with different arguments.
+
+The most likely situation arises with methods for binary operators,
+typically through one of the group generic functions.
+See the example for class \code{"rnum"} below.
+Examples of this sort usually require three methods: two for the case
+that the first or the second argument comes from the class, and a
+third for the case that both arguments come from the class.
+If that last method uses \code{callNextMethod}, the other two methods
+are equally valid.  The ambiguity is exactly the same that required
+defining the two-argument method in the first place.
+
+In fact, the two possibilities are equally valid conceptually as well
+as formally.
+As in the example below, the logic of the application usually requires
+selecting a computation explicitly or else calling the generic
+function with modified arguments to select an appropriate method.
+
+The other likely source of ambiguity arises from a class that inherits
+directly from more than one other class (a \dQuote{mixin} in standard
+terminology).
+If the generic has methods corresponding to both superclasses, a
+method for the current class is again needed to resolve ambiguity.
+Using \code{callNextMethod} will again reimpose the ambiguity.
+Again, some explicit choice has to be made in the calling method
+instead.
+
+These ambiguities are not the result of bad design, but they do
+require workarounds.
+Other ambiguities usually reflect inconsistencies in the tree of
+inheritances, such as a class appearing in more than one place among
+the superclasses.
+Such cases should be rare, but with the independent definition of
+classes in multiple packages, they can't be ruled out.
+
+}
 \value{
   The value returned by the selected method.
 }
 \references{
- Chambers, John M. (2008)
- \emph{Software for Data Analysis: Programming with R}
-  Springer.  (For the R version.)
-
- Chambers, John M. (1998)
- \emph{Programming with Data}
- Springer (For the original S4 version.)
+  Chambers, John M. (2016)
+ \emph{Extending R},
+  Chapman & Hall.
+(Chapters 9 and 10.)
 }
 \seealso{\code{\link{callGeneric}} to call the generic function with the
  current dispatch rules (typically for a group generic function);
@@ -89,53 +120,145 @@
 }
 
 \examples{
+## callNextMethod() used for the Math, Math2 group generic functions
 
-## some class definitions with simple inheritance
-setClass("B0", slots = c(b0 = "numeric"))
-setClass("B1", slots = c(b1 = "character"), contains = "B0")
-setClass("B2", slots = c(b2 = "logical"), contains = "B1")
+## A class to automatically round numeric results to "d" digits
 
-## and a rather silly function to illustrate callNextMethod
+rnum <- setClass("rnum", slots = c(d = "integer"), contains = "numeric")
 
-f <- function(x) class(x)
+## Math functions operate on the rounded numbers, return a plain
+## vector.  The next method will always be the default, usually a primitive.
+setMethod("Math", "rnum",
+          function(x)
+              callNextMethod(round(as.numeric(x), x@d)))
+setMethod("Math2", "rnum",
+          function(x, digits)
+              callNextMethod(round(as.numeric(x), x@d), digits))
+
+## Examples of callNextMethod with two arguments in the signature.
+
+## For arithmetic and one rnum with anything, callNextMethod with no arguments
+## round the full accuracy result, and return as plain vector
+setMethod("Arith", c(e1 ="rnum"),
+          function(e1, e2)
+              as.numeric(round(callNextMethod(), e1@d)))
+setMethod("Arith", c(e2 ="rnum"),
+          function(e1, e2)
+              as.numeric(round(callNextMethod(), e2@d)))
+
+## A method for BOTH arguments from "rnum" would be ambiguous
+## for callNextMethod(): the two methods above are equally valid.
+## The method chooses the smaller number of digits,
+## and then calls the generic function, postponing the method selection
+## until it's not ambiguous.
+setMethod("Arith", c(e1 ="rnum", e2 = "rnum"),
+          function(e1, e2) {
+              if(e1@d <= e2@d)
+                  callGeneric(e1, as.numeric(e2))
+              else
+                  callGeneric(as.numeric(e1), e2)
+          })
+
+## For comparisons, callNextMethod with the rounded arguments
+setMethod("Compare", c(e1 = "rnum"),
+          function(e1, e2)
+              callNextMethod(round(e1, e1@d), round(e2, e1@d)))
+setMethod("Compare", c(e2 = "rnum"),
+          function(e1, e2)
+              callNextMethod(round(e1, e2@d), round(e2, e2@d)))
+
+## similarly to the Arith case, the method for two "rnum" objects
+## can not unambiguously use callNextMethod().  Instead, we rely on
+## The rnum() method inhertited from Math2 to return plain vectors.
+setMethod("Compare", c(e1 ="rnum", e2 = "rnum"),
+          function(e1, e2) {
+              d <- min(e1@d, e2@d)
+              callGeneric(round(e1, d), round(e2, d))
+          })
+
+
+
+
+set.seed(867)
+
+x1 <- rnum(10*runif(5), d=1L)
+x2 <- rnum(10*runif(5), d=2L)
+
+x1+1
+x2*2
+x1-x2
+
+## Simple examples to illustrate callNextMethod with and without arguments
+B0 <- setClass("B0", slots = c(s0 = "numeric"))
+
+## and a function to illustrate callNextMethod
+
+f <- function(x, text = "default") {
+    str(x) # print a summary
+    paste(text, ":", class(x))
+}
 
-setMethod("f", "B0", function(x) c(x@b0^2, callNextMethod()))
-setMethod("f", "B1", function(x) c(paste(x@b1,":"), callNextMethod()))
-setMethod("f", "B2", function(x) c(x@b2, callNextMethod()))
+setGeneric("f")
+setMethod("f", "B0", function(x, text = "B0") {
+    cat("B0 method called with s0 =", x@s0, "\n")
+    callNextMethod()
+})
 
-b1 <- new("B1", b0 = 2, b1 = "Testing")
+b0 <- B0(s0 = 1)
 
-b2 <- new("B2", b2 = FALSE, b1 = "More testing", b0 = 10)
+## call f() with 2 arguments: callNextMethod passes both to the default method
+f(b0, "first test")
 
-f(b2)
-stopifnot(identical(f(b2), c(b2@b2, paste(b2@b1,":"), b2@b0^2, "B2")))
+## call f() with 1 argument:  the default "B0" is not passed by callNextMethod
+f(b0)
+
+## Now, a class that extends B0, with no methods for f()
+B1 <- setClass("B1", slots = c(s1 = "character"), contains = "B0")
+b1 <- B1(s0 = 2, s1 = "Testing B1")
+
+## the two cases work as before, by inheriting the "B0" method
+
+f(b1, b1@s1)
 
 f(b1)
 
-## a sneakier method: the *changed* x is used:
-setMethod("f", "B2",
-          function(x) {x@b0 <- 111; c(x@b2, callNextMethod())})
+B2 <- setClass("B2", contains = "B1")
+
+## And, a method for "B2" that calls with explicit arguments.
+## Note that the method selection in callNextMethod
+## uses the class of the *argument* to consistently select the "B0" method
+
+setMethod("f", "B2", function(x, text = "B1 method") {
+    y <- B1(s0 = -x@s0, s1 ="Modified x")
+    callNextMethod(y, text)
+})
+
+b2 <- B2(s1 = "Testing B2", s0 = 10)
+
+f(b2, b2@s1)
+
 f(b2)
-stopifnot(identical(f(b2), c(b2@b2, paste(b2@b1,":"), 111^2, "B2")))
 
-\dontshow{
-## a version of the example with 1 more layer of nesting
 
-## next methods calling next methods, with arguments; using group generics
-setMethod("Ops", "B2",
-    function(e1, e2) callNextMethod())
-setMethod("Ops", c("B0"),
-    function(e1, e2) callNextMethod(e1@b0, e2))
+## Be careful:  the argument passed must be legal for the method selected
+## Although the argument here is numeric, it's still the "B0" method that's called
+setMethod("f", "B2", function(x, text = "B1 method") {
+    callNextMethod(x@s0, text)
+})
+
+##  Now the call will cause an error:
 
-b2 + 1 # 11
+tryCatch(f(b2), error = function(e) cat(e$message,"\n"))
 
-b1 == 2 # TRUE
 
+\dontshow{
+##$
 removeClass("B2"); removeClass("B1"); removeClass("B0")
 
 removeGeneric("f")
 
-removeMethods("Ops")
+removeMethods(all=FALSE,"Arith"); removeMethods(all=FALSE,"Compare")
+removeMethods(all=FALSE,"Math"); removeMethods(all=FALSE,"Math2")
 
 ## tests of multiple callNextMethod
 setClass("m1", slots = c(count = "numeric"), contains = "matrix",
@@ -177,7 +300,8 @@
 removeClass("m2")
 removeClass("m1")
 
-removeMethods("[")
+removeMethods(all=FALSE,"[")
+removeMethods(all=FALSE,"Ops")
 }
 
 }
diff -ubr R-3.3.2/src/library/methods/man/getMethod.Rd R-patched/src/library/methods/man/getMethod.Rd
--- R-3.3.2/src/library/methods/man/getMethod.Rd	2016-10-04 02:14:53.000000000 -0700
+++ R-patched/src/library/methods/man/getMethod.Rd	2017-01-11 15:15:14.000000000 -0800
@@ -11,45 +11,103 @@
 \alias{selectMethod}
 \alias{hasMethod}
 \description{
-  Functions to look for a method corresponding to a given generic function and signature.
-  The functions \code{getMethod} and \code{selectMethod} return the method; the functions
-  \code{existsMethod} and \code{hasMethod} test for its existence.  In both
-  cases the first function only gets direct definitions and the second
-  uses inheritance.  In all cases, the search is in the generic function itself or in
-  the package/environment specified by argument \code{where}.
-
-  The function \code{findMethod} returns the package(s) in the search
-  list (or in the packages specified by the \code{where} argument) that
-  contain a method for this function and signature.
+  The function \code{selectMethod()} returns the method that
+  would be selected for a call to function \code{f} if the arguments had
+  classes as specified by \code{signature}.  Failing to find a method
+  is an error, unless argument \code{optional = TRUE}, in which case
+  \code{NULL} is returned.
+
+  The function \code{findMethod()} returns a list of
+  environments that contain a method for the specified function and signature; by
+  default, these are a subset of the packages in the current search
+  list.  See section \dQuote{Using \code{findMethod()}} for details.
+
+The function \code{getMethod()} returns the method corresponding to the
+function and signature supplied similarly to \code{selectMethod}, but
+without using inheritance or group generics.
+
+The functions  \code{hasMethod()}  and
+\code{existsMethod()} test whether \code{selectMethod()} or
+\code{getMethod()}, respectively, finds a matching method.
+
+
 }
 \usage{
-existsMethod(f, signature = character(), where)
+  selectMethod(f, signature, optional = FALSE, useInherited =,
+             mlist = , fdef = , verbose = , doCache = )
 
   findMethod(f, signature, where)
 
-   getMethod(f, signature = character(), where, optional = FALSE, mlist, fdef)
+  getMethod(f, signature = character(), where, optional = FALSE,
+             mlist, fdef)
 
-   hasMethod(f, signature = character(), where)
+  existsMethod(f, signature = character(), where)
 
-selectMethod(f, signature, optional = FALSE, useInherited =,
-             mlist = , fdef = , verbose = , doCache = )
+  hasMethod(f, signature = character(), where)
 }
 \arguments{
   \item{f}{a generic function or the character-string name of one.}
   \item{signature}{the signature of classes to match to the arguments
     of \code{f}.  See the details below.}
-  \item{where}{the position or environment in which to look for the
-    method(s):  by default, the table of methods defined in the generic
-    function itself is used.}
+  \item{where}{the environment in which to look for the
+    method(s).  By default, if the call comes from the command line, the table of methods defined in the generic
+    function itself is used, except for \code{findMethod} (see the
+    section below).}
 
   \item{optional}{if the selection in \code{selectMethod} does not find
     a valid method an error is generated, unless \code{optional} is
-    true.  In that case, the value returned is \code{NULL} if no method
-    matches.}
+    \code{TRUE},  in which case the value returned is \code{NULL}.}
+
   \item{mlist, fdef, useInherited, verbose, doCache}{optional arguments
     to  \code{getMethod} and \code{selectMethod} for internal use.  Avoid
     these: some will work as expected and others will not, and none of
-    them is required for normal use of the functions.}
+    them is required for normal use of the functions.  But see the
+    section \dQuote{Methods for \code{as()}} for nonstandard inheritance.}
+}
+\section{Using \code{findMethod()}}{
+As its name suggests, this function is intended to behave like
+\code{\link{find}}, which produces a list of the packages on the
+current search list which have, and have exported, the object named.
+That's what \code{findMethod} does also, by default.  The
+\dQuote{exported} part in this case means that the package's namespace
+has an \code{exportMethods} directive for this generic function.
+
+An important distinction is that the absence of such a directive does
+not prevent methods from the package from being called once the
+package is loaded.  Otherwise, the code in the package could not use
+un-exported methods.
+
+So, if your question is whether loading package \code{thisPkg} will define a
+method for this function and signature, you need to ask that question
+about the namespace of the package:
+
+\code{findMethod(f, signature, where = asNamespace("thisPkg"))}
+
+If the package did not export the method, attaching it and calling
+\code{findMethod} with no \code{where} argument will not find the
+method.
+
+Notice also that the length of the signature must be what the
+corresponding package used.  If \code{thisPkg} had only methods for
+one argument, only length-1 signatures will match (no trailing
+\code{"ANY"}), even if another currently loaded package had signatures
+with more arguments.
+}
+\section{Methods for \code{as()}}{
+The function \code{\link{setAs}} allows packages to define methods for
+coercing one class of objects to another class.  This works internally
+by defining methods for the generic function \code{\link{coerce}(from,
+to)},
+which can not be called directly.
+
+The \R evaluator selects
+methods for this purpose using a different form of inheritance.  While
+methods can be inherited for the object being coerced, they cannot
+inherit for the target class, since the result would not be a valid
+object from that class.
+If you want to
+examine the selection procedure, you must supply the optional argument
+\code{useInherited = c(TRUE, FALSE)} to \code{selectMethod}.
 }
 \details{
   The \code{signature} argument specifies classes, corresponding to
@@ -76,11 +134,7 @@
   signature means to look for the default method.
 
   A call to \code{getMethod} returns the method for a particular
-  function and signature.  As with other \code{get} functions,
-  argument \code{where} controls where the function looks (by default
-  anywhere in the search list) and argument \code{optional} controls
-  whether the function returns \code{NULL} or generates an error if
-  the method is not found.  The search for the method makes no use of
+  function and signature.   The search for the method makes no use of
   inheritance.
 
   The function \code{selectMethod} also looks for a method given the
@@ -92,6 +146,15 @@
   returns \code{NULL} or generates an error if
   the method is not found, depending on the argument \code{optional}.
 
+Both \code{selectMethod} and \code{getMethod} will normally use the
+current version of the generic function in the R session, which has a
+table of the methods obtained from all the packages loaded in the
+session. Optional arguments can cause a search for the generic function from a
+specified environment, but this is rarely a useful idea.  In contrast,
+\code{findMethod} has a different default and the optional
+\code{where=} argument may be needed.  See the  section \dQuote{Using
+  \code{findMethod()}}.
+
   The functions \code{existsMethod} and \code{hasMethod} return
   \code{TRUE} or \code{FALSE} according to whether a method is found,
   the first corresponding to \code{getMethod} (no inheritance) and the
@@ -108,17 +171,23 @@
 
 The returned method object is a
   \code{\linkS4class{MethodDefinition}} object, \emph{except} that the default method for a primitive function is required to be the primitive itself.
-Note therefore that the only reliable test that the search failed is \code{is.null()}.
+Note therefore that the only reliable test that the search failed is
+\code{is.null()}.
+
+The returned value of \code{findMethod} is a list of
+environments in which a corresponding method was found; that is, a
+table of methods including the one specified.
 
 }
 \references{
+ Chambers, John M. (2016)
+ \emph{Extending R},
+  Chapman & Hall.
+(Chapters 9 and 10.)
+
  Chambers, John M. (2008)
  \emph{Software for Data Analysis: Programming with R}
-  Springer.  (For the R version.)
-
- Chambers, John M. (1998)
- \emph{Programming with Data}
- Springer (For the original S4 version.)
+  Springer. (Section 10.6 for some details of method selection.)
 }
 \seealso{\code{\link{Methods_Details}} for the details of method
   selection; \code{\link{GenericFunctions}} for other functions
@@ -126,25 +195,28 @@
   \code{\linkS4class{MethodDefinition}} for the class that represents
   method definitions.}
 \examples{
-setGeneric("testFun", function(x)standardGeneric("testFun"))
+testFun <-  function(x)x
+setGeneric("testFun")
 setMethod("testFun", "numeric", function(x)x+1)
-hasMethod("testFun", "numeric")
-\dontrun{[1] TRUE}
-hasMethod("testFun", "integer") #inherited
-\dontrun{[1] TRUE}
-existsMethod("testFun", "integer")
-\dontrun{[1] FALSE}
-hasMethod("testFun") # default method
-\dontrun{[1] FALSE}
+
+hasMethod("testFun", "numeric") # TRUE
+
+hasMethod("testFun", "integer") #TRUE, inherited
+
+existsMethod("testFun", "integer") #FALSE
+
+hasMethod("testFun") # TRUE, default method
+
 hasMethod("testFun", "ANY")
-\dontrun{[1] FALSE}
+
 \dontshow{
+## Verify the example
 stopifnot(isGeneric("testFun"),
           hasMethod("testFun", "numeric"),
           hasMethod("testFun", "integer"),
           !existsMethod("testFun", "integer"),
-          !hasMethod("testFun"),
-          !hasMethod("testFun", "ANY") )
+          hasMethod("testFun"),
+          hasMethod("testFun", "ANY") )
 removeGeneric("testFun")
 }
 }
diff -ubr R-3.3.2/src/library/methods/man/new.Rd R-patched/src/library/methods/man/new.Rd
--- R-3.3.2/src/library/methods/man/new.Rd	2016-10-09 15:15:08.000000000 -0700
+++ R-patched/src/library/methods/man/new.Rd	2017-01-09 15:15:15.000000000 -0800
@@ -1,6 +1,6 @@
 % File src/library/methods/man/new.Rd
 % Part of the R package, https://www.R-project.org
-% Copyright 1995-2016 R Core Team
+% Copyright 1995-2017 R Core Team
 % Distributed under GPL 2 or later
 
 \name{new}
@@ -8,9 +8,17 @@
 \alias{initialize}
 \title{ Generate an Object from a Class }
 \description{
-  Given the name or the definition of a class, plus optionally data
-  to be included in the object, \code{new} returns an object from that
-  class.
+  A call to  \code{new} returns a newly allocated object from the
+  class identified by the first argument.  This call in turn calls the
+  method for the generic function \code{initialize} corresponding to
+  the specified class, passing the \code{\dots} arguments to this
+method.
+In the default method for \code{initialize()}, named arguments provide
+values for the corresponding slots and unnamed arguments must be
+objects from superclasses of this class.
+
+A call to a generating function for a class (see
+\code{\link{setClass}}) will pass its \dots arguments to a corresponding call to \code{new()}.
 }
 \usage{
 new(Class, ...)
@@ -20,56 +28,44 @@
 \arguments{
   \item{Class}{either the name of a class, a \code{\link{character}}
     string, (the usual case) or the object describing the class (e.g.,
-    the value returned by \code{getClass}).}
-  \item{\dots}{data to include in the new object.  Named arguments
-    correspond to slots in the class definition. Unnamed arguments must
-    be objects from classes that this class extends.}
-  \item{.Object}{ An object:  see the Details section.}
-}
-\details{
-  The function \code{new} begins by copying the prototype object from
-  the class definition.  Then information is inserted according to the
-  \code{\dots} arguments, if any.  As of version 2.4 of R, the type of
-  the prototype object, and therefore of all objects returned by
-  \code{new()}, is \code{"S4"} except for classes that extend
-  one of the basic types, where the prototype has that basic type.  User
-  functions that depend on \code{\link{typeof}(object)} should be
-  careful to handle \code{"S4"} as a possible type.
-
-  Note that the \emph{name} of the first argument, \code{"Class"}
-  entails that \code{"Class"} is an undesirable slot name in any formal
-  class: \code{new("myClass", Class = <value>)} will not work.
-
-  The interpretation of the \code{\dots} arguments can be specialized to
-  particular classes, if an appropriate method has been defined for the
-  generic function \code{"initialize"}.  The \code{new} function calls
-  \code{initialize} with the object generated from the prototype as the
-  \code{.Object} argument to \code{initialize}.
+    the value returned by \code{getClass}). Note that the character
+    string passed from a generating function includes the package name
+  as an attribute, avoiding ambiguity if two packages have identically
+named classes.}
+  \item{\dots}{arguments to specify properties of the new object, to
+      be passed to \code{initialize()}.}
+  \item{.Object}{ An object:  see the \dQuote{Initialize Methods} section.}
+}
+\section{Initialize Methods}{
+The generic function \code{initialize} is not called directly.
+A call to \code{new} begins by copying the prototype object from
+  the class definition, and then calls \code{intialize()} with this
+  object as the first argument, followed by the \dots{} arguments. 
+
+  The interpretation of the \code{\dots} arguments in a call to a
+  generator function or to \code{new()} can be specialized to
+  particular classes, by defining an appropriate method for \code{"initialize"}. 
 
-  By default, unnamed arguments in the \code{\dots} are interpreted as
+  In the default method, unnamed arguments in the \code{\dots} are interpreted as
   objects from a superclass, and named arguments are interpreted as
-  objects to be assigned into the correspondingly named slots.  Thus,
-  explicit slots override inherited information for the same slot,
+  objects to be assigned into the correspondingly named slots.
+  Explicitly specified slots override inherited information for the same slot,
   regardless of the order in which the arguments appear.
 
   The \code{initialize} methods do not have to have \code{\dots} as
   their second argument (see the examples).  Initialize methods are
   often written when the natural parameters describing the new object
   are not the names of the slots.  If you do define such a method,
-  note the implications for future subclasses of your class.  If these
-  have additional slots, and your \code{initialize} method has
-  \code{\dots} as a formal argument, then your method should pass such
-  arguments along via \code{\link{callNextMethod}}.  If your method
-  does not have this argument, then either a subclass must have its
-  own method or else the added slots must be specified by users in
-  some way other than as arguments to \code{new}.
-
-  For examples of \code{initialize} methods, see
-  \code{\link{initialize-methods}} for existing methods for
-  classes \code{"traceable"} and \code{"environment"}, among
-  others. See the comments there on subclasses of
-  \code{"environment"}; any \code{initialize} methods for these should
-  be sure to allocate a new environment.
+you should include  \code{\dots} as a formal argument, and your method should pass such
+  arguments along via \code{\link{callNextMethod}}. 
+ This helps the definition of future subclasses of your class.  If these
+  have additional slots and your method
+  does \emph{not} have this argument, it will be difficult for these
+  slots to be included in an initializing call.
+
+  See
+  \code{\link{initialize-methods}} for a discussion of some classes with existing
+  methods. 
 
   Methods for \code{initialize} can be inherited only by simple
   inheritance, since it is a requirement that the method return an
@@ -79,15 +75,14 @@
 
   Note that the basic vector classes, \code{"numeric"}, etc. are
   implicitly defined, so one can use \code{new} for these classes.
+  The \dots arguments are interpreted as objects of this type and are
+  concatenated into the resulting vector.
 }
 \references{
- Chambers, John M. (2008)
- \emph{Software for Data Analysis: Programming with R}
-  Springer.  (For the R version.)
-
- Chambers, John M. (1998)
- \emph{Programming with Data}
- Springer (For the original S4 version.)
+ Chambers, John M. (2016)
+ \emph{Extending R},
+  Chapman & Hall.
+(Chapters 9 and 10.)
 }
 \seealso{ \link{Classes_Details} for details of class definitions, and
   \code{\link{setOldClass}} for the relation to S3 classes. }
@@ -110,40 +105,34 @@
 t2 <- new("trackCurve", t1, smooth = ysmooth)
 
 ### define a method for initialize, to ensure that new objects have
-### equal-length x and y slots.
+### equal-length x and y slots.  In this version, the slots must still be
+### supplied by name.
 
-setMethod("initialize",
-          "track",
-          function(.Object, x = numeric(0), y = numeric(0)) {
-            if(nargs() > 1) {
-              if(length(x) != length(y))
+setMethod("initialize", "track", 
+    function(.Object, ...) {
+      .Object <- callNextMethod()
+      if(length(.Object@x) != length(.Object@y))
                 stop("specified x and y of different lengths")
-              .Object@x <- x
-              .Object@y <- y
-            }
             .Object
           })
 
-### the next example will cause an error (x will be numeric(0)),
-### because we didn't build in defaults for x,
-### although we could with a more elaborate method for initialize
-
-try(new("track", y = sort(stats::rnorm(10))))
-
-## a better way to implement the previous initialize method.
-## Why?  By using callNextMethod to call the default initialize method
-## we don't inhibit classes that extend "track" from using the general
-## form of the new() function.  In the previous version, they could only
-## use x and y as arguments to new, unless they wrote their own
-## initialize method.
-
-setMethod("initialize", "track", function(.Object, ...) {
-    .Object <- callNextMethod()
-    if(length(.Object@x) != length(.Object@y))
+### An alternative version that allows x and y to be supplied
+### unnamed.  A still more friendly version would make the default x
+### a vector of the same length as y, and vice versa.
+
+setMethod("initialize", "track",
+          function(.Object, x = numeric(0), y = numeric(0), ...) {
+              .Object <- callNextMethod(.Object, ...)
+              if(length(x) != length(y))
      stop("specified x and y of different lengths")
+              .Object@x <- x
+              .Object@y <- y
     .Object
   })
 
+\dontshow{
+removeMethod("initialize", "track")
+}
 }
 \keyword{programming}
 \keyword{classes}
diff -ubr R-3.3.2/src/library/methods/man/setClass.Rd R-patched/src/library/methods/man/setClass.Rd
--- R-3.3.2/src/library/methods/man/setClass.Rd	2016-10-04 02:14:53.000000000 -0700
+++ R-patched/src/library/methods/man/setClass.Rd	2017-01-09 15:15:15.000000000 -0800
@@ -1,6 +1,6 @@
 % File src/library/methods/man/setClass.Rd
 % Part of the R package, https://www.R-project.org
-% Copyright 1995-2013 R Core Team
+% Copyright 1995-2017 R Core Team
 % Distributed under GPL 2 or later
 
 \name{setClass}
@@ -9,17 +9,19 @@
 \title{Create a Class Definition}
 \description{
   Create  a class definition and return a generator function to create
-  objects from the class.  Standard usage will be
-  of the form:
+  objects from the class.  Typical usage will be
+  of the style:
 
-   \code{setClass(Class, slots= , contains =)}
+   \code{myClass <- setClass("myClass", slots= ...., contains =....)}
 
- where \code{Class} is the name of the new class and, if supplied, the arguments    
+ where the first argument is the name of the new class and, if supplied, the arguments    
   \code{slots=} and \code{contains=} specify the slots
   in the new class and existing classes from which the new class
   should inherit.  Calls to \code{setClass()} are normally found in the
   source of a package; when the package is loaded the class will be
-  defined in the package's namespace.
+  defined in the package's namespace.  Assigning the generator
+  function with the name of the class is  convenient for users, but
+  not a requirement.
 }
 \usage{
 setClass(Class, representation, prototype, contains=character(),
@@ -28,16 +30,21 @@
 }
 \arguments{
   \item{Class}{character string name for the class.}
-  \item{slots}{  A named vector with the names being those of the slots in
-      the new class.  Each element of the vector specifies an
-      existing class; the corresponding slot must be from this class
-      or a subclass of it.  This argument
+  \item{slots}{  The names and classes for the slots in the new class.  This argument
       must be supplied by name, \code{slots=}, in the call, for back compatibility
       with other arguments no longer recommended.
 
+      The argument must be  vector with a names attribute, the names being those of the slots in
+      the new class.  Each element of the vector specifies an
+      existing class; the corresponding slot must be from this class
+      or a subclass of it.  Usually, this is a character vector
+      naming the classes.  It's also legal for the elements of the
+      vector to be class representation objects, as returned by \code{\link{getClass}}.
+
 
-    It is allowed to provide an unnamed character vector as a limiting
-    case, with the elements taken as slot names and all slots having
+    As a limiting
+    case,  the argument may be an unnamed character
+    vector;  the elements are  taken as slot names and all slots have
     the unrestricted class \code{"ANY"}.
   }
   \item{contains}{ A vector specifying existing classes from which
@@ -101,7 +108,8 @@
   which will be passed on to the initialize method.  If no
   \code{initialize} method is defined for the class or one of its
   superclasses, the default method expects named arguments with the
-  name of one of the slots.
+  name of one of the slots and unnamed arguments that are objects from
+  one of the contained classes.
 
   Typically the generator function is assigned the name of the class,
   for programming clarity.  This is not a requirement and objects
@@ -132,10 +140,15 @@
 The slots in a class definition will be the union of all the slots
 specified directly by \code{slots} and all the slots in all
 the contained classes.
-There can only be one slot with a given name; specifically, the
-direct and inherited slot names must be unique.
-That does not, however, prevent the same class from being inherited
-via more than one path.
+There can only be one slot with a given name.
+A class may override the definition of a slot with a given name, but
+\emph{only} if the newly specified class is a subclass of the
+inherited one.
+For example, if the contained class had a slot \code{a} with class
+\code{"ANY"}, then a subclass could specify \code{a} with class
+\code{"numeric"},
+but if the original specification for the slot was class
+\code{"character"}, the new call to \code{setClass} would generate an error.
 
 
 
@@ -220,12 +233,18 @@
 object in all contexts.
 It is possible to define a class that inherits from such types,
 through an indirect mechanism that stores the inherited object in a
-reserved slot.
+reserved slot, \code{".xData"}.
 See the
 example for class \code{"stampedEnv"} below.
+An object from such a class does \emph{not} have a \code{".Data"} pseudo-slot.
+
+For most computations, these classes behave transparently as if they
+inherited directly from the anomalous type.
 S3 method dispatch and the relevant \code{as.}\emph{type}\code{()}
 functions should behave correctly, but code that uses the type of the
 object directly will not.
+For example, \code{as.environment(e1)} would work as expected with the
+\code{"stampedEnv"} class, but \code{typeof(e1)} is \code{"S4"}.
 
 }
 
diff -ubr R-3.3.2/src/library/methods/man/validObject.Rd R-patched/src/library/methods/man/validObject.Rd
--- R-3.3.2/src/library/methods/man/validObject.Rd	2016-10-09 15:15:08.000000000 -0700
+++ R-patched/src/library/methods/man/validObject.Rd	2017-01-09 15:15:15.000000000 -0800
@@ -9,17 +9,33 @@
 \alias{setValidity}
 \title{ Test the Validity of an Object }
 \description{
-  The validity of \code{object} related to its class definition is
-  tested.  If the object is valid, \code{TRUE} is returned; otherwise,
-  either a vector of strings describing validity failures is returned,
-  or an error is generated (according to whether \code{test} is
-  \code{TRUE}).  Optionally, all slots in the object can also be validated.
-
-  The function \code{setValidity} sets the validity method of a class
-  (but more normally, this method will be supplied as the
-  \code{validity} argument to \code{\link{setClass}}).  The method
-  should be a function of one object that returns \code{TRUE} or a
+  \code{validObject()} tests the validity of \code{object} related to
+  its class definition; specifically, it checks that all slots
+  specified in the class definition are present and that the object in
+  the slot is from the required class or a subclass of that class.
+
+  If the object is valid, \code{TRUE} is returned; otherwise, an error
+  is generated, reporting all the validity failures encountered.
+If argument \code{test} is
+  \code{TRUE}, the errors are returned as a character vector rather
+  than generating an error.
+  
+
+  When an object from a class is initialized, the default method for
+  \code{\link{initialize}()} calls \code{validObject}.
+
+A class definition may have a validity method, set by a call to
+  the function \code{setValidity}, in the package or environment that
+  defines the class (or via the \code{validity} argument to \code{\link{setClass}}).  The method
+  should be a function of one object that returns \code{TRUE} or a character-string
   description of the non-validity.
+  If such a method exists, it will be called from \code{validObject}
+  and any strings from failure will be included in the result or the
+  error message.
+Any validity methods defined for superclasses (from the \code{contains=}
+argument to \code{\link{setClass}}, will also be called.
+
+
 }
 \usage{
 validObject(object, test = FALSE, complete = FALSE)
@@ -35,8 +51,8 @@
     function returns a vector of strings describing the problems.  If
     \code{test} is \code{FALSE} (the default) validity failure generates
     an error.}
-  \item{complete}{logical; if \code{TRUE}, validity methods will be
-    applied recursively to any of the slots that have such methods.}
+  \item{complete}{logical; if \code{TRUE}, \code{validObject} is
+      called recursively for each of the slots.  The default is \code{FALSE}.}
   \item{Class}{the name or class definition of the class whose validity
     method is to be set.}
   \item{ClassDef}{a class definition object, as from
@@ -48,35 +64,46 @@
     are found.  Unlike \code{validObject}, it should never generate an
     error.
   }
-  \item{where}{the modified class definition will be stored in this
-    environment.}
+  \item{where}{an environment to store the modified class
+      definition. Should be omitted, specifically  for calls from a package that defines the class.
+    The definition will be stored in the
+    namespace of the package.}
+
+}
+\section{Validity methods}{
+ A validity method must be a function of one argument; formally, that
+argument should be named \code{object}.
+If the argument has a different name, \code{setValidity} makes the
+substitution but in obscure cases that might fail, so it's wiser to
+name the
+ argument \code{object}.
+
+A good method checks all the possible errors and returns a character
+vector citing all the exceptions found, rather than returning after
+the first one.
+\code{validObject} will accumulate these errors in its error message
+or its return value.
 
-  Note that validity methods do not have to check validity of
-  superclasses: the logic of \code{validObject} ensures these tests are
-  done once only.  As a consequence, if one validity method wants to use
-  another, it should extract and call the method from the other
-  definition of the other class by calling \code{getValidity()}: it
-  should \emph{not} call \code{validObject}.
+Note that validity methods do not have to check validity of
+  superclasses: \code{validObject} calls such methods explicitly.
 }
 \details{
-  Validity testing takes place \sQuote{bottom up}: Optionally, if
-  \code{complete=TRUE}, the validity of the object's slots, if any, is
-  tested.  Then, in all cases, for each of the classes that this class
+  Validity testing takes place \sQuote{bottom up}, checking the slots,
+  then the superclasses, then the object's own validity method, if
+  there is one.
+
+For each slot and superclass, the existence of the specified class is
+checked.
+For each slot, the object in the slot is tested for inheritance from
+the corresponding class.
+If  \code{complete} is {TRUE},   \code{validObject} is called
+recursively for the object in the slot.
+
+Then, for each of the classes that this class
   extends (the \sQuote{superclasses}), the explicit validity method of
   that class is called, if one exists.  Finally, the validity method of
   \code{object}'s class is called, if there is one.
 
-  Testing generally stops at the first stage of finding an error, except
-  that all the slots will be examined even if a slot has failed its
-  validity test.
-
-  The standard validity test (with \code{complete=FALSE}) is applied
-  when an object is created via \code{\link{new}} with any optional
-  arguments (without the extra arguments the result is just the class
-  prototype object).
-
-  An attempt is made to fix up the definition of a validity method if
-  its argument is not \code{object}.
 }
 \value{
   \code{validObject} returns \code{TRUE} if the object is valid.
@@ -85,13 +112,10 @@
   with the corresponding strings in the error message.
 }
 \references{
- Chambers, John M. (2008)
- \emph{Software for Data Analysis: Programming with R}
-  Springer.  (For the R version.)
-
- Chambers, John M. (1998)
- \emph{Programming with Data}
- Springer (For the original S4 version.)
+Chambers, John M. (2016)
+ \emph{Extending R},
+  Chapman & Hall.
+(Chapters 9 and 10.)
 }
 \seealso{\code{\link{setClass}};
   class \code{\linkS4class{classRepresentation}}.
Binary files R-3.3.2/src/library/parallel/inst/doc/parallel.pdf and R-patched/src/library/parallel/inst/doc/parallel.pdf differ
diff -ubr R-3.3.2/src/library/parallel/tests/multicore2.Rout.save R-patched/src/library/parallel/tests/multicore2.Rout.save
--- R-3.3.2/src/library/parallel/tests/multicore2.Rout.save	2016-10-27 15:15:05.000000000 -0700
+++ R-patched/src/library/parallel/tests/multicore2.Rout.save	2017-02-14 15:15:11.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
@@ -45,4 +45,4 @@
 > 
 > proc.time()
    user  system elapsed 
-  0.154   0.019   0.260 
+  0.153   0.019   0.252 
diff -ubr R-3.3.2/src/library/parallel/tests/snow2.Rout.save R-patched/src/library/parallel/tests/snow2.Rout.save
--- R-3.3.2/src/library/parallel/tests/snow2.Rout.save	2016-10-27 15:15:05.000000000 -0700
+++ R-patched/src/library/parallel/tests/snow2.Rout.save	2017-02-14 15:15:11.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
@@ -50,4 +50,4 @@
 > 
 > proc.time()
    user  system elapsed 
-  0.161   0.022   0.591 
+  0.162   0.016   0.579 
diff -ubr R-3.3.2/src/library/splines/R/splineClasses.R R-patched/src/library/splines/R/splineClasses.R
--- R-3.3.2/src/library/splines/R/splineClasses.R	2015-10-15 15:15:07.000000000 -0700
+++ R-patched/src/library/splines/R/splineClasses.R	2017-01-30 15:15:13.000000000 -0800
@@ -1,7 +1,7 @@
 #  File src/library/splines/R/splineClasses.R
 #  Part of the R package, https://www.R-project.org
+#  Copyright (C) 2000-2017 The R Core Team
 #  Copyright (C) 1998 Douglas M. Bates and William N. Venables.
-#  Copyright (C) 2000-2015 The R Core Team
 #
 #  This program is free software; you can redistribute it and/or modify
 #  it under the terms of the GNU General Public License as published by
@@ -179,7 +179,7 @@
     coeff <- if(sparse) Matrix::solve(des, Matrix::..2dge(y), sparse=TRUE)
              else solve(des, y)
     value <- structure(list(knots = knots, coefficients = coeff, order = ord),
-		       formula = do.call(`~`, list(substitute(obj2), substitute(obj1))),
+		       formula = do.call("~", list(substitute(obj2), substitute(obj1))),
 		       class = c("nbSpline", "bSpline", "spline"))
     if (bSpline) return(value)
     ## else convert from B- to poly-Spline:
diff -ubr R-3.3.2/src/library/splines/src/splines.c R-patched/src/library/splines/src/splines.c
--- R-3.3.2/src/library/splines/src/splines.c	2016-03-16 16:04:09.000000000 -0700
+++ R-patched/src/library/splines/src/splines.c	2017-01-17 15:15:07.000000000 -0800
@@ -2,6 +2,7 @@
  *  S or S-PLUS or R.
  *
  *     Copyright (C) 1998 Douglas M. Bates and William N. Venables.
+ *     Copyright (C) 1999-2016 The R Core Team
  *
  * This program is free software; you can redistribute it and/or modify it
  * under the terms of the GNU General Public License as published by the
diff -ubr R-3.3.2/src/library/splines/tests/spline-tst.R R-patched/src/library/splines/tests/spline-tst.R
--- R-3.3.2/src/library/splines/tests/spline-tst.R	2016-03-16 16:04:08.000000000 -0700
+++ R-patched/src/library/splines/tests/spline-tst.R	2017-01-30 15:15:13.000000000 -0800
@@ -217,3 +217,8 @@
 all.equal(p0, p1,  tol=0)
 all.equal(p0, p2,  tol=0)
 all.equal(p1, p2,  tol=0)# interestingly almost the same
+
+## formula ==> print for default method
+ispl <- with(women, interpSpline( height, weight ))
+stopifnot(identical(format(formula(ispl)),
+		    "weight ~ height")) ## was wrongly .Primitive(\"~\")(wei...
diff -ubr R-3.3.2/src/library/stats/src/bandwidths.c R-patched/src/library/stats/src/bandwidths.c
--- R-3.3.2/src/library/stats/src/bandwidths.c	2015-08-25 15:16:09.000000000 -0700
+++ R-patched/src/library/stats/src/bandwidths.c	2017-01-16 15:15:11.000000000 -0800
@@ -1,7 +1,7 @@
 /*
  *  R : A Computer Language for Statistical Data Analysis
  *  bandwidth.c by W. N. Venables and B. D. Ripley  Copyright (C) 1994-2001
- *  Copyright (C) 2012-2014  The R Core Team
+ *  Copyright (C) 2012-2017  The R Core Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -53,10 +53,10 @@
 	double delta = i * d / h;
 	delta *= delta;
 	if (delta >= DELMAX) break;
-	term = exp(-delta / 4) - sqrt(8.0) * exp(-delta / 2);
+	term = exp(-delta / 4.) - sqrt(8.0) * exp(-delta / 2.);
 	sum += term * x[i];
     }
-    u = 1 / (2 * n * h * sqrt(PI)) + sum / (n * n * h * sqrt(PI));
+    u = 1 / (2. * n * h * sqrt(PI)) + sum / ((double)n * n * h * sqrt(PI));
     return ScalarReal(u);
 }
 
@@ -72,7 +72,7 @@
 	term = exp(-delta / 4) * (delta * delta - 12 * delta + 12);
 	sum += term * x[i];
     }
-    u = 1 / (2 * n * h * sqrt(PI)) + sum / (64 * n * n * h * sqrt(PI));
+    u = 1 / (2. * n * h * sqrt(PI)) + sum / (64. * n * n * h * sqrt(PI));
     return ScalarReal(u);
 }
 
@@ -84,11 +84,11 @@
     for (int i = 0; i < nbin; i++) {
 	double delta = i * d / h; delta *= delta;
 	if (delta >= DELMAX) break;
-	term = exp(-delta / 2) * (delta * delta - 6 * delta + 3);
+	term = exp(-delta / 2.) * (delta * delta - 6. * delta + 3.);
 	sum += term * x[i];
     }
-    sum = 2 * sum + n * 3;	/* add in diagonal */
-    u = sum / (n * (n - 1) * pow(h, 5.0) * sqrt(2 * PI));
+    sum = 2. * sum + n * 3.;	/* add in diagonal */
+    u = sum / ((double)n * (n - 1) * pow(h, 5.0) * sqrt(2 * PI));
     return ScalarReal(u);
 }
 
@@ -105,7 +105,7 @@
 	sum += term * x[i];
     }
     sum = 2 * sum - 15 * n;	/* add in diagonal */
-    u = sum / (n * (n - 1) * pow(h, 7.0) * sqrt(2 * PI));
+    u = sum / ((double)n * (n - 1) * pow(h, 7.0) * sqrt(2 * PI));
     return ScalarReal(u);
 }
 
@@ -135,7 +135,10 @@
 	int ii = (int)(x[i] / dd);
 	for (int j = 0; j < i; j++) {
 	    int jj = (int)(x[j] / dd);
-	    cnt[abs(ii - jj)]++;
+	    int bin = abs(ii - jj);
+	    if(cnt[bin] == INT_MAX)
+		error("maximum count exceeded in pairwise distance binning");
+	    cnt[bin]++;
 	}
     }
 
diff -ubr R-3.3.2/src/library/stats/tests/glm.Rout.save R-patched/src/library/stats/tests/glm.Rout.save
--- R-3.3.2/src/library/stats/tests/glm.Rout.save	2016-10-27 15:15:05.000000000 -0700
+++ R-patched/src/library/stats/tests/glm.Rout.save	2017-02-14 15:15:12.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
@@ -29,4 +29,4 @@
 > 
 > proc.time()
    user  system elapsed 
-  0.141   0.015   0.145 
+  0.139   0.014   0.142 
diff -ubr R-3.3.2/src/library/stats/tests/ks-test.Rout.save R-patched/src/library/stats/tests/ks-test.Rout.save
--- R-3.3.2/src/library/stats/tests/ks-test.Rout.save	2016-10-27 15:15:05.000000000 -0700
+++ R-patched/src/library/stats/tests/ks-test.Rout.save	2017-02-14 15:15:12.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
@@ -114,4 +114,4 @@
 > 
 > proc.time()
    user  system elapsed 
-  0.142   0.019   0.148 
+  0.104   0.007   0.102 
diff -ubr R-3.3.2/src/library/stats/tests/nls.Rout.save R-patched/src/library/stats/tests/nls.Rout.save
--- R-3.3.2/src/library/stats/tests/nls.Rout.save	2016-10-27 15:15:05.000000000 -0700
+++ R-patched/src/library/stats/tests/nls.Rout.save	2017-02-14 15:15:12.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
@@ -703,4 +703,4 @@
 > 
 > proc.time()
    user  system elapsed 
-  1.067   0.026   1.082 
+  1.076   0.023   1.091 
diff -ubr R-3.3.2/src/library/stats/tests/simulate.Rout.save R-patched/src/library/stats/tests/simulate.Rout.save
--- R-3.3.2/src/library/stats/tests/simulate.Rout.save	2016-10-27 15:15:05.000000000 -0700
+++ R-patched/src/library/stats/tests/simulate.Rout.save	2017-02-14 15:15:12.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
@@ -408,4 +408,4 @@
 > 
 > proc.time()
    user  system elapsed 
-  0.160   0.017   0.168 
+  0.217   0.018   0.224 
diff -ubr R-3.3.2/src/library/tcltk/R/tkGUI.R R-patched/src/library/tcltk/R/tkGUI.R
--- R-3.3.2/src/library/tcltk/R/tkGUI.R	2015-08-25 15:15:27.000000000 -0700
+++ R-patched/src/library/tcltk/R/tkGUI.R	2016-11-13 15:15:05.000000000 -0800
@@ -75,7 +75,7 @@
                          selectmode = "multiple")
 	load <- function() {
             s <- as.integer(tkcurselection(box))
-            if (!length(s)) return
+            if (!length(s)) return()
             lapply(pkglist[s+1L],  require,  character.only = TRUE)
             tkdestroy(tt)
 	}
@@ -93,7 +93,7 @@
                          selectmode = "multiple")
 	gogetem <- function() {
             s <- as.integer(tkcurselection(box))
-            if (!length(s)) return
+            if (!length(s)) return()
             utils::install.packages(l[s+1L])
             tkdestroy(tt)
 	}
@@ -113,7 +113,7 @@
         entry <- tkentry(Toolbar, textvariable = txtvar)
         showhelp <-  function() {
             s <- as.character(tclObj(txtvar))[1L]
-            if (!length(s)) return
+            if (!length(s)) return()
             nm <- as.name(s)
             print(eval(substitute(help(nm))))
             tclvalue(txtvar) <- ""
diff -ubr R-3.3.2/src/library/tools/R/QC.R R-patched/src/library/tools/R/QC.R
--- R-3.3.2/src/library/tools/R/QC.R	2016-10-10 15:15:06.000000000 -0700
+++ R-patched/src/library/tools/R/QC.R	2016-11-22 15:15:05.000000000 -0800
@@ -190,7 +190,10 @@
             code_objs <-
                 Filter(function(f) {
                     fdef <- code_env[[f]] # faster than get()
-                    if(is(fdef, "genericFunction"))
+                    ## Running methods::is() on data sets can trigger
+                    ## loading additional packages for which startup
+                    ## messages et al need suppressing ...
+                    if(suppressMessages(is(fdef, "genericFunction")))
                         fdef@package == pkgname
                     else
                         TRUE
diff -ubr R-3.3.2/src/library/tools/R/Rd2pdf.R R-patched/src/library/tools/R/Rd2pdf.R
--- R-3.3.2/src/library/tools/R/Rd2pdf.R	2016-03-16 16:03:29.000000000 -0700
+++ R-patched/src/library/tools/R/Rd2pdf.R	2017-02-01 15:15:08.000000000 -0800
@@ -388,7 +388,7 @@
                 R.version[["major"]], ".",  R.version[["minor"]],
                 " (r", R.version[["svn rev"]], ")\n", sep = "")
             cat("",
-                "Copyright (C) 1997-2009 The R Core Team.",
+                "Copyright (C) 1997-2015 The R Core Team.",
                 "This is free software; see the GNU General Public License version 2",
                 "or later for copying conditions.  There is NO warranty.",
                 sep="\n")
diff -ubr R-3.3.2/src/library/tools/R/Rprof.R R-patched/src/library/tools/R/Rprof.R
--- R-3.3.2/src/library/tools/R/Rprof.R	2015-08-25 15:16:54.000000000 -0700
+++ R-patched/src/library/tools/R/Rprof.R	2017-02-01 15:15:08.000000000 -0800
@@ -62,7 +62,7 @@
                 R.version[["major"]], ".",  R.version[["minor"]],
                 " (r", R.version[["svn rev"]], ")\n", sep = "")
             cat("",
-                "Copyright (C) 1997-2013 The R Core Team.",
+                "Copyright (C) 1997-2014 The R Core Team.",
                 "This is free software; see the GNU General Public License version 2",
                 "or later for copying conditions.  There is NO warranty.",
                 sep = "\n")
diff -ubr R-3.3.2/src/library/tools/R/build.R R-patched/src/library/tools/R/build.R
--- R-3.3.2/src/library/tools/R/build.R	2016-05-17 15:15:08.000000000 -0700
+++ R-patched/src/library/tools/R/build.R	2017-02-01 15:15:08.000000000 -0800
@@ -789,7 +789,7 @@
                 R.version[["major"]], ".",  R.version[["minor"]],
                 " (r", R.version[["svn rev"]], ")\n", sep = "")
             cat("",
-                "Copyright (C) 1997-2013 The R Core Team.",
+                "Copyright (C) 1997-2016 The R Core Team.",
                 "This is free software; see the GNU General Public License version 2",
                 "or later for copying conditions.  There is NO warranty.",
                 sep = "\n")
diff -ubr R-3.3.2/src/library/tools/R/check.R R-patched/src/library/tools/R/check.R
--- R-3.3.2/src/library/tools/R/check.R	2016-09-17 15:15:10.000000000 -0700
+++ R-patched/src/library/tools/R/check.R	2017-02-01 15:15:08.000000000 -0800
@@ -2793,7 +2793,14 @@
                              stdout = "", stderr = "", arch = arch)
             t2 <- proc.time()
             if (status) {
+                print_time(t1, t2, Log)
                 errorLog(Log)
+                if (Log$con > 0L && file.exists(tf)) {
+                    ## write results only to 00check.log
+                    lines <- readLines(tf, warn = FALSE)
+                    cat(lines, sep = "\n", file = Log$con)
+                    unlink(tf)
+                }
                 ## Don't just fail: try to log where the problem occurred.
                 ## First, find the test which failed.
                 ## (Maybe there was an error without a failing test.)
@@ -2805,14 +2812,27 @@
                     file <- bad_files[1L]
                     lines <- readLines(file, warn = FALSE)
                     file <- file.path(test_dir, sub("out\\.fail", "", file))
+                    keep <- as.integer(Sys.getenv("_R_CHECK_TESTS_NLINES_",
+                                                  "13"))
+                    ## keep = 0 means keep all of it, but we will
+                    ## always omit the R preamble and start at the first
+                    ## line with an R prompt.
+                    ll <- length(lines)
+                    st <- grep("^>", lines, useBytes = TRUE)
+                    if (length(st)) {
+                        lines <- lines[st[1L]:ll]
                     ll <- length(lines)
-                    lines <- lines[max(1, ll-12):ll]
+                    }
+                    if (keep > 0L)
+                        lines <- lines[max(1L, ll-keep-1L):ll]
                     if (R_check_suppress_RandR_message)
                         lines <- grep('^Xlib: *extension "RANDR" missing on display',
                                       lines, invert = TRUE, value = TRUE,
                                       useBytes = TRUE)
                     printLog(Log, sprintf("Running the tests in %s failed.\n", sQuote(file)))
-                    printLog(Log, "Last 13 lines of output:\n")
+                    printLog(Log, if(keep > 0L && keep < ll)
+                             sprintf("Last %i lines of output:\n", keep)
+                             else "Complete output:\n")
                     printLog0(Log, .format_lines_with_indent(lines), "\n")
                 }
                 return(FALSE)
@@ -2822,7 +2842,7 @@
                 if (Log$con > 0L && file.exists(tf)) {
                     ## write results only to 00check.log
                     lines <- readLines(tf, warn = FALSE)
-                    cat(lines, sep="\n", file = Log$con)
+                    cat(lines, sep = "\n", file = Log$con)
                     unlink(tf)
                 }
             }
@@ -3160,6 +3180,7 @@
                                 useBytes = TRUE)
                 warns <- grep("^Warning: file .* is not portable",
                               out, value = TRUE, useBytes = TRUE)
+                print_time(t1, t2, Log)
                 if (status) {
                     if(skip_run_maybe || !ran) warningLog(Log) else noteLog(Log)
                     out <- utils::tail(out, as.numeric(Sys.getenv("_R_CHECK_VIGNETTES_NLINES_", "25")))
@@ -3180,7 +3201,6 @@
                         unlink(vd2, recursive = TRUE)
                     if (!config_val_to_logical(Sys.getenv("_R_CHECK_ALWAYS_LOG_VIGNETTE_OUTPUT_", "false")))
                             unlink(outfile)
-                    print_time(t1, t2, Log)
                     resultLog(Log, "OK")
                 }
             } else {
@@ -3585,7 +3605,9 @@
                              ": warning: .* \\[-Wvla-extension\\]",
                              ": warning: format string contains '[\\]0'",
                              ": warning: .* \\[-Wc[+][+]11-long-long\\]",
-                             ": warning: empty macro arguments are a C99 feature"
+                             ": warning: empty macro arguments are a C99 feature",
+                             ## for non-portable flags (seen in sub-Makefiles)
+                             "warning: .* \\[-Wunknown-warning-option\\]"
                              )
 
                 warn_re <- paste0("(", paste(warn_re, collapse = "|"), ")")
@@ -4302,7 +4324,7 @@
                 R.version[["major"]], ".",  R.version[["minor"]],
                 " (r", R.version[["svn rev"]], ")\n", sep = "")
             cat("",
-                "Copyright (C) 1997-2013 The R Core Team.",
+                "Copyright (C) 1997-2016 The R Core Team.",
                 "This is free software; see the GNU General Public License version 2",
                 "or later for copying conditions.  There is NO warranty.",
                 sep="\n")
diff -ubr R-3.3.2/src/library/tools/R/install.R R-patched/src/library/tools/R/install.R
--- R-3.3.2/src/library/tools/R/install.R	2016-09-14 15:15:20.000000000 -0700
+++ R-patched/src/library/tools/R/install.R	2017-02-01 15:15:08.000000000 -0800
@@ -31,7 +31,7 @@
 ## tools:::.install_packages(c("--preclean", "--no-multiarch", "tree"))
 
 ##' @return ...
-.install_packages <- function(args = NULL)
+.install_packages <- function(args = NULL, no.q = interactive())
 {
     ## calls system() on Windows for
     ## sh (configure.win/cleanup.win) make zip
@@ -47,7 +47,14 @@
     ## Need these here in case of an early error, e.g. missing etc/Makeconf
     tmpdir <- ""
     clean_on_error <- TRUE
-    do_exit_on_error <- function()
+
+    do_exit <-
+	if(no.q)
+	    function(status = 1L) stop(".install_packages() exit status ", status)
+	else
+	    function(status = 1L) q("no", status = status, runLast = FALSE)
+
+    do_exit_on_error <- function(status = 1L)
     {
         ## If we are not yet processing a package, we will not have
         ## set curPkg
@@ -76,7 +83,7 @@
         }
 
         do_cleanup()
-        q("no", status = 1, runLast = FALSE)
+        do_exit(status=status)
     }
 
     do_cleanup <- function()
@@ -198,12 +205,14 @@
     }
 
 
-    # Check whether dir is a subdirectory of parent,
-    # to protect against malicious package names like ".." below
-    # Assumes that both directories exist
-
-    is_subdir <- function(dir, parent)
+    ## Check whether dir is a subdirectory of parent,
+    ## to protect against malicious package names like ".." below
+    ## Assumes that both directories exist
+    is_subdir <- function(dir, parent) {
+	rl <- Sys.readlink(dir) ## symbolic link (on POSIX, not Windows) is ok:
+	(!is.na(rl) && nzchar(rl)) ||
         normalizePath(parent) == normalizePath(file.path(dir, ".."))
+    }
 
     fullpath <- function(dir)
     {
@@ -269,7 +278,7 @@
             curPkg <<- pkg_name
         }
 
-        instdir <- file.path(lib, pkg_name)
+        instdir <- file.path(lib, pkg_name) # = <library>/<pkg>
         Sys.setenv(R_PACKAGE_NAME = pkg_name, R_PACKAGE_DIR = instdir)
         status <- .Rtest_package_depends_R_version()
         if (status) do_exit_on_error()
@@ -1200,7 +1209,8 @@
             ## On a Unix-alike this calls system(input=)
             ## and that uses a temporary file and redirection.
             cmd <- paste0("tools:::.test_load_package('", pkg_name, "', '", lib, "')")
-            ## R_LIBS was set already.  R_runR is in check.R
+            ## R_LIBS was set already, but Rprofile/Renviron may change it
+            ## R_runR is in check.R
             deps_only <-
                 config_val_to_logical(Sys.getenv("_R_CHECK_INSTALL_DEPENDS_", "FALSE"))
             env <- if (deps_only) setRlibs(lib0, self = TRUE, quote = TRUE) else ""
@@ -1221,8 +1231,8 @@
                     errmsg(msg) # does not return
                 }
             } else {
-                opts <- if (deps_only) "--vanilla --slave"
-                else "--no-save --slave"
+                opts <- paste(if(deps_only) "--vanilla" else "--no-save",
+                              "--slave")
                 out <- R_runR(cmd, opts, env = env)
                 if(length(out))
                     cat(paste(c(out, ""), collapse = "\n"))
@@ -1292,18 +1302,18 @@
         a <- args[1L]
         if (a %in% c("-h", "--help")) {
             Usage()
-            q("no", runLast = FALSE)
+            do_exit(0)
         }
         else if (a %in% c("-v", "--version")) {
             cat("R add-on package installer: ",
                 R.version[["major"]], ".",  R.version[["minor"]],
                 " (r", R.version[["svn rev"]], ")\n", sep = "")
             cat("",
-                "Copyright (C) 2000-2013 The R Core Team.",
+                "Copyright (C) 2000-2016 The R Core Team.",
                 "This is free software; see the GNU General Public License version 2",
                 "or later for copying conditions.  There is NO warranty.",
                 sep = "\n")
-            q("no", runLast = FALSE)
+	    do_exit(0)
         } else if (a %in% c("-c", "--clean")) {
             clean <- TRUE
             shargs <- c(shargs, "--clean")
@@ -1599,14 +1609,14 @@
                     " for modifying\nTry removing ", sQuote(lockdir),
                     domain = NA)
             do_cleanup_tmpdir()
-            q("no", status = 3, runLast = FALSE)
+            do_exit(status = 3)
         }
         dir.create(lockdir, recursive = TRUE)
         if (!dir.exists(lockdir)) {
             message("ERROR: failed to create lock directory ", sQuote(lockdir),
                     domain = NA)
             do_cleanup_tmpdir()
-            q("no", status = 3, runLast = FALSE)
+            do_exit(status = 3)
         }
         if (debug) starsmsg(stars, "created lock directory ", sQuote(lockdir))
     }
diff -ubr R-3.3.2/src/library/tools/R/utils.R R-patched/src/library/tools/R/utils.R
--- R-3.3.2/src/library/tools/R/utils.R	2016-10-19 15:15:03.000000000 -0700
+++ R-patched/src/library/tools/R/utils.R	2017-02-02 15:15:06.000000000 -0800
@@ -1,7 +1,7 @@
 #  File src/library/tools/R/utils.R
 #  Part of the R package, https://www.R-project.org
 #
-#  Copyright (C) 1995-2016 The R Core Team
+#  Copyright (C) 1995-2017 The R Core Team
 #
 #  This program is free software; you can redistribute it and/or modify
 #  it under the terms of the GNU General Public License as published by
@@ -1730,9 +1730,16 @@
     }
     ## Avoid declared encodings when writing out.
     Encoding(x) <- "unknown"
-    ## Avoid folding for fields where we keep whitespace when reading.
+
+    ## Avoid folding for fields where we keep whitespace when reading,
+    ## plus two where legacy code does not strip whitespace and so
+    ## we should not wrap the field.  In R 3.3.x, read.dcf can
+    ## add newlines, so we strip here.
+     if(!is.na(x["BugReports"]))
+         x["BugReports"] <- trimws(x["BugReports"])
     write.dcf(rbind(x), dfile,
-              keep.white = c(.keep_white_description_fields, "Maintainer"))
+              keep.white = c(.keep_white_description_fields,
+                             "Maintainer", "BugReports"))
 }
 
 ### ** .read_repositories
diff -ubr R-3.3.2/src/library/tools/man/getVignetteInfo.Rd R-patched/src/library/tools/man/getVignetteInfo.Rd
--- R-3.3.2/src/library/tools/man/getVignetteInfo.Rd	2013-06-23 15:05:03.000000000 -0700
+++ R-patched/src/library/tools/man/getVignetteInfo.Rd	2017-02-02 15:15:06.000000000 -0800
@@ -1,3 +1,8 @@
+% File src/library/tools/man/CRANtools.Rd
+% Part of the R package, https://www.R-project.org
+% Copyright 2013 R Core Team
+% Distributed under GPL 2 or later
+
 \name{getVignetteInfo}
 \alias{getVignetteInfo}
 \title{
diff -ubr R-3.3.2/src/library/tools/man/vignetteEngine.Rd R-patched/src/library/tools/man/vignetteEngine.Rd
--- R-3.3.2/src/library/tools/man/vignetteEngine.Rd	2015-08-25 15:16:58.000000000 -0700
+++ R-patched/src/library/tools/man/vignetteEngine.Rd	2016-12-04 15:15:14.000000000 -0800
@@ -1,6 +1,6 @@
 % File src/library/tools/man/vignetteEngine.Rd
 % Part of the R package, https://www.R-project.org
-% Copyright 2013-2014 R Core Team
+% Copyright 2013-2016 R Core Team
 % Distributed under GPL 2 or later
 
 \name{vignetteEngine}
@@ -19,7 +19,8 @@
 }
 \arguments{
   \item{name}{the name of the engine.}
-  \item{weave}{a function to convert vignette source files to LaTeX output.}
+  \item{weave}{a function to convert vignette source files to PDF/HTML or
+intermediate LaTeX output.}
   \item{tangle}{a function to convert vignette source files to \R code.}
   \item{pattern}{a regular expression pattern for the filenames handled
     by this engine, or \code{NULL} for the default pattern.}
diff -ubr R-3.3.2/src/library/utils/R/bug.report.R R-patched/src/library/utils/R/bug.report.R
--- R-3.3.2/src/library/utils/R/bug.report.R	2015-08-25 15:16:37.000000000 -0700
+++ R-patched/src/library/utils/R/bug.report.R	2017-01-09 15:15:14.000000000 -0800
@@ -1,7 +1,7 @@
 #  File src/library/utils/R/unix/bug.report.R
 #  Part of the R package, https://www.R-project.org
 #
-#  Copyright (C) 1995-2012 The R Core Team
+#  Copyright (C) 1995-2017 The R Core Team
 #
 #  This program is free software; you can redistribute it and/or modify
 #  it under the terms of the GNU General Public License as published by
@@ -37,7 +37,7 @@
 {
     baseR <- function() {
         writeLines(c("  Bug reports on R and the base packages need to be submitted",
-                     "  to the tracker at http://bugs.r-project.org/ .",
+                     "  to the tracker at <https://bugs.R-project.org/>.",
                      "",
                      "  We will now try to open that website in a browser"))
         flush.console()
@@ -62,17 +62,27 @@
     info <- c(info, "", bug.report.info())
     if(identical(DESC$Priority, "base")) return(baseR())
 
-    if (!is.null(DESC$BugReports)) {
+    BR <- DESC$BugReports
+    if (!is.null(BR) && nzchar(BR)) {
+        BR <- trimws(BR)  # some packages have e.g. leading \n
+        if (grepl("^https?://", BR)) {
         writeLines(info)
         cat("\nThis package has a bug submission web page, which we will now attempt\n",
-            "to open.  The information above may be useful in your report. If the web\n",
-            "page doesn't work, you should send email to the maintainer,\n",
+                "to open.  The information above may be useful in your report.\n",
+                "If the web page does not work, you should send email to the maintainer,\n",
             DESC$Maintainer, ".\n",
             sep = "")
         flush.console()
         Sys.sleep(2)
-        browseURL(DESC$BugReports)
+            browseURL(BR)
         return(invisible())
+        } else {
+            cat("This package has a BugReports field which is not the URL of a web page:\n\n",
+                "  BugReports: ", BR,
+                "\n\nWe will ignore it and email the maintainer.\n\n", sep = "")
+            flush.console()
+            Sys.sleep(2)
+       }
     }
 
     if (missing(address)) address <- findEmail(DESC$Maintainer)
diff -ubr R-3.3.2/src/library/utils/R/objects.R R-patched/src/library/utils/R/objects.R
--- R-3.3.2/src/library/utils/R/objects.R	2016-03-16 16:03:21.000000000 -0700
+++ R-patched/src/library/utils/R/objects.R	2016-12-10 15:15:05.000000000 -0800
@@ -117,9 +117,7 @@
                 generic.function <- truegf
             }
         }
-	name <- paste0("^", generic.function, ".")
-        name <- gsub("([.[$+*])", "\\\\\\1",name)
-        info <- info[grep(name, row.names(info)), ]
+	info <- info[startsWith(row.names(info), paste0(generic.function,".")), ]
         info <- info[! row.names(info) %in% S3MethodsStopList, ]
         ## check that these are all functions
         ## might be none at this point
@@ -143,8 +141,8 @@
             if (typeof(genfun) == "closure") environment(genfun)
             else .BaseNamespaceEnv
         }
-        S3reg <- ls(get(".__S3MethodsTable__.", envir = defenv),
-                    pattern = name)
+	S3reg <- names(get(".__S3MethodsTable__.", envir = defenv))
+	S3reg <- S3reg[startsWith(S3reg, paste0(generic.function,"."))]
         if(length(S3reg))
             info <- rbindSome(info, S3reg, msg =
                               paste("registered S3method for",
@@ -264,6 +262,7 @@
     }
     method <- paste(f, class, sep=".")
     if(!is.null(m <- get0(method, envir = envir, mode = "function")))
+	## FIXME(?): consider  tools::nonS3methods(<pkg>)  same as isS3method()
         return(m)
     ## also look for registered method in namespaces
     defenv <- if(!is.na(w <- .knownS3Generics[f])) asNamespace(w)
@@ -289,26 +288,31 @@
 {
     if(missing(method)) {
         method <- paste(f, class, sep=".")
-    } else { # !missing(method) : use (f, class)
+    } else { # determine (f, class) from 'method'
 	f.c <- strsplit(method, ".", fixed=TRUE)[[1]]
-	if(length(f.c) < 2 || !is.character(f.c))
+	nfc <- length(f.c)
+	if(nfc < 2 || !is.character(f.c))
 	    return(FALSE) ## stop("Invalid 'method' specification; must be  \"<fun>.<class>\"")
-	f <- f.c[1]
-	class <- if(length(f.c) > 2) ## e.g., t.data.frame
-		     paste(f.c[-1], collapse=".")
-		 else
-		     f.c[2]
+	if(nfc == 2) {
+	    f     <- f.c[[1L]]
+	    class <- f.c[[2L]]
+	} else { ## nfc > 2 : e.g., t.data.frame, is.na.data.frame
+	    for(j in 2:nfc)
+		if(isS3method(f     = paste(f.c[1:(j-1)], collapse="."),
+			      class = paste(f.c[j: nfc ], collapse="."),
+			      envir = envir))
+		    return(TRUE)
+	    return(FALSE)
+	}
     }
     if(!any(f == getKnownS3generics())) { ## either a known generic or found in 'envir'
-        truegf <- findGeneric(f, envir)
-        if(nzchar(truegf)) f <- truegf
-        else
+	if(!nzchar(f <- findGeneric(f, envir)))
             return(FALSE)
     }
     if(!is.null(m <- get0(method, envir = envir, mode = "function"))) {
 	## know: f is a knownS3generic, and method m is a visible function
 	pkg <- if(isNamespace(em <- environment(m))) environmentName(em)
-	       else if(is.primitive(m)) "base" else NULL
+	       else if(is.primitive(m)) "base" ## else NULL
 	return(is.na(match(method, tools::nonS3methods(pkg)))) ## TRUE unless an exception
     }
     ## also look for registered method in namespaces
diff -ubr R-3.3.2/src/library/utils/R/unix/download.file.R R-patched/src/library/utils/R/unix/download.file.R
--- R-3.3.2/src/library/utils/R/unix/download.file.R	2016-03-16 16:03:20.000000000 -0700
+++ R-patched/src/library/utils/R/unix/download.file.R	2017-02-14 15:15:12.000000000 -0800
@@ -1,7 +1,7 @@
 #  File src/library/utils/R/unix/download.file.R
 #  Part of the R package, https://www.R-project.org
 #
-#  Copyright (C) 1995-2015 The R Core Team
+#  Copyright (C) 1995-2017 The R Core Team
 #
 #  This program is free software; you can redistribute it and/or modify
 #  it under the terms of the GNU General Public License as published by
@@ -32,12 +32,28 @@
 	method <-
 	    if(capabilities("libcurl") && grepl("^(ht|f)tps:", url))
 		"libcurl"
-            else "internal"
+            else "internal2"
     }
 
     switch(method,
 	   "internal" = {
 	       status <- .External(C_download, url, destfile, quiet, mode, cacheOK)
+               if (status == 2L) stop(gettextf("cannot open URL '%s'", url))
+	       ## needed for Mac GUI from download.packages etc
+	       if(!quiet) flush.console()
+	   },
+	   "internal2" = {
+               ## want redirection warning immediately
+               if(getOption('warn') == 0L) {
+                   op <- options(warn = 1L)
+                   on.exit(options(op))
+               }
+	       status <- .External(C_download, url, destfile, quiet, mode, cacheOK)
+               if (status == 2L) {
+                   if(!quiet)
+                       message('switching to method = "libcurl" because of redirection to https')
+                   status <- .Internal(curlDownload(url, destfile, quiet, mode, cacheOK))
+               }
 	       ## needed for Mac GUI from download.packages etc
 	       if(!quiet) flush.console()
 	   },
Binary files R-3.3.2/src/library/utils/inst/doc/Sweave.pdf and R-patched/src/library/utils/inst/doc/Sweave.pdf differ
diff -ubr R-3.3.2/src/library/utils/man/browseURL.Rd R-patched/src/library/utils/man/browseURL.Rd
--- R-3.3.2/src/library/utils/man/browseURL.Rd	2016-09-14 15:15:24.000000000 -0700
+++ R-patched/src/library/utils/man/browseURL.Rd	2017-01-09 15:15:15.000000000 -0800
@@ -1,6 +1,6 @@
 % File src/library/utils/man/browseURL.Rd
 % Part of the R package, https://www.R-project.org
-% Copyright 1995-2015 R Core Team
+% Copyright 1995-2017 R Core Team
 % Distributed under GPL 2 or later
 
 \name{browseURL}
@@ -14,7 +14,9 @@
           encodeIfNeeded = FALSE)
 }
 \arguments{
-  \item{url}{a non-empty character string giving the URL to be loaded.}
+  \item{url}{a non-empty character string giving the URL to be loaded.
+   Some platforms also accept file paths.
+  }
   \item{browser}{a non-empty character string giving the name of the
     program to be used as the HTML browser.  It should be in the PATH,
     or a full path specified.  Alternatively, an \R function to be
@@ -61,8 +63,7 @@
   remote host.
 
   It is the caller's responsibility to encode \code{url} if necessary
-  (see \code{\link{URLencode}}).  This can be tricky for file URLs,
-  where the format accepted can depend on both browser and OS.
+  (see \code{\link{URLencode}}).
 
   To suppress showing URLs altogether, set \code{browser = "false"}.
   
@@ -95,4 +96,13 @@
           browser = "C:/Program Files/Mozilla Firefox/firefox.exe")
 }}
 #endif
+\section{URL schemes}{
+  Which URL schemes are accepted is platform-specific: expect
+  \samp{http://}, \samp{https://} and \samp{ftp://} to work, but
+  \samp{mailto:} may or may not (and if it does may not use the user's
+  preferred email client).
+  
+  For the \samp{file://} scheme the format accepted (if any) can depend on
+  both browser and OS.
+}
 \keyword{file}
diff -ubr R-3.3.2/src/library/utils/man/download.file.Rd R-patched/src/library/utils/man/download.file.Rd
--- R-3.3.2/src/library/utils/man/download.file.Rd	2016-09-14 15:15:24.000000000 -0700
+++ R-patched/src/library/utils/man/download.file.Rd	2017-02-14 15:15:12.000000000 -0800
@@ -1,6 +1,6 @@
 % File src/library/utils/man/download.file.Rd
 % Part of the R package, https://www.R-project.org
-% Copyright 1995-2016 R Core Team
+% Copyright 1995-2017 R Core Team
 % Distributed under GPL 2 or later
 
 \name{download.file}
@@ -38,7 +38,7 @@
 
   \item{mode}{character.  The mode with which to write the file.  Useful
     values are \code{"w"}, \code{"wb"} (binary), \code{"a"} (append) and
-    \code{"ab"}.  Only used for the \code{"internal"} method.
+    \code{"ab"}.  Not used for methods \code{"wget"} and \code{"curl"}.
 #ifdef windows
     (See also \sQuote{Details}.)
 #endif
@@ -59,7 +59,8 @@
   If \code{method = "auto"} is chosen (the default), on a Unix-alike
   method \code{"libcurl"} is chosen for \samp{https://} and
   \samp{ftps://} URLs and the \code{"internal"} method is chosen for
-  other schemes.
+  other schemes.  If redirection from \samp{http://} to \samp{https://}
+  is encountered, the download is re-tried with method \code{"libcurl"}.
 #endif
 #ifdef windows
   If \code{method = "auto"} is chosen (the default), on Windows the
@@ -99,10 +100,12 @@
   \code{\link{available.packages}}.
 
   The \code{"libcurl"} and \code{"wget"} methods follow \samp{http://}
-  and \samp{https://} redirections: the \code{"internal"} method does not.
-  (For method \code{"curl"} use argument \code{extra = "-L"}. To disable
-  redirection in \command{wget}, use \code{extra = "--max-redirect=0"}.)
-  (The \code{"wininet"} method supports some redirections but not all.)
+  and \samp{https://} redirections to any scheme they support: the
+  \code{"internal"} method follows \samp{http://} to \samp{http://}
+  redirections only.  (For method \code{"curl"} use argument \code{extra
+  = "-L"}.  To disable redirection in \command{wget}, use \code{extra =
+  "--max-redirect=0"}.)  The \code{"wininet"} method supports some
+  redirections but not all.
   
   Note that \samp{https://} URLs are not supported by the
   \code{"internal"} method but are supported by the \code{"libcurl"}
@@ -115,7 +118,7 @@
   does not support them.
 
   Most methods do not percent-encode special characters such as spaces
-  in URLs (see \code{\link{URLencode}}), but it seems the
+  in HTTP URLs (see \code{\link{URLencode}}), but it seems the
   \code{"wininet"} method does.
 
   The remaining details apply to the \code{"internal"}, \code{"wininet"}
@@ -252,11 +255,26 @@
   \samp{ftp:} URLs are accessed using the FTP protocol which has a
   number of variants.  One distinction is between \sQuote{active} and
   \sQuote{(extended) passive} modes: which is used is chosen by the
-  client.  The \code{"internal"} and \code{"libcurl"} method use passive
+  client.  The \code{"internal"} and \code{"libcurl"} methods use passive
   mode, and that is almost universally used by browsers.  Prior to \R
-  3.2.3 the \code{"wininet"} method used active mode: since it first
+  3.2.3 the \code{"wininet"} method used active mode: nowadays it first
   tries passive and then active.
 }
+\section{Good practice}{
+  Setting the \code{method} should be left to the end user.  Neither of
+  the \command{wget} nor \command{curl} commands is widely available:
+  you can check if one is available \emph{via} \code{\link{Sys.which}},
+  and should do so in a package or script.
+  
+  If you use \code{download.file} in a package or script, you must check
+  the return value, since it is possible that the download will fail
+  with a non-zero status but not an \R error.
+
+  The supported \code{method}s do change: method \code{libcurl} was
+  introduced in \R 3.2.0 and is still optional on Windows -- use
+  \code{\link{capabilities}("libcurl")} in a program to see if it is
+  available.
+}
 \value{
   An (invisible) integer code, \code{0} for success and non-zero for
   failure.  For the \code{"wget"} and \code{"curl"} methods this is the
diff -ubr R-3.3.2/src/library/utils/man/install.packages.Rd R-patched/src/library/utils/man/install.packages.Rd
--- R-3.3.2/src/library/utils/man/install.packages.Rd	2016-10-04 02:14:55.000000000 -0700
+++ R-patched/src/library/utils/man/install.packages.Rd	2016-12-01 15:15:04.000000000 -0800
@@ -352,6 +352,8 @@
   See \code{\link{download.file}} for how to handle proxies and
   other options to monitor file transfers.
 
+  \code{\link{untar}} for manually unpacking source package tarballs.
+  
   \code{\link{INSTALL}}, \code{\link{REMOVE}}, \code{\link{remove.packages}},
   \code{\link{library}}, \code{\link{.packages}}, \code{\link{read.dcf}}
 
diff -ubr R-3.3.2/src/library/utils/man/isS3method.Rd R-patched/src/library/utils/man/isS3method.Rd
--- R-3.3.2/src/library/utils/man/isS3method.Rd	2016-03-16 16:03:24.000000000 -0700
+++ R-patched/src/library/utils/man/isS3method.Rd	2016-11-03 16:15:07.000000000 -0700
@@ -1,6 +1,6 @@
 % File src/library/utils/man/isS3method.Rd
 % Part of the R package, https://www.R-project.org
-% Copyright 1995-2015 R Core Team
+% Copyright 1995-2016 R Core Team
 % Distributed under GPL 2 or later
 
 \name{isS3method}
@@ -42,6 +42,12 @@
 isS3method("t.data.frame")# TRUE
 isS3method("t.lm")        # FALSE - not existing
 isS3method("t.foo.bar")   # FALSE - not existing
+
+## S3 methods with "4 parts" in their name:
+ff <- c("as.list", "as.matrix", "is.na", "row.names", "row.names<-")
+for(m in ff) if(isS3method(m)) stop("wrongly declared an S3 method: ", m)
+(m4 <- paste(ff, "data.frame", sep="."))
+for(m in m4) if(!isS3method(m)) stop("not an S3 method: ", m)
 \dontshow{
 stopifnot(
   !isS3method("t"), !isS3method("t.test"), !isS3method("qr.coef"), !isS3method("sort.list"),
diff -ubr R-3.3.2/src/library/utils/man/tar.Rd R-patched/src/library/utils/man/tar.Rd
--- R-3.3.2/src/library/utils/man/tar.Rd	2016-10-04 02:14:55.000000000 -0700
+++ R-patched/src/library/utils/man/tar.Rd	2016-12-17 15:15:07.000000000 -0800
@@ -135,6 +135,21 @@
   conventional to discard fractional seconds.
 }
 
+\note{
+  For users of macOS (formerly OS X).  Apple's HFS and HFS+ file systems
+  have a legacy concept of \sQuote{resource forks} dating from classic
+  Mac OS and rarely used nowadays.  Apple's version of \command{tar}
+  stores these as separate files in the tarball with names prefixed by
+  \file{._}, and unpacks such files into resource forks (if possible):
+  other ways of unpacking (including \code{\link{untar}} in \R) unpack
+  them as separate files.
+
+  When argument \code{tar} is set to the command \command{tar} on macOS,
+  environment variable \env{COPYFILE_DISABLE=1} is set, which for the
+  system version of \command{tar} prevents these separate files being
+  included in the tarball.
+}
+
 \seealso{
   \url{https://en.wikipedia.org/wiki/Tar_(file_format)},
   \url{http://pubs.opengroup.org/onlinepubs/9699919799/utilities/pax.html#tag_20_92_13_06}
diff -ubr R-3.3.2/src/library/utils/man/untar.Rd R-patched/src/library/utils/man/untar.Rd
--- R-3.3.2/src/library/utils/man/untar.Rd	2016-10-04 02:14:55.000000000 -0700
+++ R-patched/src/library/utils/man/untar.Rd	2016-12-17 15:15:07.000000000 -0800
@@ -114,6 +114,10 @@
   map filenames to those acceptable on the current system, and treats
   the filenames in the archive as applicable without any re-encoding in
   the current locale.
+
+  The internal implementation does not special-case \sQuote{resource
+  forks} in macOS: that system's \command{tar} command does. This may
+  lead to unexpected files with names with prefix \file{._}.
 }
 
 \value{
diff -ubr R-3.3.2/src/library/utils/man/unzip.Rd R-patched/src/library/utils/man/unzip.Rd
--- R-3.3.2/src/library/utils/man/unzip.Rd	2015-08-25 15:16:48.000000000 -0700
+++ R-patched/src/library/utils/man/unzip.Rd	2016-12-01 15:15:04.000000000 -0800
@@ -1,6 +1,6 @@
 % File src/library/utils/man/unzip.Rd
 % Part of the R package, https://www.R-project.org
-% Copyright 1995-2015 R Core Team
+% Copyright 1995-2016 R Core Team
 % Distributed under GPL 2 or later
 
 \name{unzip}
@@ -84,7 +84,10 @@
 \seealso{
   \code{\link{unz}} to read a single component from a zip file.
 
-  \code{\link{zip}}.
+  \code{\link{zip}} for packing, i.e., the \dQuote{inverse} of \code{unzip()};
+  further \code{\link{untar}} and \code{\link{tar}}, the corresponding
+  pair for (un)packing tar archives (\dQuote{tarballs}) such as \R
+  source packages.
 }
 
 \keyword{file}
diff -ubr R-3.3.2/src/library/utils/man/zip.Rd R-patched/src/library/utils/man/zip.Rd
--- R-3.3.2/src/library/utils/man/zip.Rd	2015-08-25 15:16:49.000000000 -0700
+++ R-patched/src/library/utils/man/zip.Rd	2016-12-01 15:15:04.000000000 -0800
@@ -1,6 +1,6 @@
 % File src/library/utils/man/zip.Rd
 % Part of the R package, https://www.R-project.org
-% Copyright 1995-2011 R Core Team
+% Copyright 1995-2016 R Core Team
 % Distributed under GPL 2 or later
 
 \name{zip}
@@ -42,7 +42,8 @@
   The status value returned by the external command, invisibly.
 }
 \seealso{
-  \code{\link{unzip}}, \code{\link{unz}}.
+  \code{\link{unzip}}, \code{\link{unz}}; further, \code{\link{tar}} and
+  \code{\link{untar}} for (un)packing tar archives.
 }
 
 \keyword{file}
diff -ubr R-3.3.2/src/main/Rdynload.c R-patched/src/main/Rdynload.c
--- R-3.3.2/src/main/Rdynload.c	2016-03-16 16:04:15.000000000 -0700
+++ R-patched/src/main/Rdynload.c	2017-01-15 15:15:06.000000000 -0800
@@ -128,6 +128,10 @@
 int nCPFun = 0;
 #endif
 
+/* Note that it is likely that dlopen will use up at least one file
+   descriptor for each DLL loaded (it may load further dynamically
+   linked libraries), so we do not want to get close to the fd limit
+   (which may be as low as 256). */
 #define MAX_NUM_DLLS	100
 
 static int CountDLL = 0;
diff -ubr R-3.3.2/src/main/apply.c R-patched/src/main/apply.c
--- R-3.3.2/src/main/apply.c	2016-03-16 16:04:17.000000000 -0700
+++ R-patched/src/main/apply.c	2016-11-01 16:15:07.000000000 -0700
@@ -1,6 +1,6 @@
 /*
  *  R : A Computer Language for Statistical Data Analysis
- *  Copyright (C) 2000-2015  The R Core Team
+ *  Copyright (C) 2000-2016  The R Core Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -136,7 +136,7 @@
 	/* Build call: FUN(XX[[<ind>]], ...) */
 
 	SEXP isym = install("i");
-	PROTECT(ind = allocVector(INTSXP, 1));
+	PROTECT(ind = allocVector(realIndx ? REALSXP : INTSXP, 1));
 	defineVar(isym, ind, rho);
 	SET_NAMED(ind, 1);
 
diff -ubr R-3.3.2/src/main/connections.c R-patched/src/main/connections.c
--- R-3.3.2/src/main/connections.c	2016-09-14 15:15:29.000000000 -0700
+++ R-patched/src/main/connections.c	2017-02-14 15:15:13.000000000 -0800
@@ -1,6 +1,6 @@
 /*
  *  R : A Computer Language for Statistical Data Analysis
- *  Copyright (C) 2000-2016   The R Core Team.
+ *  Copyright (C) 2000-2017   The R Core Team.
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -5203,12 +5203,30 @@
 	con->canseek = 0;
     /* This is referenced in do_getconnection, so set up before
        any warning */
-    con->ex_ptr = PROTECT(R_MakeExternalPtr(con->id, install("connection"), R_NilValue));
+    con->ex_ptr = PROTECT(R_MakeExternalPtr(con->id, install("connection"), 
+					    R_NilValue));
 
     /* open it if desired */
     if(strlen(open)) {
 	Rboolean success = con->open(con);
 	if(!success) {
+	    if(defmeth && meth == 0 && winmeth == 0 && 
+	       ((Rurlconn)(con->private))->status == 2) {
+		warning("\"internal\" method failed, so trying \"libcurl\"");
+		con_close1(con);
+		con = R_newCurlUrl(url, open, 1);
+		Connections[ncon] = con;
+		con->blocking = block;
+		strncpy(con->encname, CHAR(STRING_ELT(enc, 0)), 100);
+		con->encname[100 - 1] = '\0';
+		UNPROTECT(1);
+		con->ex_ptr = 
+		    PROTECT(R_MakeExternalPtr(con->id, install("connection"), 
+					      R_NilValue));
+		success = con->open(con);
+	    }
+	}
+	if(!success) {
 	    con_destroy(ncon);
 	    error(_("cannot open the connection"));
 	}
diff -ubr R-3.3.2/src/main/datetime.c R-patched/src/main/datetime.c
--- R-3.3.2/src/main/datetime.c	2016-09-14 15:15:29.000000000 -0700
+++ R-patched/src/main/datetime.c	2016-12-14 15:15:06.000000000 -0800
@@ -299,14 +299,12 @@
 }
 
 #ifndef HAVE_POSIX_LEAPSECONDS
-/* There have (2015/07) been 26 leapseconds: see .leap.seconds in R
- */
-static int n_leapseconds = 26;
-static const time_t leapseconds[] =
+static int n_leapseconds = 27; // 2017-01, sync with .leap.seconds in R (!)
+static const time_t leapseconds[] = // dput(unclass(.leap.seconds)) :
 {  78796800, 94694400,126230400,157766400,189302400,220924800,252460800,
   283996800,315532800,362793600,394329600,425865600,489024000,567993600,
   631152000,662688000,709948800,741484800,773020800,820454400,867715200,
-   915148800,1136073600,1230768000,1341100800,1435708800};
+   915148800,1136073600,1230768000,1341100800,1435708800,1483228800};
 #endif
 
 static double guess_offset (stm *tm)
@@ -764,6 +762,7 @@
     return ans;
 }
 
+// .Internal(as.POSIXct(x, tz)) -- called only from  as.POSIXct.POSIXlt()
 SEXP attribute_hidden do_asPOSIXct(SEXP call, SEXP op, SEXP args, SEXP env)
 {
     SEXP stz, x, ans;
@@ -776,7 +775,7 @@
 
     checkArity(op, args);
     PROTECT(x = duplicate(CAR(args))); /* coerced below */
-    if(!isVectorList(x) || LENGTH(x) < 9)
+    if(!isVectorList(x) || LENGTH(x) < 9) // must be 'POSIXlt'
 	error(_("invalid '%s' argument"), "x");
     if(!isString((stz = CADR(args))) || LENGTH(stz) != 1)
 	error(_("invalid '%s' value"), "tz");
@@ -806,9 +805,10 @@
     if(n > 0) {
 	for(int i = 0; i < 6; i++)
 	    if(nlen[i] == 0)
-		error(_("zero-length component in non-empty \"POSIXlt\" structure"));
+		error(_("zero-length component [[%d]] in non-empty \"POSIXlt\" structure"),
+		      i+1);
 	if(nlen[8] == 0)
-	    error(_("zero-length component in non-empty \"POSIXlt\" structure"));
+	    error(_("zero-length component [[%d]] in non-empty \"POSIXlt\" structure"), 9);
     }
     /* coerce fields to integer or real */
     SET_VECTOR_ELT(x, 0, coerceVector(VECTOR_ELT(x, 0), REALSXP));
@@ -828,7 +828,7 @@
 	tm.tm_mon   = INTEGER(VECTOR_ELT(x, 4))[i%nlen[4]];
 	tm.tm_year  = INTEGER(VECTOR_ELT(x, 5))[i%nlen[5]];
 	/* mktime ignores tm.tm_wday and tm.tm_yday */
-	tm.tm_isdst = isgmt ? 0:INTEGER(VECTOR_ELT(x, 8))[i%nlen[8]];
+	tm.tm_isdst = isgmt ? 0 : INTEGER(VECTOR_ELT(x, 8))[i%nlen[8]];
 	if(!R_FINITE(secs) || tm.tm_min == NA_INTEGER ||
 	   tm.tm_hour == NA_INTEGER || tm.tm_mday == NA_INTEGER ||
 	   tm.tm_mon == NA_INTEGER || tm.tm_year == NA_INTEGER)
@@ -904,7 +904,8 @@
     if(n > 0) {
 	for(int i = 0; i < 9; i++)
 	    if(nlen[i] == 0)
-		error(_("zero-length component in non-empty \"POSIXlt\" structure"));
+		error(_("zero-length component [[%d]] in non-empty \"POSIXlt\" structure"),
+		      i+1);
     }
     R_xlen_t N = (n > 0) ? ((m > n) ? m : n) : 0;
     SEXP ans = PROTECT(allocVector(STRSXP, N));
@@ -915,6 +916,8 @@
 #else
     Rboolean have_zone = LENGTH(x) >= 10 && XLENGTH(VECTOR_ELT(x, 9)) == n;
 #endif
+    if(have_zone && !isString(VECTOR_ELT(x, 9)))
+	error(_("invalid component [[10]] in \"POSIXlt\" should be 'zone'"));
     for(R_xlen_t i = 0; i < N; i++) {
 	double secs = REAL(VECTOR_ELT(x, 0))[i%nlen[0]], fsecs = floor(secs);
 	// avoid (int) NAN
@@ -1254,9 +1257,10 @@
     if(n > 0) {
 	for(int i = 3; i < 6; i++)
 	    if(nlen[i] == 0)
-		error(_("zero-length component in non-empty \"POSIXlt\" structure"));
+		error(_("zero-length component [[%d]] in non-empty \"POSIXlt\" structure"),
+		      i+1);
 	if(nlen[8] == 0)
-	    error(_("zero-length component in non-empty \"POSIXlt\" structure"));
+	    error(_("zero-length component [[%d]] in non-empty \"POSIXlt\" structure"), 9);
     }
     /* coerce relevant fields to integer */
     for(int i = 3; i < 6; i++)
diff -ubr R-3.3.2/src/main/dounzip.c R-patched/src/main/dounzip.c
--- R-3.3.2/src/main/dounzip.c	2015-08-25 15:18:43.000000000 -0700
+++ R-patched/src/main/dounzip.c	2017-01-05 15:15:05.000000000 -0800
@@ -496,12 +496,14 @@
     if(!new->class) {
 	free(new);
 	error(_("allocation of 'unz' connection failed"));
+	/* for Solaris 12.5 */ new = NULL;
     }
     strcpy(new->class, "unz");
     new->description = (char *) malloc(strlen(description) + 1);
     if(!new->description) {
 	free(new->class); free(new);
 	error(_("allocation of 'unz' connection failed"));
+	/* for Solaris 12.5 */ new = NULL;
     }
     init_con(new, description, CE_NATIVE, mode);
 
@@ -519,6 +521,7 @@
     if(!new->private) {
 	free(new->description); free(new->class); free(new);
 	error(_("allocation of 'unz' connection failed"));
+	/* for Solaris 12.5 */ new = NULL;
     }
     return new;
 }
diff -ubr R-3.3.2/src/main/eval.c R-patched/src/main/eval.c
--- R-3.3.2/src/main/eval.c	2016-10-14 15:15:12.000000000 -0700
+++ R-patched/src/main/eval.c	2016-12-03 15:15:08.000000000 -0800
@@ -2254,8 +2254,11 @@
 	    if (TYPEOF(h) == DOTSXP || h == R_NilValue) {
 		while (h != R_NilValue) {
 		    ev = CONS_NR(eval(CAR(h), rho), R_NilValue);
-		    if (head==R_NilValue)
+		    if (head==R_NilValue) {
+			UNPROTECT(1); /* h */
 			PROTECT(head = ev);
+			PROTECT(h); /* put current h on top of protect stack */
+		    }
 		    else
 			SETCDR(tail, ev);
 		    COPY_TAG(ev, h);
@@ -4079,6 +4082,10 @@
 #ifdef THREADED_CODE
 typedef union { void *v; int i; } BCODE;
 
+/* Declare opinfo volatile to prevent gcc 6 from making a local copy
+   in bcEval stack frames and thus increasing stack usage
+   dramatically */
+volatile
 static struct { void *addr; int argc; } opinfo[OPCOUNT];
 
 #define OP(name,n) \
@@ -6169,6 +6176,7 @@
     }
     else {
 	code = allocVector(INTSXP, m * n);
+	memset(INTEGER(code), 0, m * n * sizeof(int));
 	pc = (BCODE *) INTEGER(code);
 
 	for (i = 0; i < n; i++) pc[i].i = ipc[i];
diff -ubr R-3.3.2/src/main/grep.c R-patched/src/main/grep.c
--- R-3.3.2/src/main/grep.c	2016-10-14 15:15:12.000000000 -0700
+++ R-patched/src/main/grep.c	2016-11-05 16:15:04.000000000 -0700
@@ -1,7 +1,7 @@
 /*
  *  R : A Computer Language for Statistical Data Analysis
  *  Copyright (C) 1995, 1996  Robert Gentleman and Ross Ihaka
- *  Copyright (C) 1997--2015  The R Core Team
+ *  Copyright (C) 1997--2016  The R Core Team
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Pulic License as published by
@@ -982,7 +982,10 @@
 static R_size_t fgrepraw1(SEXP pat, SEXP text, R_size_t offset) {
     Rbyte *haystack = RAW(text), *needle = RAW(pat);
     R_size_t n = LENGTH(text);
-    switch (LENGTH(pat)) { /* it may be silly but we optimize small needle
+    R_size_t ncmp = LENGTH(pat);
+    if (n < ncmp)
+	return (R_size_t) -1;
+    switch (ncmp) { /* it may be silly but we optimize small needle
 			      searches, because they can be used to match
 			      single UTF8 chars (up to 3 bytes) */
     case 1:
@@ -999,7 +1002,8 @@
 	{
 	    n--;
 	    while (offset < n) {
-		if (haystack[offset] == needle[0] && haystack[offset + 1] == needle[1])
+		if (haystack[offset    ] == needle[0] &&
+		    haystack[offset + 1] == needle[1])
 		    return offset;
 		offset++;
 	    }
@@ -1019,9 +1023,8 @@
 	}
     default:
 	{
-	    R_size_t ncmp = LENGTH(pat);
-	    n -= ncmp;
 	    ncmp--;
+	    n -= ncmp;
 	    while (offset < n) {
 		if (haystack[offset] == needle[0] &&
 		    !memcmp(haystack + offset + 1, needle + 1, ncmp))
@@ -1030,7 +1033,7 @@
 	    }
 	}
     }
-    return -1;
+    return (R_size_t) -1;
 }
 
 /* grepRaw(pattern, text, offset, ignore.case, fixed, value, all, invert) */
diff -ubr R-3.3.2/src/main/main.c R-patched/src/main/main.c
--- R-3.3.2/src/main/main.c	2016-09-14 15:15:31.000000000 -0700
+++ R-patched/src/main/main.c	2016-11-03 16:15:05.000000000 -0700
@@ -1365,8 +1365,8 @@
     }
 
     if(!name) {
-	char buf[10];
-	snprintf(buf, 10, "%d", which+1);
+	char buf[20];
+	snprintf(buf, 20, "%d", which+1);
 	el->name = strdup(buf);
     } else
 	el->name = strdup(name);
diff -ubr R-3.3.2/src/main/memory.c R-patched/src/main/memory.c
--- R-3.3.2/src/main/memory.c	2016-10-14 15:15:12.000000000 -0700
+++ R-patched/src/main/memory.c	2016-12-17 15:15:06.000000000 -0800
@@ -2461,7 +2461,6 @@
     SEXP s;     /* For the generational collector it would be safer to
 		   work in terms of a VECSEXP here, but that would
 		   require several casts below... */
-    R_len_t i;
     R_size_t size = 0, alloc_size, old_R_VSize;
     int node_class;
 #if VALGRIND_LEVEL > 0
@@ -2614,7 +2613,7 @@
 	else {
 	    node_class = LARGE_NODE_CLASS;
 	    alloc_size = size;
-	    for (i = 2; i < NUM_SMALL_NODE_CLASSES; i++) {
+	    for (int i = 2; i < NUM_SMALL_NODE_CLASSES; i++) {
 		if (size <= NodeClassSize[i]) {
 		    node_class = i;
 		    alloc_size = NodeClassSize[i];
@@ -2737,7 +2736,7 @@
 #if VALGRIND_LEVEL > 1
 	VALGRIND_MAKE_MEM_DEFINED(STRING_PTR(s), actual_size);
 #endif
-	for (i = 0; i < length; i++)
+	for (R_xlen_t i = 0; i < length; i++)
 	    data[i] = R_NilValue;
     }
     else if(type == STRSXP) {
@@ -2745,7 +2744,7 @@
 #if VALGRIND_LEVEL > 1
 	VALGRIND_MAKE_MEM_DEFINED(STRING_PTR(s), actual_size);
 #endif
-	for (i = 0; i < length; i++)
+	for (R_xlen_t i = 0; i < length; i++)
 	    data[i] = R_BlankString;
     }
     else if (type == CHARSXP || type == intCHARSXP) {
diff -ubr R-3.3.2/src/main/mkdtemp.c R-patched/src/main/mkdtemp.c
--- R-3.3.2/src/main/mkdtemp.c	2016-03-16 16:04:16.000000000 -0700
+++ R-patched/src/main/mkdtemp.c	2016-12-15 15:15:04.000000000 -0800
@@ -20,7 +20,7 @@
    with R modifications for randomness and Win32.  
 
    mkdtemp was required by POSIX 2008: we use this substitute on
-   Windows and Solaris 10.
+   Windows (and formerly on Solaris).
 */
 
 #ifdef HAVE_CONFIG_H
diff -ubr R-3.3.2/src/main/platform.c R-patched/src/main/platform.c
--- R-3.3.2/src/main/platform.c	2016-06-21 15:15:09.000000000 -0700
+++ R-patched/src/main/platform.c	2017-01-07 15:15:08.000000000 -0800
@@ -569,10 +569,13 @@
 	    LOGICAL(ans)[i] = 0;
 	else {
 #ifdef Win32
-	    wchar_t from[PATH_MAX+1], *to;
+	    wchar_t from[PATH_MAX+1], *to, *p;
 	    struct _stati64 sb;
 	    from[PATH_MAX] = L'\0';
-	    wcsncpy(from, filenameToWchar(STRING_ELT(f1, i%n1), TRUE), PATH_MAX);
+	    p = filenameToWchar(STRING_ELT(f1, i%n1), TRUE);
+	    if (wcslen(p) >= PATH_MAX)
+	    	error(_("'%s' path too long"), "from");
+	    wcsncpy(from, p, PATH_MAX);
 	    /* This Windows system call does not accept slashes */
 	    for (wchar_t *p = from; *p; p++) if (*p == L'/') *p = L'\\';
 	    to = filenameToWchar(STRING_ELT(f2, i%n2), TRUE);
@@ -643,9 +646,11 @@
 	    LOGICAL(ans)[i] = 0;
 	else {
 #ifdef Win32
-	    wchar_t from[PATH_MAX+1], *to;
-	    from[PATH_MAX] = L'\0';
-	    wcsncpy(from, filenameToWchar(STRING_ELT(f1, i%n1), TRUE), PATH_MAX);
+	    wchar_t from[PATH_MAX+1], *to, *p;
+	    p = filenameToWchar(STRING_ELT(f1, i%n1), TRUE);
+	    if (wcslen(p) >= PATH_MAX)
+	    	error(_("'%s' path too long"), "from");
+	    wcscpy(from, p);
 	    to = filenameToWchar(STRING_ELT(f2, i%n2), TRUE);
 	    LOGICAL(ans)[i] = CreateHardLinkW(to, from, NULL) != 0;
 	    if(!LOGICAL(ans)[i]) {
@@ -2152,7 +2157,10 @@
     if (show == NA_LOGICAL) show = 0;
     recursive = asLogical(CADDR(args));
     if (recursive == NA_LOGICAL) recursive = 0;
-    wcscpy(dir, filenameToWchar(STRING_ELT(path, 0), TRUE));
+    p = filenameToWchar(STRING_ELT(path, 0), TRUE);
+    if (wcslen(p) >= MAX_PATH)
+    	error(_("'%s' too long"), "path");
+    wcsncpy(dir, p, MAX_PATH);
     for (p = dir; *p; p++) if (*p == L'/') *p = L'\\';
     /* remove trailing slashes */
     p = dir + wcslen(dir) - 1;
@@ -2347,17 +2355,19 @@
 	dates = asLogical(CAR(args));
 	if (dates == NA_LOGICAL)
 	    error(_("invalid '%s' argument"), "copy.dates");
-	wcsncpy(dir,
-		filenameToWchar(STRING_ELT(to, 0), TRUE),
-		PATH_MAX);
+	p = filenameToWchar(STRING_ELT(to, 0), TRUE);
+	if (wcslen(p) >= PATH_MAX)
+	    error(_("'%s' path too long"), "to");
+	wcsncpy(dir, p, PATH_MAX);
 	dir[PATH_MAX - 1] = L'\0';
 	if (*(dir + (wcslen(dir) - 1)) !=  L'\\')
 	    wcsncat(dir, L"\\", PATH_MAX);
 	for (i = 0; i < nfiles; i++) {
 	    if (STRING_ELT(fn, i) != NA_STRING) {
-		wcsncpy(from,
-			filenameToWchar(STRING_ELT(fn, i), TRUE),
-			PATH_MAX);
+	    	p = filenameToWchar(STRING_ELT(fn, i), TRUE);
+	    	if (wcslen(p) >= PATH_MAX)
+	    	    error(_("'%s' path too long"), "from");
+		wcsncpy(from, p, PATH_MAX);
 		from[PATH_MAX - 1] = L'\0';
 		if(wcslen(from)) {
 		    /* If there was a trailing sep, this is a mistake */
diff -ubr R-3.3.2/src/main/printutils.c R-patched/src/main/printutils.c
--- R-3.3.2/src/main/printutils.c	2016-05-17 15:15:10.000000000 -0700
+++ R-patched/src/main/printutils.c	2016-11-03 16:15:06.000000000 -0700
@@ -668,7 +668,8 @@
 
 		    default:
 			/* print in octal */
-			snprintf(buf, 5, "\\%03o", k);
+			// gcc 7 requires cast here
+			snprintf(buf, 5, "\\%03o", (unsigned char)k);
 			for(j = 0; j < 4; j++) *q++ = buf[j];
 			break;
 		    }
diff -ubr R-3.3.2/src/main/seq.c R-patched/src/main/seq.c
--- R-3.3.2/src/main/seq.c	2016-03-16 16:04:16.000000000 -0700
+++ R-patched/src/main/seq.c	2016-11-01 16:15:07.000000000 -0700
@@ -1,7 +1,7 @@
 /*
  *  R : A Computer Language for Statistical Data Analysis
  *  Copyright (C) 1995-1998  Robert Gentleman and Ross Ihaka
- *  Copyright (C) 1998-2015  The R Core Team.
+ *  Copyright (C) 1998-2016  The R Core Team.
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -334,7 +334,7 @@
 	      type2char(TYPEOF(s)));
 
     nc = xlength(ncopy); // might be 0
-    if (nc == xlength(s))
+    if (nc != 1 && nc == xlength(s))
 	PROTECT(a = rep2(s, ncopy));
     else {
 	if (nc != 1) error(_("invalid '%s' value"), "times");
@@ -432,7 +432,8 @@
     return a;
 }
 
-/* rep(), allowing for both times and each */
+/* rep(), allowing for both times and each ;
+ * -----  nt == length(times) ;  if (nt == 1)  'times' is *not* accessed  */
 static SEXP rep4(SEXP x, SEXP times, R_xlen_t len, int each, R_xlen_t nt)
 {
     SEXP a;
@@ -580,7 +581,7 @@
 /* This is a primitive SPECIALSXP with internal argument matching */
 SEXP attribute_hidden do_rep(SEXP call, SEXP op, SEXP args, SEXP rho)
 {
-    SEXP ans, x, times = R_NilValue /* -Wall */;
+    SEXP ans, x, times = R_NilValue;
     int each = 1, nprotect = 3;
     R_xlen_t i, lx, len = NA_INTEGER, nt;
     static SEXP do_rep_formals = NULL;
@@ -651,18 +652,26 @@
 	nt = 1;
     } else {
 	R_xlen_t sum = 0;
-	if(CADR(args) == R_MissingArg) PROTECT(times = ScalarInteger(1));
-	else PROTECT(times = coerceVector(CADR(args), INTSXP));
-	nprotect++;
-	nt = XLENGTH(times);
-	if(nt != 1 && nt != lx * each)
-	    errorcall(call, _("invalid '%s' argument"), "times");
+	nt = CADR(args) == R_MissingArg ? 1 : XLENGTH(CADR(args));
 	if(nt == 1) {
-	    int it = INTEGER(times)[0];
+	    R_xlen_t it;
+	    if(CADR(args) == R_MissingArg) it = 1; else {
+#ifdef LONG_VECTOR_SUPPORT
+	    double rt = asReal(CADR(args));
+	    if (!R_FINITE(rt) || rt < 0)
+		errorcall(call, _("invalid '%s' argument"), "times");
+	    it = (R_xlen_t) rt;
+#else
+	    it = asInteger(CADR(args));
 	    if (it == NA_INTEGER || it < 0)
 		errorcall(call, _("invalid '%s' argument"), "times");
+#endif
+	    }
 	    len = lx * it * each;
-	} else {
+	} else { // nt != 1 -- only for this case 'times' is accessed, here and in rep4()
+	    if(nt != lx * each)
+		errorcall(call, _("invalid '%s' argument"), "times");
+	    PROTECT(times = coerceVector(CADR(args), INTSXP)); nprotect++;
 	    for(i = 0; i < nt; i++) {
 		int it = INTEGER(times)[i];
 		if (it == NA_INTEGER || it < 0)
diff -ubr R-3.3.2/src/main/sysutils.c R-patched/src/main/sysutils.c
--- R-3.3.2/src/main/sysutils.c	2016-03-16 16:04:17.000000000 -0700
+++ R-patched/src/main/sysutils.c	2016-11-03 16:15:06.000000000 -0700
@@ -882,7 +882,8 @@
 # ifndef Win32
 		if((unsigned int) wc < 65536) {
 # endif
-		    snprintf(outbuf, 9, "<U+%04X>", (unsigned int) wc);
+		// gcc 7 objects to this with unsigned int
+		    snprintf(outbuf, 9, "<U+%04X>", (unsigned short) wc);
 		    outbuf += 8; outb -= 8;
 # ifndef Win32
 		} else {
diff -ubr R-3.3.2/src/main/util.c R-patched/src/main/util.c
--- R-3.3.2/src/main/util.c	2016-09-14 15:15:31.000000000 -0700
+++ R-patched/src/main/util.c	2017-01-08 15:15:05.000000000 -0800
@@ -1679,7 +1679,16 @@
 	    for (n = 0; *p >= '0' && *p <= '9'; p++) n = (n < MAX_EXPONENT_PREFIX) ? n * 10 + (*p - '0') : n;
 	    if (ans != 0.0) { /* PR#15976:  allow big exponents on 0 */
 		expn += expsign * n;
-		if(exph > 0) expn -= exph;
+		if(exph > 0) {
+		    if (expn - exph < -122) {	/* PR#17199:  fac may overflow below if expn - exph is too small.  
+		                                   2^-122 is a bit bigger than 1E-37, so should be fine on all systems */
+		    	for (n = exph, fac = 1.0; n; n >>= 1, p2 *= p2)
+			    if (n & 1) fac *= p2;
+			ans /= fac;
+			p2 = 2.0;
+		    } else
+			expn -= exph;
+		}
 		if (expn < 0) {
 		    for (n = -expn, fac = 1.0; n; n >>= 1, p2 *= p2)
 			if (n & 1) fac *= p2;
diff -ubr R-3.3.2/src/modules/internet/internet.c R-patched/src/modules/internet/internet.c
--- R-3.3.2/src/modules/internet/internet.c	2016-07-30 15:15:06.000000000 -0700
+++ R-patched/src/modules/internet/internet.c	2017-02-14 15:15:13.000000000 -0800
@@ -32,6 +32,14 @@
 #include <errno.h>
 #include <R_ext/Print.h>
 
+
+/* note, ALL the possible structures have the first two elements */
+typedef struct {
+    DLsize_t length;
+    char *type;
+    void *ctxt;
+} inetconn;
+
 static void *in_R_HTTPOpen(const char *url, const char *headers, const int cacheOK);
 static int   in_R_HTTPRead(void *ctx, char *dest, int len);
 static void  in_R_HTTPClose(void *ctx);
@@ -135,6 +143,12 @@
 	  /* error("cannot open URL '%s'", url); */
 	    return FALSE;
 	}
+	DLsize_t len = ((inetconn *)ctxt)->length;
+	((Rurlconn)(con->private))->status = 0;
+	if (len == -999) { // https redirection
+	    ((Rurlconn)(con->private))->status = 2;
+	    return FALSE;
+	}
 	((Rurlconn)(con->private))->ctxt = ctxt;
     }
 	break;
@@ -410,13 +424,6 @@
     if(R_Consolefile) fflush(R_Consolefile);
 }
 
-/* note, ALL the possible structures have the first two elements */
-typedef struct {
-    DLsize_t length;
-    char *type;
-    void *ctxt;
-} inetconn;
-
 #ifdef Win32
 #include <ga.h>
 
@@ -564,6 +571,12 @@
 	else {
 //	    if(!quiet) REprintf(_("opened URL\n"), url);
 	    guess = total = ((inetconn *)ctxt)->length;
+
+	    if (total == -999) { // https redirection
+		fclose(out);
+		status = 2;
+		return ScalarInteger(status);
+	    }
 #ifdef Win32
 	    if(R_Interactive) {
 		if (guess <= 0) guess = 100 * 1024;
@@ -776,7 +789,9 @@
 
     RxmlNanoHTTPTimeout(timeout);
     ctxt = RxmlNanoHTTPOpen(url, NULL, headers, cacheOK);
-    if(ctxt != NULL) {
+    if (ctxt == NULL) return NULL;
+    len = RxmlNanoHTTPContentLength(ctxt);
+    if(len != -999) {
 	int rc = RxmlNanoHTTPReturnCode(ctxt);
 	if(rc != 200) {
 	    warning(_("cannot open URL '%s': HTTP status was '%d %s'"), 
@@ -803,7 +818,7 @@
 #endif
 	    }
 	}
-    } else return NULL;
+    }
     con = (inetconn *) malloc(sizeof(inetconn));
     if(con) {
 	con->length = len;
diff -ubr R-3.3.2/src/modules/internet/libcurl.c R-patched/src/modules/internet/libcurl.c
--- R-3.3.2/src/modules/internet/libcurl.c	2016-07-30 15:15:06.000000000 -0700
+++ R-patched/src/modules/internet/libcurl.c	2017-02-14 15:15:13.000000000 -0800
@@ -32,7 +32,7 @@
 #ifdef HAVE_LIBCURL
 # include <curl/curl.h>
 /*
-  This need libcurl >= 7.28.0 (Oct 2012) for curl_multi_wait.
+  This needs libcurl >= 7.28.0 (Oct 2012) for curl_multi_wait.
   There is a configure test but it is not used on Windows and system
   software can change.
 */
diff -ubr R-3.3.2/src/modules/internet/nanohttp.c R-patched/src/modules/internet/nanohttp.c
--- R-3.3.2/src/modules/internet/nanohttp.c	2016-03-16 16:04:24.000000000 -0700
+++ R-patched/src/modules/internet/nanohttp.c	2017-02-14 15:15:13.000000000 -0800
@@ -1,7 +1,7 @@
 /*
  *  R : A Computer Language for Statistical Data Analysis
  *  Copyright (C) 1998-2001  Daniel Veillard.
- *  Copyright (C) 2001-2015   The R Core Team.
+ *  Copyright (C) 2001-2017   The R Core Team.
  *
  *  This program is free software; you can redistribute it and/or modify
  *  it under the terms of the GNU General Public License as published by
@@ -1474,6 +1474,12 @@
 
     if ((ctxt->location != NULL) && (ctxt->returnValue >= 300) &&
         (ctxt->returnValue < 400)) {
+	if(strncmp(ctxt->location, "https://", 8) == 0) {
+	    RxmlMessage(2, _("\"internal\" method cannot handle https redirection to: '%s'"),
+			ctxt->location);
+	    ctxt->contentLength = -999;
+	    return((void *) ctxt);
+	} else
 	RxmlMessage(1, _("redirect to: '%s'"), ctxt->location);
 	while (RxmlNanoHTTPRecv(ctxt)) 
 	    ;  // clang likes this on a separate line
diff -ubr R-3.3.2/src/nmath/qbeta.c R-patched/src/nmath/qbeta.c
--- R-3.3.2/src/nmath/qbeta.c	2016-03-16 16:04:20.000000000 -0700
+++ R-patched/src/nmath/qbeta.c	2017-01-30 15:15:14.000000000 -0800
@@ -1,7 +1,7 @@
 /*
  *  R : A Computer Language for Statistical Data Analysis
+ *  Copyright (C) 1998--2017  The R Core Team
  *  Copyright (C) 1995, 1996  Robert Gentleman and Ross Ihaka
- *  Copyright (C) 1998--2015  The R Core Team
  *  based on code (C) 1979 and later Royal Statistical Society
  *
  *  This program is free software; you can redistribute it and/or modify
@@ -221,7 +221,7 @@
 
     R_ifDEBUG_printf(
 	"qbeta(%g, %g, %g, lower_t=%d, log_p=%d):%s\n"
-	"  swap_tail=%d, la=%g, u0=%g (bnd: %g (%g)) ",
+	"  swap_tail=%d, la=%#8g, u0=%#8g (bnd: %g (%g)) ",
 	alpha, p,q, lower_tail, log_p,
 	(log_p && (p_ == 0. || p_ == 1.)) ? (p_==0.?" p_=0":" p_=1") : "",
 	swap_tail, la, u0,
@@ -314,16 +314,17 @@
     // Problem: If initial u is completely wrong, we make a wrong decision here
     if(swap_choose &&
        (( swap_tail && u >= -exp(  log_q_cut)) || // ==> "swap back"
-	(!swap_tail && u >= -exp(4*log_q_cut) && pp / qq < 1000.))) { // ==> "swap now" (much less easily)
+	(!swap_tail && u >= -exp(4*log_q_cut) && pp / qq < 1000.) // ==> "swap now"
+	   )) {
 	// "revert swap" -- and use_log_x
 	swap_tail = !swap_tail;
 	R_ifDEBUG_printf(" u = %g (e^u = xinbta = %.16g) ==> ", u, xinbta);
-	if(swap_tail) {
+	if(swap_tail) { // "swap now" (much less easily)
 	    a = R_DT_CIv(alpha); // needed ?
 	    la = R_DT_Clog(alpha);
 	    pp = q; qq = p;
 	}
-	else {
+	else { // swap back :
 	    a = p_;
 	    la = R_DT_log(alpha);
 	    pp = p; qq = q;
@@ -337,32 +338,33 @@
 /* Careful: "swap now"  should not fail if
    1) the above initial xinbta is "completely wrong"
    2) The correction step can go outside (u_n > 0 ==>  e^u > 1 is illegal)
-   e.g., for
-	qbeta(0.2066, 0.143891, 0.05)
+   e.g., for  qbeta(0.2066, 0.143891, 0.05)
 */
-    }
+    } else R_ifDEBUG_printf("\n");
 
     if(!use_log_x)
-	use_log_x = (u < log_q_cut);//(per default) <==> xinbta = e^u < 4.54e-5
+	use_log_x = (u < log_q_cut);// <==> xinbta = e^u < exp(log_q_cut)
     Rboolean
 	bad_u = !R_FINITE(u),
 	bad_init = bad_u || xinbta > p_hi;
 
-    R_ifDEBUG_printf(" -> u = %g, e^u = xinbta = %.16g, (Newton acu=%g%s)\n",
-	     u, xinbta, acu,
-	     (bad_u ? ", ** bad u **" :
-	      (use_log_x ? ", on u = log(x) scale" : "")));
+    R_ifDEBUG_printf(" -> u = %g, e^u = xinbta = %.16g, (Newton acu=%g%s%s%s)\n",
+		     u, xinbta, acu, (bad_u ? ", ** bad u **" : ""),
+		     ((bad_init && !bad_u) ? ", ** bad_init **" : ""),
+		     (use_log_x ? ", on u = LOG(x) SCALE" : ""));
 
     double u_n = 1.; // -Wall
     tx = xinbta; // keeping "original initial x" (for now)
 
-    if(bad_u || u < log_q_cut) { /* e.g.
+    if(bad_u || u < log_q_cut) {
+	/* e.g.
 		    qbeta(0.21, .001, 0.05)
 		    try "left border" quickly, i.e.,
 		    try at smallest positive number: */
 	w = pbeta_raw(DBL_very_MIN, pp, qq, TRUE, log_p);
 	if(w > (log_p ? la : a)) {
-	    R_ifDEBUG_printf(" quantile is left of smallest positive number; \"convergence\"\n");
+	    R_ifDEBUG_printf(
+		" quantile is left of %g; \"convergence\"\n", DBL_very_MIN);
 	    if(log_p || fabs(w - a) < fabs(0 - a)) { // DBL_very_MIN is better than 0
 		tx   = DBL_very_MIN;
 		u_n  = DBL_log_v_MIN;// = log(DBL_very_MIN)
@@ -373,8 +375,8 @@
 	    use_log_x = log_p; add_N_step = FALSE; goto L_return;
 	}
 	else {
-	    R_ifDEBUG_printf(" pbeta(smallest pos.) = %g <= %g  --> continuing\n",
-		     w, (log_p ? la : a));
+	    R_ifDEBUG_printf(" pbeta(%g, *) = %g <= %g (= %s) --> continuing\n",
+			     DBL_log_v_MIN, w, (log_p ? la : a), (log_p ? "la" : "a"));
 	    if(u  < DBL_log_v_MIN) {
 		u = DBL_log_v_MIN;// = log(DBL_very_MIN)
 		xinbta = DBL_very_MIN;
@@ -415,7 +417,8 @@
 
 	for (i_pb=0; i_pb < 1000; i_pb++) {
 	    // using log_p == TRUE  unconditionally here
-	    // FIXME: if exp(u) = xinbta underflows to 0, like different formula pbeta_log(u, *)
+	    /* FIXME: if exp(u) = xinbta underflows to 0,
+	     *  want different formula pbeta_log(u, ..) */
 	    y = pbeta_raw(xinbta, pp, qq, /*lower_tail = */ TRUE, TRUE);
 
 	    /* w := Newton step size for   L(u) = log F(e^u)  =!= 0;   u := log(x)
@@ -423,7 +426,7 @@
 	     *   =  (L(.) - la)*F(.) / {F'(e^u) * e^u } =
 	     *   =  (L(.) - la) * e^L(.) * e^{-log F'(e^u) - u}
 	     *   =  ( y   - la) * e^{ y - u -log F'(e^u)}
-		and  -log F'(x)= -log f(x) =  + logbeta + (1-p) log(x) + (1-q) log(1-x)
+	     and  -log F'(x)= -log f(x) = - -logbeta + (1-p) log(x) + (1-q) log(1-x)
 			       = logbeta + (1-p) u + (1-q) log(1-e^u)
 	     */
 	    w = (y == ML_NEGINF) // y = -Inf  well possible: we are on log scale!
@@ -432,19 +435,20 @@
 		break;
 	    if (i_pb >= n_N && w * wprev <= 0.)
 		prev = fmax2(fabs(adj),fpu);
-	    R_ifDEBUG_printf("N(i=%2d): u=%#20.16g, pb(e^u)=%#12.6g, w=%#15.9g, %s prev=%11g,",
-			     i_pb, u, y, w, (w * wprev <= 0.) ? "new" : "old", prev);
+	    R_ifDEBUG_printf(
+		"N(i=%2d): u=%#20.16g, pb(e^u)=%#15.9g, w=%#15.9g, %s prev=%g,",
+		i_pb, u, y, w,
+		(i_pb >= n_N && w * wprev <= 0.) ? "new" : "old", prev);
 	    g = 1;
 	    for (i_inn=0; i_inn < 1000; i_inn++) {
 		adj = g * w;
-		// take full Newton steps at the beginning; only then safe guard:
-		if (i_pb < n_N || fabs(adj) < prev) {
+		// safe guard (here, from the very beginning)
+		if (fabs(adj) < prev) {
 		    u_n = u - adj; // u_{n+1} = u_n - g*w
 		    if (u_n <= 0.) { // <==> 0 <  xinbta := e^u  <= 1
 			if (prev <= acu || fabs(w) <= acu) {
-			    /* R_ifDEBUG_printf(" -adj=%g, %s <= acu  ==> convergence\n", */
-			    /*	 -adj, (prev <= acu) ? "prev" : "|w|"); */
-			    R_ifDEBUG_printf(" it{in}=%d, -adj=%g, %s <= acu  ==> convergence\n",
+		 	    R_ifDEBUG_printf(
+				" it{in}=%d, -adj=%g, %s <= acu  ==> convergence\n",
 					     i_inn, -adj, (prev <= acu) ? "prev" : "|w|");
 			    goto L_converged;
 			}
@@ -466,7 +470,7 @@
 	    wprev = w;
 	} // for(i )
 
-    } else
+    } else { // "normal scale" Newton
 
     for (i_pb=0; i_pb < 1000; i_pb++) {
 	y = pbeta_raw(xinbta, pp, qq, /*lower_tail = */ TRUE, log_p);
@@ -490,8 +494,10 @@
 	    : (y - a)  * exp(    logbeta + r * log(xinbta) + t * log1p(-xinbta));
 	if (i_pb >= n_N && w * wprev <= 0.)
 	    prev = fmax2(fabs(adj),fpu);
-	R_ifDEBUG_printf("N(i=%2d): x0=%#17.15g, pb(x0)=%#17.15g, w=%#17.15g, %s prev=%g,",
-			 i_pb, xinbta, y, w, (w * wprev <= 0.) ? "new" : "old", prev);
+	    R_ifDEBUG_printf(
+		"N(i=%2d): x0=%#17.15g, pb(x0)=%#15.9g, w=%#15.9g, %s prev=%g,",
+		i_pb, xinbta, y, w,
+		(i_pb >= n_N && w * wprev <= 0.) ? "new" : "old", prev);
 	g = 1;
 	for (i_inn=0; i_inn < 1000;i_inn++) {
 	    adj = g * w;
@@ -517,7 +523,9 @@
 	if(tx == 0) // "we have lost"
 	    break;
 	wprev = w;
-    }
+	} // for( i_pb ..)
+
+    } // end{else : normal scale Newton}
 
     /*-- NOT converged: Iteration count --*/
     warned = TRUE;
@@ -569,8 +577,9 @@
 		    ? (y - la) * exp(y + logbeta + r * log(xinbta) + t * log1p(-xinbta))
 		    : (y - a)  * exp(    logbeta + r * log(xinbta) + t * log1p(-xinbta));
 		tx = xinbta - w;
-		R_ifDEBUG_printf(
-		    "Final Newton correction(non-log scale): xinbta=%.16g, y=%g, w=%g. => new tx=%.16g\n",
+		R_ifDEBUG_printf(" Final Newton correction(non-log scale):\n"
+								   //   \n  xinbta=%.16g
+				 "  xinbta=%.16g, y=%g, w=-Delta(x)=%g. \n=> new x=%.16g\n",
 		    xinbta, y, w, tx);
 	    } else {
 		if(swap_tail) {
diff -ubr R-3.3.2/tests/Examples/datasets-Ex.Rout.save R-patched/tests/Examples/datasets-Ex.Rout.save
--- R-3.3.2/tests/Examples/datasets-Ex.Rout.save	2016-10-27 15:15:07.000000000 -0700
+++ R-patched/tests/Examples/datasets-Ex.Rout.save	2017-02-14 15:15:15.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
@@ -2747,6 +2747,13 @@
 > dotchart(precip[order(precip)], main = "precip data")
 > title(sub = "Average annual precipitation (in.)")
 > 
+> ## Old ("wrong") version of dataset (just name change):
+> precip.O <- local({
++    p <- precip; names(p)[names(p) == "Cincinnati"] <- "Cincinati" ; p })
+> stopifnot(all(precip == precip.O),
++ 	  match("Cincinnati", names(precip)) == 46,
++ 	  identical(names(precip)[-46], names(precip.O)[-46]))
+> 
 > 
 > 
 > cleanEx()
@@ -3458,7 +3465,7 @@
 > ###
 > options(digits = 7L)
 > base::cat("Time elapsed: ", proc.time() - base::get("ptime", pos = 'CheckExEnv'),"\n")
-Time elapsed:  1.265 0.016 1.282 0 0 
+Time elapsed:  1.267 0.026 1.297 0 0 
 > grDevices::dev.off()
 null device 
           1 
diff -ubr R-3.3.2/tests/Examples/grDevices-Ex.Rout.save R-patched/tests/Examples/grDevices-Ex.Rout.save
--- R-3.3.2/tests/Examples/grDevices-Ex.Rout.save	2016-10-27 15:15:07.000000000 -0700
+++ R-patched/tests/Examples/grDevices-Ex.Rout.save	2017-02-14 15:15:15.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
@@ -3766,7 +3766,7 @@
 > ###
 > options(digits = 7L)
 > base::cat("Time elapsed: ", proc.time() - base::get("ptime", pos = 'CheckExEnv'),"\n")
-Time elapsed:  7.569 0.134 7.704 0 0 
+Time elapsed:  7.562 0.117 7.696 0 0 
 > grDevices::dev.off()
 null device 
           1 
diff -ubr R-3.3.2/tests/Examples/graphics-Ex.Rout.save R-patched/tests/Examples/graphics-Ex.Rout.save
--- R-3.3.2/tests/Examples/graphics-Ex.Rout.save	2016-10-27 15:15:07.000000000 -0700
+++ R-patched/tests/Examples/graphics-Ex.Rout.save	2017-02-14 15:15:15.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
@@ -392,14 +392,14 @@
 > ## boxplot on a matrix:
 > mat <- cbind(Uni05 = (1:100)/21, Norm = rnorm(100),
 +              `5T` = rt(100, df = 5), Gam2 = rgamma(100, shape = 2))
-> boxplot(as.data.frame(mat),
-+         main = "boxplot(as.data.frame(mat), main = ...)")
+> boxplot(mat) # directly, calling boxplot.matrix()
+> 
+> ## boxplot on a data frame:
+> df. <- as.data.frame(mat)
 > par(las = 1) # all axis labels horizontal
-> boxplot(as.data.frame(mat), main = "boxplot(*, horizontal = TRUE)",
-+         horizontal = TRUE)
+> boxplot(df., main = "boxplot(*, horizontal = TRUE)", horizontal = TRUE)
 > 
 > ## Using 'at = ' and adding boxplots -- example idea by Roger Bivand :
-> 
 > boxplot(len ~ dose, data = ToothGrowth,
 +         boxwex = 0.25, at = 1:3 - 0.2,
 +         subset = supp == "VC", col = "yellow",
@@ -2066,7 +2066,7 @@
 > points.default # to see how it calls "plot.xy(xy.coords(x, y), ...)"
 function (x, y = NULL, type = "p", ...) 
 plot.xy(xy.coords(x, y), type = type, ...)
-<bytecode: 0x1aafa88>
+<bytecode: 0x32014f0>
 <environment: namespace:graphics>
 > 
 > 
@@ -2936,7 +2936,7 @@
     u <- par("usr")
     xy * c(u[2L] - u[1L], u[4L] - u[3L])/par("pin")
 }
-<bytecode: 0x2f7cbe8>
+<bytecode: 0x38d6a50>
 <environment: namespace:graphics>
 > 
 > ## plot labels offset 0.12 inches to the right
@@ -3016,7 +3016,7 @@
 > ###
 > options(digits = 7L)
 > base::cat("Time elapsed: ", proc.time() - base::get("ptime", pos = 'CheckExEnv'),"\n")
-Time elapsed:  1.793 0.029 1.823 0 0 
+Time elapsed:  1.828 0.032 1.866 0 0 
 > grDevices::dev.off()
 null device 
           1 
diff -ubr R-3.3.2/tests/Examples/grid-Ex.Rout.save R-patched/tests/Examples/grid-Ex.Rout.save
--- R-3.3.2/tests/Examples/grid-Ex.Rout.save	2016-10-27 15:15:07.000000000 -0700
+++ R-patched/tests/Examples/grid-Ex.Rout.save	2017-02-14 15:15:15.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
@@ -2069,7 +2069,7 @@
 > ###
 > options(digits = 7L)
 > base::cat("Time elapsed: ", proc.time() - base::get("ptime", pos = 'CheckExEnv'),"\n")
-Time elapsed:  1.09 0.009 1.099 0 0 
+Time elapsed:  1.071 0.01 1.085 0 0 
 > grDevices::dev.off()
 null device 
           1 
diff -ubr R-3.3.2/tests/Examples/splines-Ex.Rout.save R-patched/tests/Examples/splines-Ex.Rout.save
--- R-3.3.2/tests/Examples/splines-Ex.Rout.save	2016-10-27 15:15:07.000000000 -0700
+++ R-patched/tests/Examples/splines-Ex.Rout.save	2017-02-14 15:15:15.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
@@ -582,7 +582,7 @@
 > ###
 > options(digits = 7L)
 > base::cat("Time elapsed: ", proc.time() - base::get("ptime", pos = 'CheckExEnv'),"\n")
-Time elapsed:  0.102 0.003 0.106 0 0 
+Time elapsed:  0.102 0.006 0.109 0 0 
 > grDevices::dev.off()
 null device 
           1 
diff -ubr R-3.3.2/tests/Examples/stats-Ex.Rout.save R-patched/tests/Examples/stats-Ex.Rout.save
--- R-3.3.2/tests/Examples/stats-Ex.Rout.save	2016-10-27 15:15:07.000000000 -0700
+++ R-patched/tests/Examples/stats-Ex.Rout.save	2017-02-14 15:15:15.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
@@ -3792,7 +3792,7 @@
 > 
 > asOneSidedFormula("age")
 ~age
-<environment: 0x3fcf138>
+<environment: 0x3fd8ff8>
 > asOneSidedFormula(~ age)
 ~age
 > 
@@ -4755,7 +4755,7 @@
     r[cbind(1L:p, 1L:p)] <- 1
     r
 }
-<bytecode: 0x5197148>
+<bytecode: 0x51f6590>
 <environment: namespace:stats>
 > stopifnot(all.equal(Cl, cov2cor(cov(longley))),
 +           all.equal(cor(longley, method = "kendall"),
@@ -7285,7 +7285,7 @@
 > environment(as.formula("y ~ x"))
 <environment: R_GlobalEnv>
 > environment(as.formula("y ~ x", env = new.env()))
-<environment: 0x401c9e0>
+<environment: 0x4030b60>
 > 
 > 
 > ## Create a formula for a model with a large number of variables:
@@ -11766,14 +11766,14 @@
 $linkfun
 function (mu) 
 mu^lambda
-<bytecode: 0x798f7d0>
-<environment: 0x79a9258>
+<bytecode: 0x797a048>
+<environment: 0x7983820>
 
 $linkinv
 function (eta) 
 pmax(eta^(1/lambda), .Machine$double.eps)
-<bytecode: 0x798f6b8>
-<environment: 0x79a9258>
+<bytecode: 0x797ae98>
+<environment: 0x7983820>
 
 > 
 > 
@@ -15771,8 +15771,8 @@
 > unclass(sfun0)
 function (v) 
 .approxfun(x, y, v, method, yleft, yright, f)
-<bytecode: 0x3b158f8>
-<environment: 0x4bbc468>
+<bytecode: 0x3b218b8>
+<environment: 0x44d5330>
 attr(,"call")
 stepfun(1:3, y0, f = 0)
 > ls(envir = environment(sfun0))
@@ -18049,7 +18049,7 @@
 > ###
 > options(digits = 7L)
 > base::cat("Time elapsed: ", proc.time() - base::get("ptime", pos = 'CheckExEnv'),"\n")
-Time elapsed:  4.499 0.098 4.597 0 0 
+Time elapsed:  4.508 0.092 4.614 0 0 
 > grDevices::dev.off()
 null device 
           1 
diff -ubr R-3.3.2/tests/Examples/stats4-Ex.Rout.save R-patched/tests/Examples/stats4-Ex.Rout.save
--- R-3.3.2/tests/Examples/stats4-Ex.Rout.save	2016-10-27 15:15:07.000000000 -0700
+++ R-patched/tests/Examples/stats4-Ex.Rout.save	2017-02-14 15:15:15.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
@@ -184,7 +184,7 @@
 > ###
 > options(digits = 7L)
 > base::cat("Time elapsed: ", proc.time() - base::get("ptime", pos = 'CheckExEnv'),"\n")
-Time elapsed:  0.293 0.003 0.296 0 0 
+Time elapsed:  0.282 0.002 0.286 0 0 
 > grDevices::dev.off()
 null device 
           1 
diff -ubr R-3.3.2/tests/Examples/tools-Ex.Rout.save R-patched/tests/Examples/tools-Ex.Rout.save
--- R-3.3.2/tests/Examples/tools-Ex.Rout.save	2016-10-27 15:15:07.000000000 -0700
+++ R-patched/tests/Examples/tools-Ex.Rout.save	2017-02-14 15:15:15.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
@@ -188,7 +188,7 @@
 > bibstyle("unsorted", sortKeys = function(refs) seq_along(refs),
 +     fmtPrefix = function(paper) paste0("[", paper$.index, "]"),
 +        .init = TRUE)
-<environment: 0x2fe6fd0>
+<environment: 0x33a0d50>
 > print(refs, .bibstyle = "unsorted")
 [1] R Core Team (2013). _R: A Language and Environment for Statistical
 Computing_. R Foundation for Statistical Computing, Vienna, Austria.
@@ -1015,7 +1015,7 @@
 > ###
 > options(digits = 7L)
 > base::cat("Time elapsed: ", proc.time() - base::get("ptime", pos = 'CheckExEnv'),"\n")
-Time elapsed:  0.192 0.003 0.195 0 0 
+Time elapsed:  0.189 0.006 0.195 0 0 
 > grDevices::dev.off()
 null device 
           1 
diff -ubr R-3.3.2/tests/R-intro.Rout.save R-patched/tests/R-intro.Rout.save
--- R-3.3.2/tests/R-intro.Rout.save	2016-10-27 15:15:09.000000000 -0700
+++ R-patched/tests/R-intro.Rout.save	2017-02-14 15:15:22.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
@@ -295,8 +295,7 @@
 > 
 > d <- outer(0:9, 0:9)
 > fr <- table(outer(d, d, "-"))
-> plot(as.numeric(names(fr)), fr, type="h",
-+      xlab="Determinant", ylab="Frequency")
+> plot(fr, xlab="Determinant", ylab="Frequency")
 > 
 > ##
 > 
diff -ubr R-3.3.2/tests/any-all.Rout.save R-patched/tests/any-all.Rout.save
--- R-3.3.2/tests/any-all.Rout.save	2016-10-27 15:15:09.000000000 -0700
+++ R-patched/tests/any-all.Rout.save	2017-02-14 15:15:23.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
diff -ubr R-3.3.2/tests/arith-true.Rout.save R-patched/tests/arith-true.Rout.save
--- R-3.3.2/tests/arith-true.Rout.save	2016-10-27 15:15:09.000000000 -0700
+++ R-patched/tests/arith-true.Rout.save	2017-02-14 15:15:23.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
@@ -323,5 +323,5 @@
 > 
 > ## Last Line:
 > cat('Time elapsed: ', proc.time() - .proctime00,'\n')
-Time elapsed:  0.194 0.002 0.196 0 0 
+Time elapsed:  0.133 0.002 0.136 0 0 
 > 
diff -ubr R-3.3.2/tests/arith.Rout.save R-patched/tests/arith.Rout.save
--- R-3.3.2/tests/arith.Rout.save	2016-10-27 15:15:09.000000000 -0700
+++ R-patched/tests/arith.Rout.save	2017-02-14 15:15:23.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
diff -ubr R-3.3.2/tests/complex.Rout.save R-patched/tests/complex.Rout.save
--- R-3.3.2/tests/complex.Rout.save	2016-10-27 15:15:09.000000000 -0700
+++ R-patched/tests/complex.Rout.save	2017-02-14 15:15:23.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
diff -ubr R-3.3.2/tests/d-p-q-r-tests.Rout.save R-patched/tests/d-p-q-r-tests.Rout.save
--- R-3.3.2/tests/d-p-q-r-tests.Rout.save	2016-10-27 15:15:09.000000000 -0700
+++ R-patched/tests/d-p-q-r-tests.Rout.save	2017-02-14 15:15:23.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
@@ -1388,5 +1388,5 @@
 > 
 > 
 > cat("Time elapsed: ", proc.time() - .ptime,"\n")
-Time elapsed:  1.152 0.007 1.159 0 0 
+Time elapsed:  1.096 0.005 1.103 0 0 
 > 
diff -ubr R-3.3.2/tests/datasets.Rout.save R-patched/tests/datasets.Rout.save
--- R-3.3.2/tests/datasets.Rout.save	2016-10-27 15:15:09.000000000 -0700
+++ R-patched/tests/datasets.Rout.save	2017-02-14 15:15:23.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
diff -ubr R-3.3.2/tests/datetime.Rout.save R-patched/tests/datetime.Rout.save
--- R-3.3.2/tests/datetime.Rout.save	2016-10-27 15:15:09.000000000 -0700
+++ R-patched/tests/datetime.Rout.save	2017-02-14 15:15:23.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
diff -ubr R-3.3.2/tests/datetime2.Rout.save R-patched/tests/datetime2.Rout.save
--- R-3.3.2/tests/datetime2.Rout.save	2016-10-27 15:15:10.000000000 -0700
+++ R-patched/tests/datetime2.Rout.save	2017-02-14 15:15:23.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
diff -ubr R-3.3.2/tests/demos.Rout.save R-patched/tests/demos.Rout.save
--- R-3.3.2/tests/demos.Rout.save	2016-10-27 15:15:10.000000000 -0700
+++ R-patched/tests/demos.Rout.save	2017-02-14 15:15:23.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
@@ -1510,5 +1510,5 @@
 > par(op)
 > 
 > cat("Time elapsed: ", proc.time() - .ptime, "\n")
-Time elapsed:  1.026 0.02 1.045 0 0 
+Time elapsed:  0.96 0.024 0.986 0 0 
 > 
diff -ubr R-3.3.2/tests/eval-etc.Rout.save R-patched/tests/eval-etc.Rout.save
--- R-3.3.2/tests/eval-etc.Rout.save	2016-10-27 15:15:10.000000000 -0700
+++ R-patched/tests/eval-etc.Rout.save	2017-02-14 15:15:23.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
diff -ubr R-3.3.2/tests/iec60559.Rout.save R-patched/tests/iec60559.Rout.save
--- R-3.3.2/tests/iec60559.Rout.save	2016-10-27 15:15:10.000000000 -0700
+++ R-patched/tests/iec60559.Rout.save	2017-02-14 15:15:24.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
diff -ubr R-3.3.2/tests/internet.Rout.save R-patched/tests/internet.Rout.save
--- R-3.3.2/tests/internet.Rout.save	2016-10-27 15:15:10.000000000 -0700
+++ R-patched/tests/internet.Rout.save	2017-02-14 15:15:24.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
@@ -23,7 +23,7 @@
 > 
 > # test do_download.
 > nrow(available.packages(contrib.url("http://cran.r-project.org")))
-[1] 9391
+[1] 10075
 > 
 > # test url connections on http
 > zz <- url("http://cran.r-project.org/")
diff -ubr R-3.3.2/tests/isas-tests.Rout.save R-patched/tests/isas-tests.Rout.save
--- R-3.3.2/tests/isas-tests.Rout.save	2016-10-27 15:15:10.000000000 -0700
+++ R-patched/tests/isas-tests.Rout.save	2017-02-14 15:15:24.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
@@ -2568,6 +2568,6 @@
 > f <- try(as.ts( x ), silent = TRUE)
 >   if(!inherits(f, 'try-error')) report(identical(f, as.ts( f )))
 > cat('Time elapsed: ', proc.time() - .proctime00,'\n')
-Time elapsed:  0.142 0.008 0.15 0 0 
+Time elapsed:  0.135 0.013 0.149 0 0 
 > 
 > 
diff -ubr R-3.3.2/tests/lapack.Rout.save R-patched/tests/lapack.Rout.save
--- R-3.3.2/tests/lapack.Rout.save	2016-10-27 15:15:10.000000000 -0700
+++ R-patched/tests/lapack.Rout.save	2017-02-14 15:15:24.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
diff -ubr R-3.3.2/tests/lm-tests.Rout.save R-patched/tests/lm-tests.Rout.save
--- R-3.3.2/tests/lm-tests.Rout.save	2016-10-27 15:15:10.000000000 -0700
+++ R-patched/tests/lm-tests.Rout.save	2017-02-14 15:15:24.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
diff -ubr R-3.3.2/tests/method-dispatch.Rout.save R-patched/tests/method-dispatch.Rout.save
--- R-3.3.2/tests/method-dispatch.Rout.save	2016-10-27 15:15:10.000000000 -0700
+++ R-patched/tests/method-dispatch.Rout.save	2017-02-14 15:15:24.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
diff -ubr R-3.3.2/tests/ok-errors.Rout.save R-patched/tests/ok-errors.Rout.save
--- R-3.3.2/tests/ok-errors.Rout.save	2016-10-27 15:15:10.000000000 -0700
+++ R-patched/tests/ok-errors.Rout.save	2017-02-14 15:15:24.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
diff -ubr R-3.3.2/tests/p-r-random-tests.Rout.save R-patched/tests/p-r-random-tests.Rout.save
--- R-3.3.2/tests/p-r-random-tests.Rout.save	2016-10-27 15:15:10.000000000 -0700
+++ R-patched/tests/p-r-random-tests.Rout.save	2017-02-14 15:15:24.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
@@ -278,6 +278,6 @@
 > 
 > 
 > cat('Time elapsed: ', proc.time() - .proctime00,'\n')
-Time elapsed:  1.316 0.004 1.319 0 0 
+Time elapsed:  1.294 0.001 1.297 0 0 
 > 
 > 
diff -ubr R-3.3.2/tests/print-tests.Rout.save R-patched/tests/print-tests.Rout.save
--- R-3.3.2/tests/print-tests.Rout.save	2016-10-27 15:15:10.000000000 -0700
+++ R-patched/tests/print-tests.Rout.save	2017-02-14 15:15:24.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
diff -ubr R-3.3.2/tests/reg-IO.Rout.save R-patched/tests/reg-IO.Rout.save
--- R-3.3.2/tests/reg-IO.Rout.save	2016-10-27 15:15:10.000000000 -0700
+++ R-patched/tests/reg-IO.Rout.save	2017-02-14 15:15:24.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
diff -ubr R-3.3.2/tests/reg-IO2.Rout.save R-patched/tests/reg-IO2.Rout.save
--- R-3.3.2/tests/reg-IO2.Rout.save	2016-10-27 15:15:10.000000000 -0700
+++ R-patched/tests/reg-IO2.Rout.save	2017-02-14 15:15:24.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
diff -ubr R-3.3.2/tests/reg-S4.Rout.save R-patched/tests/reg-S4.Rout.save
--- R-3.3.2/tests/reg-S4.Rout.save	2016-10-27 15:15:10.000000000 -0700
+++ R-patched/tests/reg-S4.Rout.save	2017-02-14 15:15:24.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
diff -ubr R-3.3.2/tests/reg-examples3.Rout.save R-patched/tests/reg-examples3.Rout.save
--- R-3.3.2/tests/reg-examples3.Rout.save	2016-10-27 15:15:10.000000000 -0700
+++ R-patched/tests/reg-examples3.Rout.save	2017-02-14 15:15:24.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
diff -ubr R-3.3.2/tests/reg-plot.Rout.save R-patched/tests/reg-plot.Rout.save
--- R-3.3.2/tests/reg-plot.Rout.save	2016-10-27 15:15:10.000000000 -0700
+++ R-patched/tests/reg-plot.Rout.save	2017-02-14 15:15:24.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
diff -ubr R-3.3.2/tests/reg-tests-1c.R R-patched/tests/reg-tests-1c.R
--- R-3.3.2/tests/reg-tests-1c.R	2016-05-26 15:15:05.000000000 -0700
+++ R-patched/tests/reg-tests-1c.R	2016-12-14 15:15:07.000000000 -0800
@@ -1,4 +1,4 @@
-## Regression tests for R >= 3.0.0
+## Regression tests for R 3.[123].*
 
 pdf("reg-tests-1c.pdf", encoding = "ISOLatin1.enc")
 
@@ -181,7 +181,7 @@
 dbeta(0.1, 9.9e307, 10)
 ## first two hung in R <= 3.0.2
 
-## PR#15465
+## PR#15465 (0-extent matrix / data frame)
 provideDimnames(matrix(nrow = 0, ncol = 1))
 provideDimnames(table(character()))
 as.data.frame(table(character()))
@@ -1445,7 +1445,7 @@
     identical(chkPretty(MTbd +  0:1), p1) ,
     identical(chkPretty(MTbd + -1:1), p1) ,
     identical(chkPretty(MTbd +  0:3), seqDp("1960-02-09", "1960-02-14")) )
-## all pretty() above gave length >= 5 answer (with duplicated values!) in R <= 3.2.3
+## all pretty() above gave length >= 5 answer (with duplicated values!) in R <= 3.2.3!
 ## and length 1 or 2 instead of about 6 in R 3.2.4
 (p2 <- chkPretty(as.POSIXct("2002-02-02 02:02", tz = "GMT-1"), n = 5, min.n = 5))
 stopifnot(length(p2) >= 5+1,
@@ -1583,7 +1583,7 @@
 ## kept "mts" in 3.2.4, PR#16769
 
 
-## match(x, t): fast algorithm for length-1 'x'
+## match(x, t): fast algorithm for length-1 'x' -- PR#16885
 ## a) string 'x'  when only encoding differs
 tmp <- "ๅนดไป"
 tmp2 <- "\u5e74\u4ed8" ; Encoding(tmp2) <- "UTF-8"
diff -ubr R-3.3.2/tests/reg-tests-2.Rout.save R-patched/tests/reg-tests-2.Rout.save
--- R-3.3.2/tests/reg-tests-2.Rout.save	2016-10-27 15:15:10.000000000 -0700
+++ R-patched/tests/reg-tests-2.Rout.save	2017-02-14 15:15:24.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
@@ -6405,15 +6405,15 @@
 > print.function
 function (x, ...)  
  - attr(*, "srcref")=Class 'srcref'  atomic [1:8] 1 19 1 63 19 63 1 1
-  .. ..- attr(*, "srcfile")=Classes 'srcfilecopy', 'srcfile' <environment: 0x30f57d8> 
+  .. ..- attr(*, "srcfile")=Classes 'srcfilecopy', 'srcfile' <environment: 0x317fe30> 
 > f
 function ()  
  - attr(*, "srcref")=Class 'srcref'  atomic [1:8] 1 17 1 28 17 28 1 1
-  .. ..- attr(*, "srcfile")=Classes 'srcfilecopy', 'srcfile' <environment: 0x30e9818> 
+  .. ..- attr(*, "srcfile")=Classes 'srcfilecopy', 'srcfile' <environment: 0x3176e00> 
  - attr(*, "note")= chr "just a note"
  - attr(*, "yada")=function ()  
   ..- attr(*, "srcref")=Class 'srcref'  atomic [1:8] 2 24 2 48 24 48 2 2
-  .. .. ..- attr(*, "srcfile")=Classes 'srcfilecopy', 'srcfile' <environment: 0x30e9818> 
+  .. .. ..- attr(*, "srcfile")=Classes 'srcfilecopy', 'srcfile' <environment: 0x3176e00> 
 > rm(print.function)
 > ## auto-printing and printing differed up to R 2.9.x
 > 
diff -ubr R-3.3.2/tests/reg-tests-3.Rout.save R-patched/tests/reg-tests-3.Rout.save
--- R-3.3.2/tests/reg-tests-3.Rout.save	2016-10-27 15:15:10.000000000 -0700
+++ R-patched/tests/reg-tests-3.Rout.save	2017-02-14 15:15:24.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
diff -ubr R-3.3.2/tests/simple-true.Rout.save R-patched/tests/simple-true.Rout.save
--- R-3.3.2/tests/simple-true.Rout.save	2016-10-27 15:15:10.000000000 -0700
+++ R-patched/tests/simple-true.Rout.save	2017-02-14 15:15:24.000000000 -0800
@@ -1,6 +1,6 @@
 
-R version 3.3.2 RC (2016-10-26 r71594) -- "Sincere Pumpkin Patch"
-Copyright (C) 2016 The R Foundation for Statistical Computing
+R version 3.3.2 Patched (2017-02-14 r72171) -- "Sincere Pumpkin Patch"
+Copyright (C) 2017 The R Foundation for Statistical Computing
 Platform: x86_64-pc-linux-gnu (64-bit)
 
 R is free software and comes with ABSOLUTELY NO WARRANTY.
